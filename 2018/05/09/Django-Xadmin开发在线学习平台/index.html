<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Django+Xadmin开发在线学习平台 | Flyme</title>
  <meta name="author" content="西伯利亚狼">
  
  <meta name="description" content="奋斗小青年的逆袭之路一直进行中">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Django+Xadmin开发在线学习平台"/>
  <meta property="og:site_name" content="Flyme"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="Flyme" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 5.0.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Flyme</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> Django+Xadmin开发在线学习平台</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h1 id="项目演示及介绍"><a href="#项目演示及介绍" class="headerlink" title="项目演示及介绍"></a><center>项目演示及介绍</center></h1><p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/1570013953137.png" alt="1570013953137"></p>
<a id="more"></a>

<blockquote>
<p>项目实战：Django+xadmin搭建在线学习平台</p>
<br>

<p>系统演示地址：<a target="_blank" rel="noopener" href="http://www.poket.top/">www.poket.top</a>  (不过最近访问不了，因为还在备案中)</p>
<br>

<p>GitHub代码仓库: </p>
<p><a target="_blank" rel="noopener" href="https://github.com/wlk-flyme/StudyOnline">https://github.com/wlk-flyme/StudyOnline</a></p>
</blockquote>
<br>

<h2 id="系统总体介绍"><a href="#系统总体介绍" class="headerlink" title="系统总体介绍"></a><strong>系统总体介绍</strong></h2><br>

<ol>
<li><p>系统具有完整的用户登录、注册、修改密码、找回密码、重新绑定注册邮箱等功能，拥有完整的个人中心。</p>
</li>
<li><p>导航栏：<code>公开课</code>、<code>授课老师</code>、<code>授课机构</code>、<code>全局搜索</code> 。</p>
</li>
<li><p>个人中心：<code>修改头像</code>、<code>修改密码</code>、<code>修改邮箱</code>，查看我收藏的课程、授课老师、授课机构，这些收藏还可以删除，以及我学习过的课程记录。</p>
</li>
<li><p>点击<code>公开课</code>-&gt;课程列表，可以根据<code>最新</code>、<code>最热门</code>与<code>参与人数</code>来进行排序-搜索；<code>热门课程推荐</code>，课程的分页。</p>
</li>
<li><p>点击<code>课程</code>-&gt;课程详情页（公开课的基本信息），对课程进行收藏，取消收藏，富文本展示课程内容。</p>
</li>
<li><p>点击<code>开始学习</code>-&gt;公开课的<code>章节信息</code>、<code>评论信息</code>以及<code>课程资源的下载</code>。</p>
</li>
<li><p>点击<code>授课教师</code>-&gt;教师列表，可以根据人气进行讲师排名展示以及分页，页面右侧栏有讲师排行榜。</p>
</li>
<li><p>点击<code>讲师的详情页面</code>–&gt; 对讲师进行收藏和分享，以及讲师的全部课程。 </p>
</li>
<li><p>点击<code>授课机构</code>-&gt;进入授课机构首页，top栏有<code>机构类别和</code>与<code>所在地区</code>，可以进行筛选，页面右侧栏有<code>我要学习</code>表单和<code>机构排行榜</code>，中间容器展示机构，并且可以根据<code>学习人数</code>与<code>课程数</code>来进行排序。</p>
</li>
<li><p>点击<code>机构</code>–&gt; 左侧：<code>机构首页</code>,<code>机构课程</code>，<code>机构介绍</code>，<code>机构讲师</code> 四个小功能模块。</p>
</li>
<li><p>后台管理系统可以自由切换<code>主题</code>,左侧栏每一个模块都有列表显示, 增删改查，筛选功能。 </p>
</li>
<li><p>课程列表页可以对不同字段进行排序，选择多条记录进行删除操作。</p>
</li>
<li><p>课程新增页面上传图片，富文本的编辑。时间选择，添加章节，添加课程资源。 </p>
</li>
<li><p>日志记录：记录后台人员的操作 </p>
<br>

<h2 id="开发环境搭建任务"><a href="#开发环境搭建任务" class="headerlink" title="开发环境搭建任务"></a>开发环境搭建任务</h2><p>windows下通过<code>pycharm</code>和<code>virtualenv</code>搭建开发环境</p>
 <br>

<h2 id="数据库设计和xadmin搭建后台管理系统任务"><a href="#数据库设计和xadmin搭建后台管理系统任务" class="headerlink" title="数据库设计和xadmin搭建后台管理系统任务"></a>数据库设计和xadmin搭建后台管理系统任务</h2></li>
</ol>
<p>通过业务分析设计<code>django</code>的每个<code>app</code>，设计<code>app</code>下的<code>model</code>。设计<code>外键关系</code>，通过django的<code>migrate</code>设计生成数据表。</p>
<p>然后将这些<code>model</code>注册到<code>xadmin</code>当中。为每个model配置<code>搜索</code>,<code>过滤字段</code>，以及<code>列表页的显示字段</code>。配置xadmin的<code>主题选择</code>功能。</p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E5%90%8E%E5%8F%B0%E8%AE%BE%E8%AE%A1.png"></p>
<h2 id="系统功能模块实现任务"><a href="#系统功能模块实现任务" class="headerlink" title="系统功能模块实现任务"></a>系统功能模块实现任务</h2><p><strong>实现所有后台功能 &amp; 面试中经常被提及的web开发知识。</strong></p>
<p><strong>几乎所有的Django常用的模块：</strong></p>
<ol>
<li><code>setting</code>配置</li>
<li><code>url</code>配置</li>
<li><code>view</code>书写</li>
<li><code>model</code>设计</li>
<li><code>form</code>和<code>modelform</code>的使用</li>
<li><code>templates</code>模板的使用</li>
<li><code>Django</code>常见的内置函数</li>
</ol>
<br>

<h2 id="web系统知识以及网络安全任务"><a href="#web系统知识以及网络安全任务" class="headerlink" title="web系统知识以及网络安全任务"></a>web系统知识以及网络安全任务</h2><ol>
<li><code>sql</code>注入</li>
<li><code>xss</code>攻击</li>
<li><code>crsf</code>攻击</li>
</ol>
<p>这些攻击的原理以及防护措施</p>
<br>

<h2 id="xadmin扩展知识"><a href="#xadmin扩展知识" class="headerlink" title="xadmin扩展知识"></a>xadmin扩展知识</h2><p><strong>掌握更多可定制功能:</strong></p>
<ol>
<li>权限管理</li>
<li>权限配置</li>
<li>权限、用户、组之间的关系</li>
<li>xadmin常用插件</li>
<li>如何自定义xadmin插件</li>
<li>xadmin的富文本编辑功能</li>
<li>xadmin的excel导入功能</li>
</ol>
<p>还会用到一些开源的django开发库。</p>
<center>

<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/2.png"></p>
</center>

<p>学习完django，对于我们学习其他框架和通过Django搭建自己的系统都将变成简单的事情。</p>
<br>



<blockquote>
<p>Django+Xadmin开发现在学习平台</p>
<br>

<p>&nbsp;&nbsp;&nbsp;第二章：windows下搭建开发环境</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;教你安装mysql、pycharm、navicat、python相关环境</p>
</blockquote>
<p>​                       </p>
<br>

<h1 id="windows下搭建开发环境"><a href="#windows下搭建开发环境" class="headerlink" title="windows下搭建开发环境"></a><center>windows下搭建开发环境</center></h1><h2 id="Pycharm、mysql、Navicat安装"><a href="#Pycharm、mysql、Navicat安装" class="headerlink" title="Pycharm、mysql、Navicat安装"></a>Pycharm、mysql、Navicat安装</h2><p><strong>环境搭建</strong></p>
<blockquote>
<ol>
<li>pycharm</li>
<li>mysql for windows</li>
<li>navicat for mysql</li>
<li>python3.4</li>
</ol>
</blockquote>
<p><strong>提醒：记住自己设置的mysql密码</strong></p>
<br>

<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p>去mysql官网去下载相关的<a target="_blank" rel="noopener" href="https://dev.mysql.com/downloads/installer/">mysql</a>，笔者自己下载的是mysql 的MSI版的，安装过程可以参考<a target="_blank" rel="noopener" href="https://jingyan.baidu.com/article/f3ad7d0ffc061a09c3345bf0.html">https://jingyan.baidu.com/article/f3ad7d0ffc061a09c3345bf0.html</a></p>
<p>（本人就是按照这个来安装的）。</p>
<p>安装结束后，可以通过下面命令登录到mysql。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p </span><br></pre></td></tr></table></figure>

<p>然后输入登录密码就可以登录到mysql 了。</p>
<br>

<h3 id="Navicat"><a href="#Navicat" class="headerlink" title="Navicat"></a>Navicat</h3><p>安装指南：下一步-&gt;下一步</p>
<p>下载地址：<a target="_blank" rel="noopener" href="http://www.navicat.com.cn/download/navicat-for-mysql">http://www.navicat.com.cn/download/navicat-for-mysql</a></p>
<br>

<p>Pycharm</p>
<p>pycharm官方下载链接：<a target="_blank" rel="noopener" href="https://www.jetbrains.com/pycharm/download/#section=windows">https://www.jetbrains.com/pycharm/download/#section=windows</a></p>
<p><strong>我们要选择专业版（Professional）</strong>因为只有专业版才能够新建django项目,免费社区版不能。 （至于专业版的注册码可以上网去寻找解决办法，资源很多，无需担心）</p>
<p><strong>为Pycharm添加解释器：</strong> </p>
<p><code>setting</code> - &gt;<code>Project Interpreter</code>： 可以添加虚拟环境中的python解释器，也可以是自己本地安装好的python解释器，一直定位到 <code>python.exe</code> 点击确认。 </p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/3.png"></p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/4.png"></p>
<br>

<h3 id="Python3-4的安装"><a href="#Python3-4的安装" class="headerlink" title="Python3.4的安装"></a>Python3.4的安装</h3><p>具体的安装过程参考<a target="_blank" rel="noopener" href="http://www.jb51.net/article/65133.html%E3%80%82">http://www.jb51.net/article/65133.html。</a></p>
<br>

<h2 id="virutalenv安装和配置"><a href="#virutalenv安装和配置" class="headerlink" title="virutalenv安装和配置"></a>virutalenv安装和配置</h2><p>具体的参考<a target="_blank" rel="noopener" href="http://wuliekun.me/2018/05/09/python%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/">http://wuliekun.me/2018/05/09/python%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/</a></p>
<br>

<h2 id="Pycharm和Navicat的简单使用"><a href="#Pycharm和Navicat的简单使用" class="headerlink" title="Pycharm和Navicat的简单使用"></a>Pycharm和Navicat的简单使用</h2><h3 id="pycharm简单使用："><a href="#pycharm简单使用：" class="headerlink" title="pycharm简单使用："></a>pycharm简单使用：</h3><p><code>Setting -&gt; reopen</code>取消默认打开上一次项目 </p>
<br>

<h4 id="新建项目并验证成功运行"><a href="#新建项目并验证成功运行" class="headerlink" title="新建项目并验证成功运行"></a>新建项目并验证成功运行</h4><li>如何新建django项目： </li>



<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/5.png"></p>
<blockquote>
<p>选择好自己的项目的解释器为我们新建的虚拟环境。 </p>
</blockquote>
<p>新建<code>project</code>-&gt;<code>djangotestProj</code> 。别忘了为我们的虚拟环境安装<code>Django</code> </p>
<li>检查django环境是否安装好。`interpreter</li>`

<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/6.png"></p>
<li>点击导航栏的`run`可以直接运行我们的django项目</li>

<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/7.png"></p>
<blockquote>
<p>上图说明我们的django已经安装并且可以正常运行 </p>
</blockquote>
<li>点击浏览器打开`http://127.0.0.1:8000/`进行验证。 </li>

<h4 id="Run-edit配置修改"><a href="#Run-edit配置修改" class="headerlink" title="Run edit配置修改"></a>Run edit配置修改</h4><p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/8.png"></p>
<p>点击上图中<code>run edit</code> 可对Django运行时的一些设置进行修改。 </p>
<p>比如修改host为<code>0.0.0.0</code>，然后就可以设置监听本机ip。然后点击<code>run</code> </p>
<p>进入<code>cmd</code>下输入<code>ipconfig</code>查询自己的ip </p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/9.png"></p>
<blockquote>
<p>例如我的是 <code>192.168.1.103</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.1.103:8000&#x2F;   来访问。</span><br></pre></td></tr></table></figure>

<br>

<h4 id="目录颜色不同的原因"><a href="#目录颜色不同的原因" class="headerlink" title="目录颜色不同的原因"></a>目录颜色不同的原因</h4><p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/10.png"></p>
<p>可以看到不同的目录颜色不同。这是我们可以进行设置的，为了可以做到智能提示。 </p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/11.png"></p>
<p>右键可以将<code>template</code>目录<code>unmark</code> </p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/12.png"></p>
<p>可以看到上图目录是灰色的。但是我们<code>右键mark</code>为<code>source Root</code>目录，会变为蓝色。 </p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/13.png"></p>
<blockquote>
<p>这意味着我们在<code>import</code>时pycharm会根据设置智能提示。 </p>
<p>如果不mark可能会出现很多我们在pycharm中报红色， </p>
<p>但是cmd确可以运行的情况。 </p>
</blockquote>
<br>

<h3 id="Navicat基本使用"><a href="#Navicat基本使用" class="headerlink" title="Navicat基本使用"></a>Navicat基本使用</h3><h4 id="新建连接"><a href="#新建连接" class="headerlink" title="新建连接"></a>新建连接</h4><p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/14.png"></p>
<br>

<blockquote>
<p>点击新建一个mysql的连接。 </p>
</blockquote>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/15.png"></p>
<blockquote>
<p>连接名自行设置，密码填自己安装mysql时设置的密码。 </p>
</blockquote>
<h4 id="右键新建数据库"><a href="#右键新建数据库" class="headerlink" title="右键新建数据库"></a>右键新建数据库</h4><p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/16.png"></p>
<blockquote>
<p>数据库名自行设置，<code>utf-8</code> <code>utf_general_ci</code> </p>
<p><strong>注意：这里请与图中选择一致。否则保存中文可能出错</strong> </p>
</blockquote>
<br>

<h4 id="新建数据表"><a href="#新建数据表" class="headerlink" title="新建数据表"></a>新建数据表</h4><p>双击数据库<code>testdjango</code>,使他变绿，然后选中表，然后右键新建表。或使用右侧<code>新建表</code>按钮 。</p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/17.png"></p>
<p>输入必要的字段然后使用<code>ctrl + s</code> 进行保存并输入表名。 </p>
<br>

<h4 id="增加数据"><a href="#增加数据" class="headerlink" title="增加数据"></a>增加数据</h4><blockquote>
<p>双击表，可以展示我们的数据，这时候我们可以自行修改值。 点击左下角可以新增更多行。并且状态栏会显示一些sql语句信息 </p>
</blockquote>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/18.png"></p>
<br>

<h4 id="设计表"><a href="#设计表" class="headerlink" title="设计表"></a>设计表</h4><p>右键设计表：我们可以添加字段 </p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/19.png"></p>
<br>

<h4 id="sql语句查询"><a href="#sql语句查询" class="headerlink" title="sql语句查询"></a>sql语句查询</h4><p>点击查询，新建查询，我们可以输入sql语句进行查询。</p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/20.png"></p>
<br>

<h4 id="表的复制黏贴和数据库传输、数据库导入导出"><a href="#表的复制黏贴和数据库传输、数据库导入导出" class="headerlink" title="表的复制黏贴和数据库传输、数据库导入导出"></a>表的复制黏贴和数据库传输、数据库导入导出</h4><blockquote>
<p>Navicat支持我们把不同数据库的表之间的复制粘贴操作。</p>
<p> 支持数据传输：点击工具数据传输 </p>
</blockquote>
<p><strong>导出</strong>：在数据库上右键我们可以<code>转储SQL文件</code>: 可以选择只转存结构。或连带数据一起。</p>
<p><strong>导入</strong>：右键点击运行SQL文件。 </p>
<p><strong>表的操作</strong>：删除，清空等，在点击表的右键菜单里。 </p>
<br>

<h1 id="Django基础知识回顾"><a href="#Django基础知识回顾" class="headerlink" title="Django基础知识回顾"></a><center>Django基础知识回顾</center></h1><h2 id="Django目录结构"><a href="#Django目录结构" class="headerlink" title="Django目录结构"></a>Django目录结构</h2><p><strong>Django目录：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">projectname : 保存Django项目的urls,setting，uwsgi文件</span><br></pre></td></tr></table></figure>

<br>

<h3 id="django自动生成的目录"><a href="#django自动生成的目录" class="headerlink" title="django自动生成的目录"></a>django自动生成的目录</h3><p>初始化完成后的目录如下：(如果不是，那么你们可能创建的不是django项目) </p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/21.png"></p>
<p>可以看到主目录<code>DjangoGetStarted</code>与项目目录<code>DjangoGetStarted</code> </p>
<blockquote>
<li>DjangoGetStarted(文件夹)： </li>

<p>&nbsp;&nbsp;1.&nbsp;setting.py: 项目全局配置文件</p>
<p>&nbsp;&nbsp;2.&nbsp;url.py: 主要的url配置入口</p>
<p>&nbsp;&nbsp;3.&nbsp;wsgi.py: Django启动文件</p>
<li>templates(文件夹)： 放置html文件  </li>

<li>manage.py： 启动Django需要的主要文件。(主要的Django命令都通过manage.py运行) </li>


</blockquote>
<h3 id="自己创建的目录"><a href="#自己创建的目录" class="headerlink" title="自己创建的目录"></a>自己创建的目录</h3><p>app是Django里一个一个应用的文件夹单位。 </p>
<p>通过 <code>Tools -&gt; Run manage.py Task</code>创建app： </p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/22.png"></p>
<br>

<h4 id="startapp-appname"><a href="#startapp-appname" class="headerlink" title="startapp appname"></a>startapp appname</h4><p>可以看到当输入<code>startapp message</code>之后，创建了<code>message</code>应用。并存放在了：与项目目录同级目录。 </p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/23.png"></p>
<p>这里面有红色的警告，<strong>面向强迫症解决方案是</strong>在<code>setting.py</code> 新增<code>STATIC_ROOT = &#39;/static/&#39;</code> </p>
<p>但其实现在还没有用到这个参数。后面用到我们再配置。(推荐自行克服强迫症) </p>
<br>

<h4 id="新建static目录"><a href="#新建static目录" class="headerlink" title="新建static目录"></a>新建static目录</h4><p>使用<code>static</code>目录来存放网站的静态文件：js，css，图片等。 </p>
<h4 id="新建log目录"><a href="#新建log目录" class="headerlink" title="新建log目录"></a>新建log目录</h4><p>使用<code>log</code>目录来存放网站的日志文件 </p>
<h4 id="新建media目录"><a href="#新建media目录" class="headerlink" title="新建media目录"></a>新建media目录</h4><p>使用<code>media</code>目录存放用户上传的图片等资源。 </p>
<h4 id="项目庞大而带来app过多导致文件冲突问题的解决"><a href="#项目庞大而带来app过多导致文件冲突问题的解决" class="headerlink" title="项目庞大而带来app过多导致文件冲突问题的解决"></a>项目庞大而带来app过多导致文件冲突问题的解决</h4><ol>
<li>新建文件夹 <code>apps</code></li>
<li>将<code>message</code>文件夹拖入<code>apps</code>文件夹内：会自动生成<code>__init__.py</code>文件表明这是一个包。使得apps文件夹可导入。</li>
</ol>
<blockquote>
<p>这时我们就会发现在导入我们的message的内容就得配置较长的路径。 </p>
</blockquote>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/24.png"></p>
<blockquote>
<p>每次前面都得加上<code>apps.</code>，这可烦死人啦 。</p>
</blockquote>
<br>

<p><strong>解决方案奉上</strong> </p>
<blockquote>
<p>将<code>apps</code>目录右键<code>mark</code>成<code>Source Root</code>(Mark 方法查看第一章pycharm简单使用：目录颜色不同的原因) </p>
</blockquote>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/25.png"></p>
<br>

<p>mark成功之后<strong>变蓝</strong>(变绿的话，只能摸摸头了，当然选择原谅)，然后可以直接使用短路径进行import </p>
<h4 id="Mark后Pycharm-不报错，Cmd下运行报错。"><a href="#Mark后Pycharm-不报错，Cmd下运行报错。" class="headerlink" title="Mark后Pycharm 不报错，Cmd下运行报错。"></a>Mark后Pycharm 不报错，Cmd下运行报错。</h4><p>Mark后pycharm知道这是一个项目的<code>Souce Root</code>路径了，但是cmd并不知道。 </p>
<blockquote>
<p>在项目目录下通过cmd命令行使用<code>python manage.py runserver</code> </p>
</blockquote>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/26.png"></p>
<br>

<blockquote>
<p>pycharm中mark只是pycharm自身可以进行识别短路径。 </p>
</blockquote>
<p><strong>解决方案：</strong></p>
<blockquote>
<p>我们在setting文件中配置我们的<code>apps</code>路径: </p>
</blockquote>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/27.png"></p>
<blockquote>
<p>图解读：我们需要在setting中向上图一样设置,程序就会接着报错。(换了一个错误了，滑稽脸) </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">sys.path.insert(0,os.path.join(BASE_DIR,&#39;apps&#39;))</span><br></pre></td></tr></table></figure>

<p>上述代码为将apps拼接项目绝对路径后的路径插入当前系统的环境变量path中，这样就可以成功解决(个屁屁啊)。</p>
<p>成功性测试(测试已失败)：</p>
<blockquote>
<p>这个import放到manage.py文件是不行的 你把manage.py中这行删除 因为django整个的配置还没有启动好 import django的model是不行的，</p>
</blockquote>
<p>插播：忘了失败吧，我偷学下面方法养你。</p>
<p><strong>终极解决：将这个import方法比如urls.py.等可以成功启动。</strong>或者自行删除该import。</p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/28.png"></p>
<p>红色警告：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">You have unapplied migrations; your app may not work properly </span><br><span class="line">until they are applied. Run &#39;python manage.py migrate&#39; to apply them.</span><br></pre></td></tr></table></figure>

<p>是因为我们没有进行数据库<code>models</code>进行初始化<code>migrate</code>.</p>
<p><code>python manage.py migrate</code>我们之后会用到，现在不要做。</p>
<br>

<h2 id="github仓库项目初始化第一个commit"><a href="#github仓库项目初始化第一个commit" class="headerlink" title="github仓库项目初始化第一个commit"></a>github仓库项目初始化第一个commit</h2><p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/29.png"></p>
<blockquote>
<p>输入用户名密码，点击login。 </p>
<p>-&gt;选择左侧导航中<code>Git</code> 设置你的git.exe的路径 </p>
</blockquote>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/30.png"></p>
<br>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">点击VCS-&gt;Import into Version Control-&gt;Share project on GitHub  会弹出一个窗口</span><br></pre></td></tr></table></figure>

<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/31.png"></p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/32.png"></p>
<p>填写你的项目<code>名称</code>，<code>描述</code>。点击<code>share</code>。</p>
<p>会弹窗让你选择需要上传的项目文件与commit信息。然后将项目上传至github。</p>
<br>

<p><strong>==检查是否真正的commit成功？==</strong></p>
<p>登陆到自己的github中，查看Your profile</p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/33.png"></p>
<p>如图所示commit成功，仓库连接是<a target="_blank" rel="noopener" href="https://github.com/wlk-flyme/MXOline">https://github.com/wlk-flyme/MXOline</a></p>
<br>

<h2 id="配置表单页面"><a href="#配置表单页面" class="headerlink" title="配置表单页面"></a>配置表单页面</h2><h3 id="前奏"><a href="#前奏" class="headerlink" title="前奏"></a>前奏</h3><p>本节通过Django快速的配置一个<strong>留言板页面</strong>来学习。</p>
<p>Django从请求到响应的整个完整流程。为我们开发在线教育平台打下基础。 </p>
<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/34.png"></p>
<p>上图便是本节教程所要用到的静态页面:<code>form.html</code> </p>
<blockquote>
<p>具体的业务：填写信息 -&gt; 然后点击提交 -&gt;数据被存储到数据库。 </p>
</blockquote>
<p>这个<code>html</code>是一个单文件，里面已经包含了<code>css</code> <code>js</code>内容。 </p>
<h3 id="将html文件整合进项目操作步骤"><a href="#将html文件整合进项目操作步骤" class="headerlink" title="将html文件整合进项目操作步骤"></a>将html文件整合进项目操作步骤</h3><h4 id="将html文件直接复制进templates目录"><a href="#将html文件直接复制进templates目录" class="headerlink" title="将html文件直接复制进templates目录."></a>将<code>html</code>文件直接复制进<code>templates</code>目录.</h4><p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/35.png"></p>
<h4 id="创建static目录下的css文件夹-和-static-js"><a href="#创建static目录下的css文件夹-和-static-js" class="headerlink" title="创建static目录下的css文件夹 和 static/js"></a>创建<code>static目录下的css文件夹</code> 和 <code>static/js</code></h4><li>在css中再新建一个`style.css` </li>

<p><img src="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/36.png"></p>
<li>`form.html`中点击`<style>`标签左侧减号。将style内容收成一行。然后把这一行内容**剪切粘贴到**`style.css`</li>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/37.png"></p>
<li>黏贴进入之后，将首尾两个`style`删除，`shift+tab`可以将css格式化更整齐</li>

<li>在`form.html`新建`<link>`来引入css。(文件里其实已经先加上了，学一种操作而已) </li>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel&#x3D;&quot;stylesheet&quot; href&#x3D;&quot;&#x2F;static&#x2F;css&#x2F;style.css&quot;&gt;</span><br></pre></td></tr></table></figure>

</br>

<h3 id="配置Django连接mysql数据库"><a href="#配置Django连接mysql数据库" class="headerlink" title="配置Django连接mysql数据库"></a>配置Django连接mysql数据库</h3><p>在<code>setting.py</code>中的<code>DATABASES</code>能够找到: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DATABASES &#x3D; &#123;</span><br><span class="line">    &#39;default&#39;: &#123;</span><br><span class="line">        &#39;ENGINE&#39;: &#39;django.db.backends.sqlite3&#39;,</span><br><span class="line">        &#39;NAME&#39;: os.path.join(BASE_DIR, &#39;db.sqlite3&#39;),</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是Django默认与自己项目根目录下的<code>db.sqlite3</code>连接的设置。 </p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/38.png"></p>
<p>我们的项目是与<code>mysql</code>连接，所以我们要改成如下： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DATABASES &#x3D; &#123;</span><br><span class="line">    &#39;default&#39;: &#123;</span><br><span class="line">        &#39;ENGINE&#39;: &#39;django.db.backends.mysql&#39;,</span><br><span class="line">        &#39;NAME&#39;: &quot;mxonline&quot;,</span><br><span class="line">        &#39;USER&#39;: &#39;root&#39;,</span><br><span class="line">        &#39;PASSWORD&#39;: &#39;123456&#39;,</span><br><span class="line">        &#39;HOST&#39;: &#39;127.0.0.1&#39;,</span><br><span class="line">        &#39;OPTIONS&#39;: &#123;</span><br><span class="line">            &quot;init_command&quot;: &quot;SET foreign_key_checks &#x3D; 0;&quot;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中的<code>name</code>应设置为我们中在Navicat中新建的数据库名字。<strong>名字一定要保持一致</strong></p>
<p>这时要将我们之前建的表提前<strong>全部删除</strong>掉。</p>
<h4 id="配置mysql驱动和seeting文件。"><a href="#配置mysql驱动和seeting文件。" class="headerlink" title="配置mysql驱动和seeting文件。"></a>配置mysql驱动和seeting文件。</h4><p>点击<code>Tools 菜单下 Run manage.py Task</code>我们会发现报错了： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">raise ImproperlyConfigured(&quot;Error loading MySQLdb module: %s&quot; % e)</span><br><span class="line">django.core.exceptions.ImproperlyConfigured: Error loading MySQLdb module: No module named MySQLdb</span><br></pre></td></tr></table></figure>

<blockquote>
<p>由错误信息我们可以看出是因为没有安装数据库驱动模块<code>MySQLdb</code> </p>
<p>Python2装的mysql驱动驱动模块是MySQLdb</p>
<p>python3幢的MySQL驱动驱动模块是PyMySQL</p>
</blockquote>
<p>笔者下载的是PyMySQL。</p>
<p>1.下载地址<a target="_blank" rel="noopener" href="https://www.lfd.uci.edu/~gohlke/pythonlibs/#pymssql">https://www.lfd.uci.edu/~gohlke/pythonlibs/#pymssql</a></p>
<p>2.请确保选择了正确文件WHL 。例如：如果您正在使用Python2.7在64位机器选择：pymssql‑2.1.1‑‑‑win_amd64.whlcp27没有。一旦你下载的文件，使WHL在C：/文件夹python27。 </p>
<p>3.打开cmd.exe</p>
<p>4.安装模块pymsql</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; cd c:\Python3.4  </span><br><span class="line">&gt; pip install pymssql‑2.1.1‑cp27‑none‑win_amd64.whl  </span><br></pre></td></tr></table></figure>

</br>

<p>输入下面命令来生成表: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br></pre></td></tr></table></figure>

<p>这时我们去Navicat查看会发现为我们生成了很多表。 </p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/39.png"></p>
<p>这些都是Django系统默认的<strong>内置</strong>数据表。</p>
<p>做完这些操作我们可以点击<code>Run</code>来运行项目，<br>然后到<code>http://127.0.0.1:8000/</code>来访问看是否运行成功。成功页面(It worked)</p>
</br>

<h3 id="配置form页面展示出来："><a href="#配置form页面展示出来：" class="headerlink" title="配置form页面展示出来："></a>配置form页面展示出来：</h3><p><code>项目名/urls.py</code>修改如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    url(r&#39;^admin&#x2F;&#39;, admin.site.urls),</span><br><span class="line">    url(r&#39;^form&#x2F;$&#39;, getform) #这行是新增加的.</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>新增加<code>url(r&#39;^form/$&#39;, getform)</code>,<code>^</code>是代表以<code>form</code>为开头，<code>$</code>代表以<code>/</code>结尾的地址。<br>这里<code>getform</code> 是对于这个<code>url</code>的相应处理的<code>view</code>。我们先去创建一个.</p>
<p><code>app名称/views.py</code>添加如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def getform(request):</span><br><span class="line">    return render(request, &#39;message_form.html&#39;)</span><br></pre></td></tr></table></figure>

<p><code>request</code> 参数是一个django的<code>http request</code>对象。(基础)<br>这里我们可以按住<code>ctrl</code> + <code>左键</code> 跟踪到我们的<code>render</code>函数里面。<br><code>Alt + 左箭头</code> 回来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def render(request, template_name,...):</span><br></pre></td></tr></table></figure>

<p>源代码解读：可以看到我们的<code>render</code>需要一个<code>request对象</code>和<code>template_name</code>参数</p>
<p><strong>注意：记性好的还记得我们提供的源文件是form.html</strong></p>
<blockquote>
<p>知识点：django内置了很多html页面，form会先从内置中寻找。所以我们得改。 </p>
</blockquote>
<p>因此我们需要右键如下图<code>Refactor</code>修改<code>from.html</code> 为<code>xxx_form</code> </p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/40.png"></p>
<p>如果我们的项目在运行，<code>ctrl + s</code>会自动重启我们的项目。</p>
<p>这时我们有了view，我们可以去配置完整的url了(前面已经配完整的检查一遍)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">from message.views import getform</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    url(r&#39;^admin&#x2F;&#39;, admin.site.urls),</span><br><span class="line">    url(r&#39;^form&#x2F;$&#39;, getform)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><strong>这里我们不能加括号</strong><u>否则会变成</u><strong>方法的调用</strong>。</p>
<p>按住<code>ctrl</code> + <code>render</code> 跟踪到我们的<code>url</code>函数里面查看源码如下:可以看到它除了一组正则表达式，还需要接收一个view对象。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def url(regex, view,...):</span><br></pre></td></tr></table></figure>

<p>如果<code>getform</code>加上括号会报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: getform() takes exactly 1 argument (0 given)</span><br></pre></td></tr></table></figure>

<p>访问<code>http://127.0.0.1:8000/</code> 正常结果：Page not found</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Using the URLconf defined in DjangoGetStarted.urls, Django tried these URL patterns, in this order:</span><br><span class="line"></span><br><span class="line">^admin&#x2F;</span><br><span class="line">^form&#x2F;$</span><br></pre></td></tr></table></figure>

<p>是因为我们在url中加入了个人的配置<code>^form/$</code>,它就不会采用默认配置了。</p>
<p>原因：(源码探究标记点)</p>
<p>这时访问：<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/form/">http://127.0.0.1:8000/form/</a></p>
<p>旧版本pycharm会报：<code>TemplateDoesNotExist</code>错误。我的新版本pycharm并没有出现。</p>
<p>重要代码在<code>settings.py</code> 60行左右</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 指明我们的templates目录路径</span><br><span class="line">&#39;DIRS&#39;: [os.path.join(BASE_DIR, &#39;templates&#39;)]</span><br><span class="line"># 老版本pycharm创建django项目该值为空。</span><br></pre></td></tr></table></figure>

<p>现在再次访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/form/">http://127.0.0.1:8000/form/</a></p>
<p><strong>页面出来了但是样式没有。static目录下的css文件提示没有找到。</strong></p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/41.png"></p>
<p>Setting中静态文件的配置，这是因为我们setting中的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL &#x3D; &#39;&#x2F;static&#x2F;&#39;</span><br></pre></td></tr></table></figure>

<p>只说明了目录的名称。并没有指明查找的根路径。添加下面代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL &#x3D; &#39;&#x2F;static&#x2F;&#39;</span><br><span class="line">STATICFILES_DIRS &#x3D; [</span><br><span class="line">    os.path.join(BASE_DIR, &#39;static&#39;)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><strong>过程中看似不停的出错</strong>，其实是为了让大家更好记住该记住的。</p>
<p>我们刚才是以倒序：</p>
<ol>
<li>把html文件放进来</li>
<li>通过简单的url配置来访问html。</li>
<li>发现找不到页面，所以我们设置setting中<code>DIRS</code></li>
<li>文件找到了又说找不到静态文件，我们设置了<code>STATICFILES_DIRS</code></li>
</ol>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/42.png"></p>
<p>这是我们的整体流程图，推荐新建一个项目再按照正向流程图来一遍。</p>
<p>后面我们的工作会围绕从migration生成数据表往下的内容展开。</p>
</br>

<h2 id="Django-对象关系映射ORM介绍与model设计"><a href="#Django-对象关系映射ORM介绍与model设计" class="headerlink" title="Django 对象关系映射ORM介绍与model设计"></a>Django 对象关系映射ORM介绍与model设计</h2><h3 id="原生sql-与-orm"><a href="#原生sql-与-orm" class="headerlink" title="原生sql 与 orm"></a>原生sql 与 orm</h3><p>没有ORM（Object Relational Mapping ） 的情况下views.py代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import MySQLdb</span><br><span class="line"></span><br><span class="line"># 使用原生sql获取书的列表</span><br><span class="line">def book_list(request):</span><br><span class="line">    # 创建到数据库的连接: 指明用户名，数据库，密码</span><br><span class="line">    db &#x3D; MySQLdb.connect(user &#x3D; &#39;me&#39;, db&#x3D;&#39;mydb&#39;, passwd&#x3D;&#39;secret&#39;, host&#x3D;&#39;localhost&#39;)</span><br><span class="line">    # 创建一个游标对象执行器</span><br><span class="line">    cursor &#x3D; db.cursor()</span><br><span class="line">    # 书写我们需要的sql语句</span><br><span class="line">    cursor.execute(&#39;SELECT name FROM books ORDER BY name&#39;)</span><br><span class="line">    # 对于fetchall()的结果做遍历，将遍历回来的结果当做数组，取第0个值name。</span><br><span class="line">    names &#x3D; [row[0] for row in cursor.fetchall()]</span><br><span class="line">    db.close()</span><br></pre></td></tr></table></figure>

<p>可不可以让数据库字段的查询和使用类的一个属性一样简单？没错登登登：orm上场了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">book:name</span><br><span class="line"></span><br><span class="line">book.name</span><br><span class="line">book.save()</span><br></pre></td></tr></table></figure>

<p>Django的orm就是为了让我们不再写上面那样的语句，而是像使操作数据库像使用类和类属性一样。</p>
<h3 id="创建我们的models"><a href="#创建我们的models" class="headerlink" title="创建我们的models"></a>创建我们的models</h3><blockquote>
<p><code>verbose_name</code>:<strong>对象的人类可读的名称，单数</strong>:</p>
</blockquote>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">verbose_name &#x3D; &quot;pizza&quot;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Meta，内嵌于 UserMessage 这个类的定义中</span><br><span class="line">如果 class Publisher 是顶格的，那么 class Meta 在它之下要缩进4个空格－－按 Python 的传统</span><br><span class="line">你可以在任意一个 模型 类中使用 Meta 类，来设置一些与特定模型相关的选项。</span><br><span class="line">如：设置ordering &#x3D; [&#39;name&#39;]，默认地都会按 name 字段排序</span><br></pre></td></tr></table></figure>

<p>models.py：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 继承于django.db.models.Model</span><br><span class="line">class UserMessage(models.Model):</span><br><span class="line">    # 设置最大长度，verbose_name在后台显示字段会用到</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;20, verbose_name&#x3D;u&quot;用户名&quot;)</span><br><span class="line">    # Django提供内置的邮箱字段会帮忙验证&#96; default_validators &#x3D; [validators.validate_email]&#96;</span><br><span class="line">    email &#x3D; models.EmailField(verbose_name&#x3D;u&quot;邮箱&quot;)</span><br><span class="line">    address &#x3D; models.CharField(max_length&#x3D;100, verbose_name&#x3D;u&quot;联系地址&quot;)</span><br><span class="line">    message &#x3D; models.CharField(max_length&#x3D;500, verbose_name&#x3D;u&quot;留言信息&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;用户留言信息&quot;</span><br><span class="line">        # db_table ，这里我们让它自动生成所以不用指定</span><br></pre></td></tr></table></figure>

<p>这时我们执行<code>makemigrations messages</code>会发现并没有改动。</p>
<blockquote>
<p>因为setting中我们没有注册我们的app: message </p>
</blockquote>
<h3 id="在setting中注册我们的app"><a href="#在setting中注册我们的app" class="headerlink" title="在setting中注册我们的app"></a>在setting中注册我们的app</h3><p>在settings.py中找到 <code>INSTALLED_APPS</code>: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#96;INSTALLED_APPS&#96;</span><br><span class="line">[</span><br><span class="line">    前面的不用变，后面新增下一行</span><br><span class="line">    &#39;message&#39;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>这时候我们重新运行<code>Tools 菜单下 Run manage.py Task</code>会提示： </p>
<p>如果提示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SyntaxError: Non-ASCII character &#39;\xe7&#39; in file D:\CodeSpace\PythonProject\DjangoGetStarted\apps\message\models.py on line</span><br></pre></td></tr></table></figure>

<p>请注意可能你忘记在写过中文的地方加上:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#coding: utf-8</span><br></pre></td></tr></table></figure>

<p><strong>注意必须加在第一或二行。</strong></p>
<p>然后执行下面命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">makemigrations message</span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/43.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrate message 生成数据表</span><br></pre></td></tr></table></figure>

<p>最后前往Navicat验证。</p>
<h3 id="Models讲解"><a href="#Models讲解" class="headerlink" title="Models讲解"></a>Models讲解</h3><p>除过普通的对应数据库的字段类型如<code>CharField</code>，还有很多高级类型。如<code>EmailField</code>提供email验证。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">models.ForeignKey     # 外键</span><br><span class="line">models.DateTimeField  # 时间字段</span><br><span class="line">models.IntegerField   # 整型</span><br><span class="line">models.IPAddressField # IP地址</span><br><span class="line">models.FileField      # 上传文件</span><br><span class="line">models.ImageField     # 图片</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ctrl按住+左键点击<code>models</code> 进入之后点击<code>fields</code>拖到文件开始可以看到所有字段： </p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="介绍字段参数"><a href="#介绍字段参数" class="headerlink" title="介绍字段参数"></a>介绍字段参数</h4><p><code>CharField</code>必须指明默认最大长度。<code>null=True,blank=True</code>指明字段可以为空<br><code>defalut = &quot; &quot;</code>指定默认值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name &#x3D; models.CharField(max_length&#x3D;20,null&#x3D;True,blank&#x3D;True, verbose_name&#x3D;u&quot;用户名&quot;)</span><br></pre></td></tr></table></figure>

<p>id是<strong>自动生成的</strong>，如果需要自定义主键,message/models.py中添加字段：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object_id &#x3D; models.CharField(primary_key&#x3D;True, verbose_name&#x3D;&quot;主键&quot;)</span><br></pre></td></tr></table></figure>

<p>此时点击<code>Tools 菜单下 Run manage.py Task</code>输入<code>makemigrations message</code></p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/44.png"></p>
<p><strong>知识点：CharField必须指明最大长度</strong> </p>
<p>object_id改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">object_id &#x3D; models.CharField(primary_key&#x3D;True, max_length&#x3D;50 ,verbose_name&#x3D;&quot;主键&quot;)</span><br></pre></td></tr></table></figure>

<p>这时点击<code>Tools 菜单下 Run manage.py Task</code>输入<code>makemigrations message</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">You are trying to add a non-nullable field &#39;object_id&#39; to usermessage without a default; we can&#39;t do that (the database needs something to populate existing rows).</span><br><span class="line">Please select a fix:</span><br><span class="line"> 1) Provide a one-off default now (will be set on all existing rows)</span><br><span class="line"> 2) Quit, and let me add a default in models.py</span><br></pre></td></tr></table></figure>

<p>根据提示信息，我们需要给<code>object_id</code>添加默认值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">object_id &#x3D; models.CharField(primary_key&#x3D;True, max_length&#x3D;50,default&#x3D;&quot;&quot;, verbose_name&#x3D;&quot;主键&quot;)</span><br></pre></td></tr></table></figure>

<p><strong>get新知识点：object_id必须有默认值</strong> </p>
<p>输入<code>2</code> 退出：然后输入<code>makemigrations message</code> </p>
<p>再输入下面命令生成数据表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">migrate message</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看到上图过程中会告诉我们做了哪些变化，如删除了默认系统生成的主键<code>id</code> ,变更了<code>name</code>。新增了我们的<code>object_id</code> </p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/45.png"></p>
<p>前往Navicat验证右键设计表： </p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/46.png"></p>
<p>可以看到<code>object_id</code>已经成为我们的新主键。 </p>
<h4 id="介绍Meta信息："><a href="#介绍Meta信息：" class="headerlink" title="介绍Meta信息："></a>介绍Meta信息：</h4><p>Meta信息中我们可以指定常见的类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db_table &#x3D; &quot;user_meassage&quot;</span><br></pre></td></tr></table></figure>

<p>自定义后生成表，表名会与我们的保持一致。而不会前缀<code>appname</code>如：<code>message_</code></p>
<blockquote>
<p>这里因为我们已经生成过了，就不要做验证改变表名了。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ordering &#x3D; &#39;-object_id&#39;</span><br></pre></td></tr></table></figure>

<p>ordering指定默认排序字段,如：就会以object_id倒序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">verbose_name_plural &#x3D; u&quot;用户留言信息&quot;</span><br></pre></td></tr></table></figure>

<p>verbose_name_plural：复数信息，便于人阅读。否则会在后台显示<code>用户留言信息s</code></p>
<p>已经学习完毕了<code>orm</code>将数据表映射表。</p>
<h2 id="django-model的增删改"><a href="#django-model的增删改" class="headerlink" title="django model的增删改"></a>django model的增删改</h2><p>在<code>message/views.py</code>中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from .models import UserMessage</span><br></pre></td></tr></table></figure>

<p>将我们刚才创建的model，import进来。<code>.</code>代表是与当前同级的目录。</p>
<p>按照下图所示添加一条测试数据。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/47.png"></p>
<p>然后再我们的<code>getform</code>方法内部添加下面代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def getform(request):</span><br><span class="line">    # UserMessage默认的数据管理器objects。</span><br><span class="line">    # 方法all()是将所有数据返回成一个queryset类型(django的内置类型)</span><br><span class="line">    all_message &#x3D; UserMessage.objects.all()</span><br><span class="line"></span><br><span class="line">    #我们可以对于all_message进行遍历操作</span><br><span class="line">    for message in all_message:</span><br><span class="line">        # 每个message实际就是一个UserMessage对象（这时我们就可以使用对象的相关方法）。</span><br><span class="line">        print message.name</span><br><span class="line"></span><br><span class="line">    return render(request, &#39;message_form.html&#39;)</span><br></pre></td></tr></table></figure>

<p>调试过程：</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/48.png"></p>
<li>点击上图小红框位置，打上断点。</li>

<li>点击Run -> debug后：在浏览器里打开：`http://127.0.0.1:8000/form/`</li>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/49.png"></p>
<li>弹出上图代表已进入断点。 </li>

<li>此时鼠标左键点击：all_message.可以看到这是一个`{QuerySet}类型的对象，里面存放着[<UserMessage: UserMessage object>]` </li>

<li>按`f8`使运行到下一步。此时下方的值窗口内可以看到message的值。说明我们成功取到了数据库的值。 </li>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/50.png"></p>
<h3 id="filter取出指定要求值"><a href="#filter取出指定要求值" class="headerlink" title="filter取出指定要求值"></a>filter取出指定要求值</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">all_message &#x3D; UserMessage.objects.filter(name&#x3D;&#39; mtianyan&#39;, address&#x3D;&#39;西安&#39;)</span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/51.png"></p>
<p>按照上面调试过程重新调试可以看到我们同样取出了值。 </p>
<h3 id="将数据存入数据库"><a href="#将数据存入数据库" class="headerlink" title="将数据存入数据库"></a>将数据存入数据库</h3><p>了解：django/db/models/base.py 源码中提供<code>save</code>方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def save(self, force_insert&#x3D;False, force_update&#x3D;False, using&#x3D;None,update_fields&#x3D;None):</span><br></pre></td></tr></table></figure>

<p>getform方法中添加代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 存储部分</span><br><span class="line"></span><br><span class="line">   # 首先实例化一个对象</span><br><span class="line">   user_message &#x3D; UserMessage()</span><br><span class="line"></span><br><span class="line">   # 为对象增加属性</span><br><span class="line">   user_message.name &#x3D; &quot;mtianyan2&quot;</span><br><span class="line">   user_message.message &#x3D; &quot;blog.mtianyan.cn&quot;</span><br><span class="line">   user_message.address &#x3D; &quot;西安&quot;</span><br><span class="line">   user_message.email &#x3D; &quot;1147727180@qq.com&quot;</span><br><span class="line">   user_message.object_id &#x3D; &quot;efgh&quot;</span><br><span class="line"></span><br><span class="line">   # 调用save方法进行保存</span><br><span class="line">   user_message.save()</span><br></pre></td></tr></table></figure>

<li>打上断点：如下图。 </li>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/53.png"></p>
<li>一直惦记f8单步调试，直到如下图：蓝色到`return`语句 </li>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/54.png"></p>
<p>可以在下方值窗口查看到值 </p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/55.png"></p>
<h3 id="Navicat进行验证"><a href="#Navicat进行验证" class="headerlink" title="Navicat进行验证"></a>Navicat进行验证</h3><blockquote>
<p>可以看到成功的添加了数据<code>mtianyan2</code> </p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/56.png"></p>
<h3 id="如何从html的提交中取到数据并保存进数据库"><a href="#如何从html的提交中取到数据并保存进数据库" class="headerlink" title="如何从html的提交中取到数据并保存进数据库"></a>如何从html的提交中取到数据并保存进数据库</h3><p>templates/message_form.html：</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/57.png"></p>
<blockquote>
<p><code>method</code>是<code>post</code>。<code>action</code>就是指向我们在urls.py中配置的<code>/form/</code> </p>
<p><strong>前面必须加斜杠指根路径下form</strong> </p>
<p>里面的<code>input</code>会自动把值传递给后台：这时我们就可以在<code>getform</code>中取到刚才传递过来的值。 </p>
</blockquote>
<p>运行项目：然后输入需要填写的值。点击提交：出现403错误 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Forbidden (403)</span><br><span class="line">CSRF verification failed. Request aborted.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>根据提示：我们的页面没有进行<code>crsf</code>的验证，这时django的安全机制，不允许任意<code>form</code>都往后台提交。 </p>
</blockquote>
<p><strong>知识点：所以我们需要在html页面中加入<code>csrf_token</code></strong> </p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/58.png"></p>
<p>原有那行删除掉。打上断点 .</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/59.png"></p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;QueryDict: &#123;u&#39;message&#39;: [u&#39;\u54c8\u54c8&#39;], u&#39;address&#39;: [</span><br><span class="line">u&#39;\u897f\u5b89\u5e02&#39;], u&#39;csrfmiddlewaretoken&#39;: [</span><br><span class="line">u&#39;uIYSMOTWPJBPOPucRwd3uDaWtCzeEaem&#39;], u&#39;name&#39;: [</span><br><span class="line">u&#39;\u5929\u6daf\u660e\u6708\u7b19&#39;], u&#39;email&#39;: [u&#39;1147727180@qq.com&#39;]&#125;&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/60.png"></p>
<blockquote>
<p>数据以dict：key-value 形式存储 key是由如下图html中的name所决定对应的。 </p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/61.png"></p>
<h3 id="数据库新增"><a href="#数据库新增" class="headerlink" title="数据库新增"></a>数据库新增</h3><p><code>request.POST</code>中数据取出，存入<code>user_message</code>对象 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># html表单部分</span><br><span class="line"></span><br><span class="line">   # 此处对应html中的method&#x3D;&quot;post&quot;，表示我们只处理post请求</span><br><span class="line">   if request.method &#x3D;&#x3D; &quot;POST&quot;:</span><br><span class="line">       # 就是取字典里key对应value值而已。取name，取不到默认空</span><br><span class="line">       name &#x3D; request.POST.get(&#39;name&#39;, &#39;&#39;)</span><br><span class="line">       message &#x3D; request.POST.get(&#39;message&#39;, &#39;&#39;)</span><br><span class="line">       address &#x3D; request.POST.get(&#39;address&#39;, &#39;&#39;)</span><br><span class="line">       email &#x3D; request.POST.get(&#39;email&#39;, &#39;&#39;)</span><br><span class="line"></span><br><span class="line">       # 实例化对象</span><br><span class="line">       user_message &#x3D; UserMessage()</span><br><span class="line"></span><br><span class="line">       # 将html的值传入我们实例化的对象.</span><br><span class="line">       user_message.name &#x3D; name</span><br><span class="line">       user_message.message &#x3D; message</span><br><span class="line">       user_message.address &#x3D; address</span><br><span class="line">       user_message.email &#x3D; email</span><br><span class="line">       user_message.object_id &#x3D; &quot;ijkl&quot;</span><br><span class="line"></span><br><span class="line">       # 调用save方法进行保存</span><br><span class="line">       user_message.save()</span><br></pre></td></tr></table></figure>

<ul>
<li><ul>
<li>打断点在下图位置：</li>
</ul>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/62.png"></p>
</li>
</ul>
<ul>
<li><p>进入调试：点击点击method：是get请求。因为我们并没有按提交按钮，而是get这个网页 </p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/63.png"></p>
</li>
</ul>
<ul>
<li>点击f8继续运行我们的项目 浏览器中填写表单内容点提交。 </li>
</ul>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/64.png"></p>
<blockquote>
<p>因为这次是表单提交，已经变成了post方式。按<code>f6</code>进行单步调试。 </p>
</blockquote>
<p>一直单步到如下图蓝色 </p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/65.png"></p>
<p>这时候值浏览窗口可以看到 </p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/66.png"></p>
<blockquote>
<p>检查我们的user_message对象的属性是否已经全部添加进去，</p>
</blockquote>
<p>使用f8 继续项目并前往Navicat验证</p>
<h3 id="删除数据。"><a href="#删除数据。" class="headerlink" title="删除数据。"></a>删除数据。</h3><p>对于查询到的数据做删除：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 方法2 :&#96;filter&#96;取出指定条件值，逗号代表and 必须同时满足两个条件才返回。</span><br><span class="line">all_message &#x3D; UserMessage.objects.filter(name&#x3D;&#39;wlk&#39;, address&#x3D;&#39;合肥&#39;)</span><br><span class="line"></span><br><span class="line"># 我的数据库里保存着可以匹配到该条数据的一行。</span><br><span class="line"></span><br><span class="line"># 删除操作：使用delete方法删除all_message</span><br><span class="line"></span><br><span class="line">all_message.delete()</span><br><span class="line"></span><br><span class="line">    for message in all_message:</span><br><span class="line">        # 删除取到的message对象</span><br><span class="line">        message.detele()</span><br><span class="line">        # print message.name</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>点击run并访问：<a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=http://127.0.0.1:8000/form/">http://127.0.0.1:8000/form/</a><br>进入Navicat进行验证。</p>
<h2 id="django-url-templates配置"><a href="#django-url-templates配置" class="headerlink" title="django url templates配置"></a>django url templates配置</h2><p>本节将介绍url的配置，以及如何将数据库数据填充回前台html页面。</p>
<p>情景：只允许用户修改<code>wlk</code>，如果没有就添加，如果有就回填使用户可以修改。</p>
<h3 id="取出数据"><a href="#取出数据" class="headerlink" title="取出数据"></a>取出数据</h3><p>message/views.py中的getform方法中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">message &#x3D; None</span><br><span class="line">all_message &#x3D; UserMessage.objects.filter(name&#x3D;&#39;wlk&#39;, address&#x3D;&#39;合肥&#39;)</span><br><span class="line"></span><br><span class="line"># if 判断是否存在数据</span><br><span class="line">if all_message:</span><br><span class="line">    # all_message是一个list，可以使用切片。</span><br><span class="line">    message &#x3D; all_message[0]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里注意把前几节写的删除掉</p>
</blockquote>
<h3 id="将数据回填至html中"><a href="#将数据回填至html中" class="headerlink" title="将数据回填至html中"></a>将数据回填至html中</h3><h4 id="修改return-render"><a href="#修改return-render" class="headerlink" title="修改return render"></a>修改return render</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">return render(request, &#39;message_form.html&#39;,&#123;</span><br><span class="line">        &quot;my_message&quot; : message</span><br><span class="line">&#125;)   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里前面的”my_meassage”是我们可以自行命名的。会有一个<code>my_message</code>对象随着返回前端页面。</p>
</blockquote>
<h4 id="在前端页面中放入值。"><a href="#在前端页面中放入值。" class="headerlink" title="在前端页面中放入值。"></a>在前端页面中放入值。</h4><p>为input系列标签添加<code>value</code>: 使用<code>my_message.name</code>取到我们传递过来的<code>my_message</code>对象的属性值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;input id&#x3D;&quot;name&quot; type&#x3D;&quot;text&quot; name&#x3D;&quot;name&quot;  </span><br><span class="line">value&#x3D;&quot;&#123;&#123; my_message.name &#125;&#125;&quot; class&#x3D;&quot;error&quot; placeholder&#x3D;&quot;请输入您的姓名&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>请自行完成姓名，邮箱，联系地址三个<code>input</code>标签。</p>
</blockquote>
<p>为<code>textarea</code>标签添加值</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/67.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;textarea id&#x3D;&quot;message&quot; name&#x3D;&quot;message&quot;  </span><br><span class="line">placeholder&#x3D;&quot;请输入你的建议&quot;&gt;&#123;&#123; my_message.message &#125;&#125;&lt;&#x2F;textarea&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行项目，访问。</p>
<blockquote>
<p>成功！！我们已经将后台数据库数据成功展示到前台。</p>
</blockquote>
<h3 id="template模板渲染中的一些用法。"><a href="#template模板渲染中的一些用法。" class="headerlink" title="template模板渲染中的一些用法。"></a>template模板渲染中的一些用法。</h3><blockquote>
<p>在我们的template模板中也就是form.html中，不允许我们写Python的语法，<br>它提供了一套自己的内建标签。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=https://docs.djangoproject.com/en/2.0/ref/templates/builtins/">官方文档中template内建标签用法传送门</a></p>
<h4 id="常用的几种模板标签介绍："><a href="#常用的几种模板标签介绍：" class="headerlink" title="常用的几种模板标签介绍："></a>常用的几种模板标签介绍：</h4><h5 id="if-else"><a href="#if-else" class="headerlink" title="if - else"></a><code>if - else</code></h5><p>官方提供模板如下：</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/68.png"></p>
<p>不满足if：如改为<code>my_message.name == &quot;wlk1</code>运行结果：</p>
<h5 id="ifequal-amp-ifnotequal"><a href="#ifequal-amp-ifnotequal" class="headerlink" title="ifequal &amp; ifnotequal"></a><code>ifequal</code> &amp; <code>ifnotequal</code></h5><p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/70.png"></p>
<p>官方文档解释：<code>ifequal a b</code> 相当于<code>f a == b</code>.<code>ifnotequal</code>则相当于<code>if a != b</code></p>
<h5 id="slice"><a href="#slice" class="headerlink" title="slice"></a>slice</h5><p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/71.png"></p>
<h3 id="URl的别名设置技巧"><a href="#URl的别名设置技巧" class="headerlink" title="URl的别名设置技巧"></a>URl的别名设置技巧</h3><p>DjangoGetStarted/urls.py：</p>
<p>为<code>r&#39;^form/$&#39;</code>添加别名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(r&#39;^form&#x2F;$&#39;, getform, name &#x3D; &quot;form_new&quot;)</span><br></pre></td></tr></table></figure>

<p>前往html中修改action地址为下面所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action&#x3D;&quot;&#123;% url &quot;form_new&quot; %&#125;&quot; method&#x3D;&quot;post&quot; class&#x3D;&quot;smart-green&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>这时我们如果改动urls.py中的<code>r&#39;^form/$&#39;</code>不需要再修改前端代码中值。</p>
<h3 id="url先后顺序问题"><a href="#url先后顺序问题" class="headerlink" title="url先后顺序问题"></a>url先后顺序问题</h3><p><strong>注意</strong>url匹配规则中一定不要忘记<code>/$</code>符号代表以<code>form/</code>结束的才会有效。不会向后继续匹配。比如没有<code>/$</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">url(r&#39;^form&#39;, getform, name&#x3D;&quot;form_new&quot;)</span><br></pre></td></tr></table></figure>

<p>这时我们进入浏览器访问时输入<code>http://127.0.0.1:8000/formemmm</code>都可以被响应。</p>
<p>特别是如果底下还配置有被这个规则包含的条目，会产生被写在更靠前的拦截住得不到正确处理的Bug。</p>
<blockquote>
<p>上图我们是想要让formtest响应admin.site.urls。但是会被form提前拦截住。</p>
</blockquote>
<p>所以我们一定要注意加上<code>/$</code>符号。</p>
<h1 id="完成Django的app设计-amp-完成app中的models设计"><a href="#完成Django的app设计-amp-完成app中的models设计" class="headerlink" title="完成Django的app设计 &amp;  完成app中的models设计"></a><center>完成Django的app设计 &amp;  完成app中的models设计</center></h1><p>直接通过Python3.6和django最新版本来开发我们的系统的一些注意事项。</p>
<p>原版本: Python 2.7 &amp; django 1.9.8<br>现在版本：Python 3.6 &amp; django 1.11</p>
<p>直接从3.6上手，开始工作，而不用做完2.7再转换。</p>
<blockquote>
<p>代码几乎100%兼容2.7 &amp; 3.6</p>
</blockquote>
<h3 id="虚拟环境问题"><a href="#虚拟环境问题" class="headerlink" title="虚拟环境问题"></a>虚拟环境问题</h3><blockquote>
<p>Python2.7 与 Python3.x共存并创建虚拟环境。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkvirtualenv -p C:\...\python.exe mxonline</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="设计model的时候的-unicode-方法"><a href="#设计model的时候的-unicode-方法" class="headerlink" title="设计model的时候的__unicode__方法"></a>设计model的时候的<code>__unicode__</code>方法</h3><p>Python2.7 中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def __unicode__:</span><br><span class="line">    return self.name</span><br></pre></td></tr></table></figure>

<p>Python 3.x中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def __str__(self):</span><br><span class="line">    return self.name</span><br></pre></td></tr></table></figure>

<blockquote>
<p>3.x下重载Unicode不会报错，但是会在后台显示有问题。</p>
</blockquote>
<h3 id="安装Python的mysql驱动时不能用之前的-MYSQL-python"><a href="#安装Python的mysql驱动时不能用之前的-MYSQL-python" class="headerlink" title="安装Python的mysql驱动时不能用之前的 MYSQL python"></a>安装Python的mysql驱动时不能用之前的 MYSQL python</h3><blockquote>
<p>这个网址是windows下python包安装的居家必备良品，建议收藏。</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=https://www.lfd.uci.edu/~gohlke/pythonlibs/%23mysql-python">https://www.lfd.uci.edu/~gohlke/pythonlibs/#mysql-python</a></p>
<p>应该改用<code>Mysqlclient</code>来替换我们的<code>MySQl-python</code></p>
<blockquote>
<p>接口是一样的。所以以后建议直接用Mysqlclient，因为它2, 3版本都有。</p>
</blockquote>
<h3 id="通过源码方式安装xadmin时。"><a href="#通过源码方式安装xadmin时。" class="headerlink" title="通过源码方式安装xadmin时。"></a>通过源码方式安装xadmin时。</h3><blockquote>
<p>Github 搜索 mxonline_resources，将里面的Xadmin放进extras_apps中。<br>就不用官方的了。</p>
</blockquote>
<blockquote>
<p>也可以直接使用官方的新版，已经支持了Python3.6</p>
</blockquote>
<p>Xadmin安装一定要安装依赖包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">django-crispy-forms~&#x3D;1.6.0</span><br><span class="line">django-import-export&gt;&#x3D;0.5.1</span><br><span class="line">django-reversion~&#x3D;2.0.0</span><br><span class="line">django-formtools</span><br><span class="line">future&#x3D;&#x3D;0.15.2</span><br><span class="line">httplib2&#x3D;&#x3D;0.9.2</span><br><span class="line">six&#x3D;&#x3D;1.10.0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="使用DjangoUeditor"><a href="#使用DjangoUeditor" class="headerlink" title="使用DjangoUeditor"></a>使用DjangoUeditor</h3><p>官方的不支持Python3, 去mxonline_resource目录下载兼容Python3的版本。<br>放入<code>extras_apps</code></p>
<h2 id="4-2-django-app-设计"><a href="#4-2-django-app-设计" class="headerlink" title="4-2 django-app 设计"></a>4-2 django-app 设计</h2><blockquote>
<p>数据库设计</p>
</blockquote>
<h3 id="根据app设计-models"><a href="#根据app设计-models" class="headerlink" title="根据app设计 models"></a>根据app设计 models</h3><h3 id="数据表生成与修改"><a href="#数据表生成与修改" class="headerlink" title="数据表生成与修改"></a>数据表生成与修改</h3><p>授课机构提供讲师录制课程，学员完成在线学习。</p>
<ul>
<li>全局头部：用户消息 &amp; 个人中心: 没有登录时，就是登录注册</li>
<li>对于公开课，授课讲师，授课机构进行搜索。</li>
<li>轮播图，课程，机构，页脚</li>
<li>公开课：分页公开课，右边热门推荐。</li>
<li>点进课程：课程详情页。详情: 后台富文本。右边是课程机构的介绍。收藏 或学习</li>
<li>章节信息 &amp; 课程资源下载 &amp; 评论</li>
<li>授课讲师: 授课讲师列表页, 讲师排行榜。分页。</li>
<li>点进讲师: 看到课程。</li>
<li>授课机构: 类别筛选，机构性质，所在地区 &amp; 排序。用户提交表单，我要学习, 机构排名.</li>
<li>个人中心: 修改密码, 修改头像, 个人信息, 我的课程, 我的收藏, 我的消息。</li>
</ul>
<p>app大致会有<code>用户模块</code>,<code>课程模块</code>,<code>授课教师</code>与<code>授课机构</code>。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/72.png"></p>
<p>多一个operation app 是因为数据库的需要。后面会讲。</p>
<h2 id="4-3-新建项目"><a href="#4-3-新建项目" class="headerlink" title="4-3 新建项目"></a>4-3 新建项目</h2><h3 id="Python2-7-创建虚拟环境。"><a href="#Python2-7-创建虚拟环境。" class="headerlink" title="Python2.7 创建虚拟环境。"></a>Python2.7 创建虚拟环境。</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkvirtualenv mxonline2</span><br></pre></td></tr></table></figure>

<p>安装django</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django&#x3D;&#x3D;1.9.8 </span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意Python2下此处必须用1.9.8</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/73.png" alt="img"></p>
<h3 id="Python3-x-创建虚拟环境"><a href="#Python3-x-创建虚拟环境" class="headerlink" title="Python3.x 创建虚拟环境"></a>Python3.x 创建虚拟环境</h3><p>如果你已经通过我的博文《Python开发环境搭建指南(Anaconda2,3共存)》<br>搭建了完美的共存环境使用下面命令创建虚拟环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkvirtualenv -p D:\softEnvDown\Anaconda2\envs\py3\python.exe mxonline3</span><br></pre></td></tr></table></figure>

<blockquote>
<p>-p后面路径为自己的Python3的exe文件路径。</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/74.png" alt="img"></p>
<blockquote>
<p>官方说明的最新稳定版为2.0.1(2018-01-08 19:37:06)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">workon mxonline3</span><br><span class="line">pip install django&#x3D;&#x3D;2.0.1</span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/75.png" alt="img"></p>
<p>至此我们的两个虚拟环境都已经准备好了。</p>
<h3 id="新建Python2-下Project"><a href="#新建Python2-下Project" class="headerlink" title="新建Python2 下Project"></a>新建Python2 下Project</h3><p>为Mxonline2 配置环境 <code>mxonline2</code></p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/76.png" alt="img"></p>
<p>注意一直定位到Python.exe。</p>
<h4 id="安装mysql驱动。"><a href="#安装mysql驱动。" class="headerlink" title="安装mysql驱动。"></a>安装mysql驱动。</h4><p>下载<a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=https://www.lfd.uci.edu/~gohlke/pythonlibs/%23mysql-python">https://www.lfd.uci.edu/~gohlke/pythonlibs/#mysql-python</a>中<br>mysqlclient‑1.3.12‑cp34‑cp34m‑win_amd64.whl进行本地安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">workon mxonline2</span><br><span class="line">pip install mysqlclient-1.3.12-cp27-cp27m-win_amd64.whl</span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/77.png" alt="img"></p>
<h3 id="新建Python3-下Project"><a href="#新建Python3-下Project" class="headerlink" title="新建Python3 下Project"></a>新建Python3 下Project</h3><p>为Mxonline3 配置环境 <code>mxonline3</code></p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/78.png" alt="img"></p>
<blockquote>
<p>注意一直定位到Python.exe。</p>
</blockquote>
<h4 id="安装mysql驱动。-1"><a href="#安装mysql驱动。-1" class="headerlink" title="安装mysql驱动。"></a>安装mysql驱动。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">workon mxonline3</span><br><span class="line">pip install mysqlclient</span><br></pre></td></tr></table></figure>

<h3 id="setting中配置"><a href="#setting中配置" class="headerlink" title="setting中配置"></a>setting中配置</h3><p>Mxonline2/settings.py:<br>Mxonline3/settings.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DATABASES &#x3D; &#123;</span><br><span class="line">    &#39;default&#39;: &#123;</span><br><span class="line">        &#39;ENGINE&#39;: &#39;django.db.backends.mysql&#39;,</span><br><span class="line">        &#39;NAME&#39;: &#39;mxonline2&#39;,</span><br><span class="line">        &#39;USER&#39;: &#39;root&#39;,</span><br><span class="line">        &#39;PASSWORD&#39;: &#39;你的密码&#39;,</span><br><span class="line">        &#39;HOST&#39;:&#39;127.0.0.1&#39;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DATABASES &#x3D; &#123;</span><br><span class="line">    &#39;default&#39;: &#123;</span><br><span class="line">        &#39;ENGINE&#39;: &#39;django.db.backends.mysql&#39;,</span><br><span class="line">        &#39;NAME&#39;: &#39;mxonline3&#39;,</span><br><span class="line">        &#39;USER&#39;: &#39;root&#39;,</span><br><span class="line">        &#39;PASSWORD&#39;: &#39;你的密码&#39;,</span><br><span class="line">        &#39;HOST&#39;:&#39;127.0.0.1&#39;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="前往Navicat新建数据库"><a href="#前往Navicat新建数据库" class="headerlink" title="前往Navicat新建数据库"></a>前往Navicat新建数据库</h3><p>mxonline2 &amp; mxonline3</p>
<h4 id="进行数据库初始化makemigrations"><a href="#进行数据库初始化makemigrations" class="headerlink" title="进行数据库初始化makemigrations"></a>进行数据库初始化makemigrations</h4><p>点击<code>Tools 菜单下 Run manage.py Task</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>2,3操作一致</p>
</blockquote>
<p>点击 RUn edit</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/79.png" alt="img"></p>
<p>可以为2,3配置不同的port。比如2: 8002 &amp; 3: 8003</p>
<p>2: 点击run运行: django1.9.8成功画面如下。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/80.png" alt="img"></p>
<p>3: 点击run运行: django2.0.1成功画面如下。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/81.png" alt="img"></p>
<p>这时我们的项目就新建成功。</p>
<p>此处对应commit:</p>
<blockquote>
<p>项目初始化成功: 完成数据库Migration初始化。 对应4-3</p>
</blockquote>
<h2 id="4-4-自定义userprofile"><a href="#4-4-自定义userprofile" class="headerlink" title="4-4 自定义userprofile"></a>4-4 自定义userprofile</h2><p>点击<code>Tools 菜单下 Run manage.py Task</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">startapp users</span><br></pre></td></tr></table></figure>

<h3 id="编写我们的model设计user表。"><a href="#编写我们的model设计user表。" class="headerlink" title="编写我们的model设计user表。"></a>编写我们的model设计user表。</h3><p>系统自动生成的user表如下:</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/86.png" alt="img"></p>
<p>mark</p>
<ul>
<li>id: 主键, password 密码, last_login Django自动记录用户最后登录时间,。</li>
<li>is_superuser 表明用户是否是超级用户(后台管理会用到)。</li>
<li>username 用户名字段不要随便改动, email 邮箱,</li>
<li>is_staff 表示是否是员工(后台管理会用到)。</li>
<li>is_active 用户是否是激活状态, date_joined 注册时间。</li>
</ul>
<blockquote>
<p>我们需要扩展我们自己的需求字段。</p>
</blockquote>
<p>个人中心页面中:</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/87.png"></p>
<p>可以看到我们还需要的有：</p>
<ul>
<li>昵称: nickname</li>
<li>生日: birthday</li>
<li>性别: gender</li>
</ul>
<p>User表的自定义方法可以查看django官方文档。<br>我们既想保留原有字段，又想有新字段。</p>
<p>users/models.py添加代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">from django.contrib.auth.models import AbstractUser</span><br><span class="line"></span><br><span class="line">class UserProfile(AbstractUser):</span><br><span class="line">    # 自定义的性别选择规则</span><br><span class="line">    GENDER_CHOICES &#x3D; (</span><br><span class="line">        (&quot;male&quot;, u&quot;男&quot;),</span><br><span class="line">        (&quot;female&quot;, u&quot;女&quot;)</span><br><span class="line">    )</span><br><span class="line">    # 昵称</span><br><span class="line">    nick_name &#x3D; models.CharField(max_length&#x3D;50, verbose_name&#x3D;u&quot;昵称&quot;, default&#x3D;&quot;&quot;)</span><br><span class="line">    # 生日，可以为空</span><br><span class="line">    birthday &#x3D; models.DateField(verbose_name&#x3D;u&quot;生日&quot;, null&#x3D;True, blank&#x3D;True)</span><br><span class="line">    # 性别 只能男或女，默认女</span><br><span class="line">    gender &#x3D; models.CharField(</span><br><span class="line">        max_length&#x3D;5,</span><br><span class="line">        verbose_name&#x3D;u&quot;性别&quot;,</span><br><span class="line">        choices&#x3D;GENDER_CHOICES,</span><br><span class="line">        default&#x3D;&quot;female&quot;)</span><br><span class="line">    # 地址</span><br><span class="line">    address &#x3D; models.CharField(max_length&#x3D;100, verbose_name&#x3D;&quot;地址&quot;, default&#x3D;&quot;&quot;)</span><br><span class="line">    # 电话</span><br><span class="line">    mobile &#x3D; models.CharField(max_length&#x3D;11, null&#x3D;True, blank&#x3D;True)</span><br><span class="line">    # 头像 默认使用default.png</span><br><span class="line">    image &#x3D; models.ImageField(</span><br><span class="line">        upload_to&#x3D;&quot;image&#x2F;%Y&#x2F;%m&quot;,</span><br><span class="line">        default&#x3D;u&quot;image&#x2F;default.png&quot;,</span><br><span class="line">        max_length&#x3D;100</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    # meta信息，即后台栏目名</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; &quot;用户信息&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line">    # 重载Unicode方法，打印实例会打印username，username为继承自abstractuser</span><br><span class="line">    def __unicode__(self):</span><br><span class="line">        return self.username</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>点进<code>AbstractUser</code>可以看到这个models里面就有我们默认表的那些字段。</p>
<p>因为Image字段需要用到<code>pillow</code>所以需要安装该库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install pillow</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>注意：CharField必须有max_length, Imagefield实际也是charfield所以也要有max_length</strong></p>
<h4 id="setting设置INSTALLED-APPS-amp-AUTH-USER-MODEL。"><a href="#setting设置INSTALLED-APPS-amp-AUTH-USER-MODEL。" class="headerlink" title="setting设置INSTALLED_APPS &amp; AUTH_USER_MODEL。"></a>setting设置INSTALLED_APPS &amp; AUTH_USER_MODEL。</h4><ul>
<li>INSTALLED_APPS注册app</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#39;users&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>重载AUTH_USER_MODEL</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 此处重载是为了使我们的UserProfile生效</span><br><span class="line">AUTH_USER_MODEL &#x3D; &quot;users.UserProfile&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/88.png"></p>
<p>点击<code>Tools 菜单下 Run manage.py Task</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">makemigrations users</span><br><span class="line">migrate users</span><br></pre></td></tr></table></figure>

<blockquote>
<p>上图中可以看到数据库做出的改动。输入: yes</p>
</blockquote>
<h3 id="进入Navicat进行验证"><a href="#进入Navicat进行验证" class="headerlink" title="进入Navicat进行验证"></a>进入Navicat进行验证</h3><p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/84.png" alt="img"></p>
<p>如上图可以看到我们的表已经生成成功。</p>
<h3 id="附加Python3下不同与报错："><a href="#附加Python3下不同与报错：" class="headerlink" title="附加Python3下不同与报错："></a>附加Python3下不同与报错：</h3><p>将Unicode方法改为str方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 重载__str__方法，打印实例会打印username，username为继承自AbstractUser</span><br><span class="line">def __str__(self):</span><br><span class="line">    return self.username</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">django.db.migrations.exceptions.InconsistentMigrationHistory: Migration</span><br><span class="line">admin.0001_initial is applied before its dependency users.0001_initial on</span><br><span class="line">database &#39;default&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解决方案:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">删除数据库中 除了auth_user的其他表</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后执行命令:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br><span class="line">makemigrations users</span><br><span class="line">migrate users</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/85.png" alt="img"></p>
<blockquote>
<p>共11张表，同期django1.9.8会产生13张表</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/86.png%5D" alt="img"></p>
<blockquote>
<p>我推测是因为在django2.0版本中。我们如果自定义了userProfile并且在setting中进行了设置。那么auth_user将不再拥有多的表。</p>
</blockquote>
<p>下次不要再初始化时执行makemigrations &amp; migrate。当我们设计userProfile完成之后再执行。</p>
<p>本小节完成对应commit:</p>
<blockquote>
<p>完成USerProfile models书写。makemigrations &amp; migrate 建表成功。对应4-4</p>
</blockquote>
<h2 id="4-5-user-modesl-py设计"><a href="#4-5-user-modesl-py设计" class="headerlink" title="4-5 user modesl.py设计"></a>4-5 user modesl.py设计</h2><p>循环引用:</p>
<blockquote>
<p>设计app时每个app都有model</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/89.png" alt="img"></p>
<p>如图：我们在user中定义usercourse记录用户学习的课程。会有两个外键：user和course。<br>我们就会<code>import Courses.models</code></p>
<p>如果用户对课程的评论：会放在 <code>Courses.models</code>当中。评论我们需要保存相应的用户。<br>我们就会<code>import User.models</code></p>
<p>循环import会出错。a与b相互调用，造成等待。</p>
<h3 id="解决循环引用-分层设计"><a href="#解决循环引用-分层设计" class="headerlink" title="解决循环引用: 分层设计"></a>解决循环引用: 分层设计</h3><p>目前已有app：users courses organization</p>
<p>另外一个app高于这些app的层级。<code>operation</code>.上一层app可以import下层的app。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/90.png" alt="img"></p>
<p>上节中: 自定义<code>userprofile</code> 覆盖默认<code>user</code>表</p>
<p>user中还需要添加的(前提是这些功能比较独立):</p>
<ul>
<li>EmailVerifyRecord - 邮箱验证码</li>
<li>PageBanner - 轮播图</li>
</ul>
<p>观察轮播图:</p>
<blockquote>
<ol>
<li>图片 2. 点击图片地址 3. 轮播图序号(控制前后)</li>
</ol>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/91.png" alt="img"></p>
<p>users/models.py中添加代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">from datetime import datetime</span><br><span class="line"></span><br><span class="line"># 邮箱验证码model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class EmailVerifyRecord(models.Model):</span><br><span class="line">    SEND_CHOICES &#x3D; (</span><br><span class="line">        (&quot;register&quot;, u&quot;注册&quot;),</span><br><span class="line">        (&quot;forget&quot;, u&quot;找回密码&quot;)</span><br><span class="line">    )</span><br><span class="line">    code &#x3D; models.CharField(max_length&#x3D;20, verbose_name&#x3D;u&quot;验证码&quot;)</span><br><span class="line">    # 未设置null &#x3D; true blank &#x3D; true 默认不可为空</span><br><span class="line">    email &#x3D; models.EmailField(max_length&#x3D;50, verbose_name&#x3D;u&quot;邮箱&quot;)</span><br><span class="line">    send_type &#x3D; models.CharField(choices&#x3D;SEND_CHOICES, max_length&#x3D;10)</span><br><span class="line">    # 这里的now得去掉(),不去掉会根据编译时间。而不是根据实例化时间。</span><br><span class="line">    send_time &#x3D; models.DateTimeField(default&#x3D;datetime.now)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; &quot;邮箱验证码&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line"># 轮播图model</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Banner(models.Model):</span><br><span class="line">    title &#x3D; models.CharField(max_length&#x3D;100, verbose_name&#x3D;u&quot;标题&quot;)</span><br><span class="line">    image &#x3D; models.ImageField(</span><br><span class="line">        upload_to&#x3D;&quot;banner&#x2F;%Y&#x2F;%m&quot;,</span><br><span class="line">        verbose_name&#x3D;u&quot;轮播图&quot;,</span><br><span class="line">        max_length&#x3D;100)</span><br><span class="line">    url &#x3D; models.URLField(max_length&#x3D;200, verbose_name&#x3D;u&quot;访问地址&quot;)</span><br><span class="line">    # 默认index很大靠后。想要靠前修改index值。</span><br><span class="line">    index &#x3D; models.IntegerField(default&#x3D;100, verbose_name&#x3D;u&quot;顺序&quot;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;添加时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;轮播图&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>从上往下: 第一块区域import官方包，第二块import第三方。(PEP8)</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/92.png" alt="img"></p>
<p>如下图: 我们一共创建了三个数据表: Structure可以查看到</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/93.png" alt="img"></p>
<blockquote>
<p>与用户相关的评论啊，点赞啊。学习的课程啊并没有放进来，因为那些独立性不高。<br>容易产生循环引用。我们把那些放到operation中。</p>
</blockquote>
<p>本小节完成，对应commit:</p>
<h2 id="4-6-course-models-py编写"><a href="#4-6-course-models-py编写" class="headerlink" title="4-6 course models.py编写"></a>4-6 course models.py编写</h2><p>点击 <code>Tools 菜单下 Run manage.py Task</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">startapp courses</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>course中需要那些表:</p>
<ul>
<li>课程本身需要一张表</li>
</ul>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/94.png" alt="img"></p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/95.png" alt="img"></p>
<p>mark</p>
<ul>
<li>点进去之后点击开始学习。</li>
<li>课程基本信息需要一张表, 章节表与课程表存在(一个课程对应多个章节)</li>
<li>章节表中：章节的名称。 章节与视频(一个章节对应多个视频)</li>
</ul>
<p>结构: 课程本身–(一对多)&gt;章节-(一对多)-&gt;视频信息</p>
<p>资源下载放在课程里面的。一个课程对应多个资源</p>
<p>共四张表：课程本身–(一对多)&gt;章节-(一对多)-&gt;视频信息 &amp; 资源表</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/96.png" alt="img"></p>
<p>courses/models.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">from datetime import datetime</span><br><span class="line"></span><br><span class="line"># 课程信息表</span><br><span class="line">class Course(models.Model):</span><br><span class="line">    DEGREE_CHOICES &#x3D; (</span><br><span class="line">        (&quot;cj&quot;, u&quot;初级&quot;),</span><br><span class="line">        (&quot;zj&quot;, u&quot;中级&quot;),</span><br><span class="line">        (&quot;gj&quot;, u&quot;高级&quot;)</span><br><span class="line">    )</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;50, verbose_name&#x3D;u&quot;课程名&quot;)</span><br><span class="line">    desc &#x3D; models.CharField(max_length&#x3D;300, verbose_name&#x3D;u&quot;课程描述&quot;)</span><br><span class="line">    # TextField允许我们不输入长度。可以输入到无限大。暂时定义为TextFiled，之后更新为富文本</span><br><span class="line">    detail &#x3D; models.TextField(verbose_name&#x3D;u&quot;课程详情&quot;)</span><br><span class="line">    degree &#x3D; models.CharField(choices&#x3D;DEGREE_CHOICES, max_length&#x3D;2)</span><br><span class="line">    # 使用分钟做后台记录(存储最小单位)前台转换</span><br><span class="line">    learn_times &#x3D; models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;学习时长(分钟数)&quot;)</span><br><span class="line">    # 保存学习人数:点击开始学习才算</span><br><span class="line">    students &#x3D; models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;学习人数&quot;)</span><br><span class="line">    fav_nums &#x3D; models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;收藏人数&quot;)</span><br><span class="line">    image &#x3D; models.ImageField(</span><br><span class="line">        upload_to&#x3D;&quot;courses&#x2F;%Y&#x2F;%m&quot;,</span><br><span class="line">        verbose_name&#x3D;u&quot;封面图&quot;,</span><br><span class="line">        max_length&#x3D;100)</span><br><span class="line">    # 保存点击量，点进页面就算</span><br><span class="line">    click_nums &#x3D; models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;点击数&quot;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;添加时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;课程&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面来编写章节 &amp; 视频 &amp; 课程资源:<code>courses/models.py</code></p>
<p>一对多, 多对一都可以使用django的外键来完成。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"># 章节</span><br><span class="line">class Lesson(models.Model):</span><br><span class="line">    # 因为一个课程对应很多章节。所以在章节表中将课程设置为外键。</span><br><span class="line">    # 作为一个字段来让我们可以知道这个章节对应那个课程</span><br><span class="line">    course &#x3D; models.ForeignKey(Course, verbose_name&#x3D;u&quot;课程&quot;)</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;100, verbose_name&#x3D;u&quot;章节名&quot;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;添加时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;章节&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 每章视频</span><br><span class="line">class Video(models.Model):</span><br><span class="line">    # 因为一个章节对应很多视频。所以在视频表中将章节设置为外键。</span><br><span class="line">    # 作为一个字段来存储让我们可以知道这个视频对应哪个章节.</span><br><span class="line">    lesson &#x3D; models.ForeignKey(Lesson, verbose_name&#x3D;u&quot;章节&quot;)</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;100, verbose_name&#x3D;u&quot;视频名&quot;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;添加时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;视频&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 课程资源</span><br><span class="line">class CourseResource(models.Model):</span><br><span class="line">    # 因为一个课程对应很多资源。所以在课程资源表中将课程设置为外键。</span><br><span class="line">    # 作为一个字段来让我们可以知道这个资源对应那个课程</span><br><span class="line">    course &#x3D; models.ForeignKey(Course, verbose_name&#x3D;u&quot;课程&quot;)</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;100, verbose_name&#x3D;u&quot;名称&quot;)</span><br><span class="line">    # 这里定义成文件类型的field，后台管理系统中会直接有上传的按钮。</span><br><span class="line">    # FileField也是一个字符串类型，要指定最大长度。</span><br><span class="line">    download &#x3D; models.FileField(</span><br><span class="line">        upload_to&#x3D;&quot;course&#x2F;resource&#x2F;%Y&#x2F;%m&quot;,</span><br><span class="line">        verbose_name&#x3D;u&quot;资源文件&quot;,</span><br><span class="line">        max_length&#x3D;100)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;添加时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;课程资源&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过Structure可以看到我们刚才设计的四张表</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/97.png" alt="img"></p>
<p>本小节完毕, 对应commit:</p>
<h2 id="4-7-organization-modesl-py设计"><a href="#4-7-organization-modesl-py设计" class="headerlink" title="4-7 organization modesl.py设计"></a>4-7 organization modesl.py设计</h2><p>新建课程机构app:</p>
<p>点击<code>Tools 菜单下 Run manage.py Task</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">startapp organization</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>课程是属于机构的, 机构有机构类别，城市等字段。讲师实体。<br>我要学习的提交表单会与用户关联，存放在机构。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/98.png" alt="img"></p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/99.png" alt="img"></p>
<p>其中课程数，学习人数可以动态统计。机构地址，机构经典课程。</p>
<blockquote>
<p>机构讲师，机构课程可以通过外键获取到, 不保存到机构中。</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/100.png" alt="img"></p>
<blockquote>
<p>讲师大概所需要的字段如图所示。</p>
</blockquote>
<p>organization/models.py 代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"># encoding : utf-8</span><br><span class="line">from datetime import datetime</span><br><span class="line"></span><br><span class="line">from django.db import models</span><br><span class="line"></span><br><span class="line"># Create your models here.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 城市字典</span><br><span class="line">class CityDict(models.Model):</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;20, verbose_name&#x3D;u&quot;城市&quot;)</span><br><span class="line">    # 城市描述：备用不一定展示出来</span><br><span class="line">    desc &#x3D; models.CharField(max_length&#x3D;200, verbose_name&#x3D;u&quot;描述&quot;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;添加时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;城市&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 课程机构</span><br><span class="line">class CourseOrg(models.Model):</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;50, verbose_name&#x3D;u&quot;机构名称&quot;)</span><br><span class="line">    # 机构描述，后面会替换为富文本展示</span><br><span class="line">    desc &#x3D; models.TextField(verbose_name&#x3D;u&quot;机构描述&quot;)</span><br><span class="line">    click_nums &#x3D; models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;点击数&quot;)</span><br><span class="line">    fav_nums &#x3D; models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;收藏数&quot;)</span><br><span class="line">    image &#x3D; models.ImageField(</span><br><span class="line">        upload_to&#x3D;&quot;org&#x2F;%Y&#x2F;%m&quot;,</span><br><span class="line">        verbose_name&#x3D;u&quot;封面图&quot;,</span><br><span class="line">        max_length&#x3D;100)</span><br><span class="line">    address &#x3D; models.CharField(max_length&#x3D;150, verbose_name&#x3D;u&quot;机构地址&quot;)</span><br><span class="line">    # 一个城市可以有很多课程机构，通过将city设置外键，变成课程机构的一个字段</span><br><span class="line">    # 可以让我们通过机构找到城市</span><br><span class="line">    city &#x3D; models.ForeignKey(CityDict, verbose_name&#x3D;u&quot;所在城市&quot;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;添加时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;课程机构&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 讲师</span><br><span class="line">class Teacher(models.Model):</span><br><span class="line">    # 一个机构会有很多老师，所以我们在讲师表添加外键并把课程机构名称保存下来</span><br><span class="line">    # 可以使我们通过讲师找到对应的机构</span><br><span class="line">    org &#x3D; models.ForeignKey(CourseOrg, verbose_name&#x3D;u&quot;所属机构&quot;)</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;50, verbose_name&#x3D;u&quot;教师名称&quot;)</span><br><span class="line">    work_years &#x3D; models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;工作年限&quot;)</span><br><span class="line">    work_company &#x3D; models.CharField(max_length&#x3D;50, verbose_name&#x3D;u&quot;就职公司&quot;)</span><br><span class="line">    work_position &#x3D; models.CharField(max_length&#x3D;50, verbose_name&#x3D;u&quot;公司职位&quot;)</span><br><span class="line">    points &#x3D; models.CharField(max_length&#x3D;50, verbose_name&#x3D;u&quot;教学特点&quot;)</span><br><span class="line">    click_nums &#x3D; models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;点击数&quot;)</span><br><span class="line">    fav_nums &#x3D; models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;收藏数&quot;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;添加时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;教师&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/101.png" alt="img"></p>
<p>mark</p>
<blockquote>
<p>可以看到我们一共创建了三张表：分别是城市，课程机构，讲师。</p>
</blockquote>
<p>本小节对应commit:</p>
<blockquote>
<p>课程机构app：城市，机构，讲师表书写完毕。对应4-7</p>
</blockquote>
<h2 id="4-8-operation-models-py设计"><a href="#4-8-operation-models-py设计" class="headerlink" title="4-8 operation models.py设计"></a>4-8 operation models.py设计</h2><p>分析需要那些表:</p>
<ul>
<li>用户可以提交我要学习的个人需求。</li>
<li>学员的课程评论信息</li>
<li>收藏：可以收藏公开课, 授课讲师, 授课机构, 用户消息提醒。</li>
<li>个人中心：我的课程说明用户和课程之间的学习关系也需要保存。</li>
</ul>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/102.png" alt="img"></p>
<p>新建操作app:</p>
<p>点击<code>Tools 菜单下 Run manage.py Task</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">startapp operation</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>operation/models.py添加代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from datetime import datetime</span><br><span class="line"></span><br><span class="line"># 引入我们CourseComments所需要的外键models</span><br><span class="line">from users.models import UserProfile</span><br><span class="line">from courses.models import Course</span><br><span class="line"></span><br><span class="line"># 用户我要学习表单</span><br><span class="line">class UserAsk(models.Model):</span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;20, verbose_name&#x3D;u&quot;姓名&quot;)</span><br><span class="line">    mobile &#x3D; models.CharField(max_length&#x3D;11, verbose_name&#x3D;u&quot;手机&quot;)</span><br><span class="line">    course_name &#x3D; models.CharField(max_length&#x3D;50, verbose_name&#x3D;u&quot;课程名&quot;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;添加时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;用户咨询&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 用户对于课程评论</span><br><span class="line">class CourseComments(models.Model):</span><br><span class="line"></span><br><span class="line">    # 会涉及两个外键: 1. 用户， 2. 课程。import进来</span><br><span class="line">    course &#x3D; models.ForeignKey(Course, verbose_name&#x3D;u&quot;课程&quot;)</span><br><span class="line">    user &#x3D; models.ForeignKey(UserProfile, verbose_name&#x3D;u&quot;用户&quot;)</span><br><span class="line">    comments &#x3D; models.CharField(max_length&#x3D;250, verbose_name&#x3D;u&quot;评论&quot;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;评论时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;课程评论&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 用户对于课程,机构，讲师的收藏</span><br><span class="line">class UserFavorite(models.Model):</span><br><span class="line">    # 会涉及四个外键。用户，课程，机构，讲师import</span><br><span class="line">    TYPE_CHOICES &#x3D; (</span><br><span class="line">        (1, u&quot;课程&quot;),</span><br><span class="line">        (2, u&quot;课程机构&quot;),</span><br><span class="line">        (3, u&quot;讲师&quot;)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    user &#x3D; models.ForeignKey(UserProfile, verbose_name&#x3D;u&quot;用户&quot;)</span><br><span class="line">    # course &#x3D; models.ForeignKey(Course, verbose_name&#x3D;u&quot;课程&quot;)</span><br><span class="line">    # teacher &#x3D; models.ForeignKey()</span><br><span class="line">    # org &#x3D; models.ForeignKey()</span><br><span class="line">    # fav_type &#x3D;</span><br><span class="line"></span><br><span class="line">    # 机智版</span><br><span class="line">    # 直接保存用户的id.</span><br><span class="line">    fav_id &#x3D; models.IntegerField(default&#x3D;0)</span><br><span class="line">    # 表明收藏的是哪种类型。</span><br><span class="line">    fav_type &#x3D; models.IntegerField(</span><br><span class="line">        choices&#x3D;TYPE_CHOICES,</span><br><span class="line">        default&#x3D;1,</span><br><span class="line">        verbose_name&#x3D;u&quot;收藏类型&quot;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;评论时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;用户收藏&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 用户消息表</span><br><span class="line">class UserMessage(models.Model):</span><br><span class="line">        # 因为我们的消息有两种:发给全员和发给某一个用户。</span><br><span class="line">        # 所以如果使用外键，每个消息会对应要有用户。很难实现全员消息。</span><br><span class="line"></span><br><span class="line">        # 机智版 为0发给所有用户，不为0就是发给用户的id</span><br><span class="line">    user &#x3D; models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;接收用户&quot;)</span><br><span class="line">    message &#x3D; models.CharField(max_length&#x3D;500, verbose_name&#x3D;u&quot;消息内容&quot;)</span><br><span class="line"></span><br><span class="line">    # 是否已读: 布尔类型 BooleanField False未读,True表示已读</span><br><span class="line">    has_read &#x3D; models.BooleanField(default&#x3D;False, verbose_name&#x3D;u&quot;是否已读&quot;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;添加时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;用户消息&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 用户课程表</span><br><span class="line">class UserCourse(models.Model):</span><br><span class="line">    # 会涉及两个外键: 1. 用户， 2. 课程。import进来</span><br><span class="line">    course &#x3D; models.ForeignKey(Course, verbose_name&#x3D;u&quot;课程&quot;)</span><br><span class="line">    user &#x3D; models.ForeignKey(UserProfile, verbose_name&#x3D;u&quot;用户&quot;)</span><br><span class="line">    add_time &#x3D; models.DateTimeField(default&#x3D;datetime.now, verbose_name&#x3D;u&quot;添加时间&quot;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; u&quot;用户课程&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>至此：我们的五张operation下的数据表models设计完成</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/103.png" alt="img"></p>
<h3 id="setting中配置添加app"><a href="#setting中配置添加app" class="headerlink" title="setting中配置添加app"></a>setting中配置添加app</h3><p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/104.png" alt="img"></p>
<h2 id="4-9-数据表生成以及apps目录建立"><a href="#4-9-数据表生成以及apps目录建立" class="headerlink" title="4-9 数据表生成以及apps目录建立"></a>4-9 数据表生成以及apps目录建立</h2><blockquote>
<p>学习如何通过刚才设计的models生成数据库对应的表</p>
</blockquote>
<p>点击<code>Tools 菜单下 Run manage.py Task</code>:</p>
<h3 id="Python2与Python3不同"><a href="#Python2与Python3不同" class="headerlink" title="Python2与Python3不同:"></a>Python2与Python3不同:</h3><p>Python2下可能会报一些<code>noASCII</code>错误:</p>
<p>只需要在对应你写了中文的第一行加上:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Python3-django2-0-1-会报错"><a href="#Python3-django2-0-1-会报错" class="headerlink" title="Python3(django2.0.1)会报错:"></a>Python3(django2.0.1)会报错:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org &#x3D; models.ForeignKey(CourseOrg, verbose_name&#x3D;u&quot;所属机构&quot;)</span><br><span class="line">TypeError: __init__() missing 1 required positional argument: &#39;on_delete&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>这是因为在2.0.1中，外键关系必须指明删除时的操作。</p>
</blockquote>
<p>比如：出租车都归属于出租车公司。如果出租车公司倒闭了，那这些汽车该怎么处理。<br>必须自己指明: 我觉得可以直接进行级联删除。</p>
<p>django提供了:</p>
<ul>
<li><code>CASCADE</code></li>
<li><code>PROTECT</code></li>
<li><code>SET_NULL</code></li>
<li><code>SET_DEFAULT</code></li>
</ul>
<p>等选项。我选择了<code>CASCADE</code>删除。</p>
<p>将(dajngo 2.0.1)项目中所有的外键修改为如下面代码所示：</p>
<blockquote>
<p>也就是添加了<code>on_delete=models.CASCADE</code>使其级联删除。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org &#x3D; models.ForeignKey(CourseOrg, on_delete&#x3D;models.CASCADE, verbose_name&#x3D;u&quot;所属机构&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="makemirgration-amp-migrate生成表"><a href="#makemirgration-amp-migrate生成表" class="headerlink" title="makemirgration &amp; migrate生成表"></a>makemirgration &amp; migrate生成表</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makemirgration</span><br><span class="line">migrate</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/106.png" alt="img"></p>
<p>上图为makemirgration过程中输出的信息。可以看到我们做出的改动</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/105.png" alt="img"></p>
<p>此时我们查看app目录中migrations文件夹可以看到产生的新文件。</p>
<p><code>operation/migrations/0001_initial.py:</code></p>
<blockquote>
<p>可以看到里面也是Python的语法。他会帮我们生成数据表。<br>以后每次<code>migrations</code>时都会生成新的initial文件。这是很重要的变动文件，不能随意删除。</p>
</blockquote>
<p>打开Navicat可以看到django的数据库中有它默认的django_migrations表</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/107.png" alt="img"></p>
<p>双击django_migrations表可以看到我们migration的记录。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/108.png" alt="img"></p>
<blockquote>
<p>会记录哪个app下的哪个initial.py已经运行了。</p>
</blockquote>
<p>进入Navicat进行成功性验证:</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/109.png" alt="img"></p>
<blockquote>
<p>可以看到我们的表已经生成成功,命名规则为: app名称 + 我们的类名变成小写</p>
</blockquote>
<h3 id="把我们的四个app放到一个文件夹下。"><a href="#把我们的四个app放到一个文件夹下。" class="headerlink" title="把我们的四个app放到一个文件夹下。"></a>把我们的四个app放到一个文件夹下。</h3><ul>
<li>新建Python的package: apps</li>
</ul>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/110.png" alt="img"></p>
<ul>
<li>把四个app都拖进apps中去。</li>
</ul>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/111.png" alt="img"></p>
<p>去掉<code>searchfor</code>的勾选。拖进去之后会报错，说找不到那些import的模块了。</p>
<p>解决方案：右键<code>Mark</code>为<code>sourceRoot</code>。根目录下找不到的，会去apps下搜索。</p>
<p>但是这时候cmd下还是会报错。</p>
<p>解决方案(图来源于我的<code>DjangoGetStarted</code>教程):</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/112.png" alt="img"></p>
<p>同理,插入第0是希望它先搜索我们app下东西：</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/113.png" alt="img"></p>
<h4 id="成功性验证"><a href="#成功性验证" class="headerlink" title="成功性验证"></a>成功性验证</h4><p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/114.png" alt="img"></p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/115.png" alt="img"></p>
<blockquote>
<p>可以看到Django已经可以正常run成功了。</p>
</blockquote>
<h3 id="第四章总结"><a href="#第四章总结" class="headerlink" title="第四章总结"></a>第四章总结</h3><ul>
<li>我们设计了app</li>
</ul>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/116.png" alt="img"></p>
<ul>
<li>设计了user models.py</li>
</ul>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/117.png" alt="img"></p>
<ul>
<li>循环引用</li>
</ul>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/118.png" alt="img"></p>
<blockquote>
<p>得出我们需要创建一个更高层次的app。分层设计，operation在更高层。</p>
</blockquote>
<ul>
<li>Courses models.py</li>
</ul>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/119.png" alt="img"></p>
<ul>
<li>organization models.py</li>
</ul>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/120.png" alt="img"></p>
<ul>
<li>operation models.py</li>
</ul>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/121.png" alt="img"></p>
<p>通过makemigrations 生成表的变动 &amp; migrate<br>每个app下的migration目录的用途，和数据库中django_migration<br>将所有app放到同一个目录之下。</p>
<h1 id="xadmin快速搭建可用的后台系统"><a href="#xadmin快速搭建可用的后台系统" class="headerlink" title=" xadmin快速搭建可用的后台系统"></a><center> xadmin快速搭建可用的后台系统</center></h1><h2 id="django-admin介绍"><a href="#django-admin介绍" class="headerlink" title="django admin介绍"></a>django admin介绍</h2><p>上一章我们进行了需求分析和数据库设计。本章我们来快速搭建一个可用的后台管理系统。</p>
<p>后台管理系统特点：</p>
<ul>
<li>权限管理</li>
<li>少前端样式。(样式一般不是很看重)，</li>
<li>快速开发</li>
</ul>
<p>django的后台管理系统是一套智能的管理系统。<br>django的杀手锏之一就是admin管理系统。</p>
<p>admin在项目新建时就已经为我们生成好了。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/122.png" alt="img"></p>
<p>Django的admin也是一个app，在我们新建项目时就创建好了。<br>而且会自动在url中配置好了链接。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/123.png" alt="img"></p>
<p>访问:<a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=http://127.0.0.1:8000/admin/">http://127.0.0.1:8000/admin/</a></p>
<p>可以看到admin的登录窗口。</p>
<p>Django是不会自动生成admin的用户的，需要我们自己去命令生成。</p>
<h3 id="createsuperuser"><a href="#createsuperuser" class="headerlink" title="createsuperuser"></a>createsuperuser</h3><p>点击<code>Tools 菜单下 Run manage.py Task</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">createsuperuser </span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>输入自己的用户名密码。</p>
<p>报错:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">django.db.utils.DataError: (1406, &quot;Data too long for column &#39;gender&#39; at row 1&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>gender中female是6位。而我们最大长度只有5.</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-2a3359e969bab10a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/213" alt="img"></p>
<p>修改后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makemigrations users</span><br><span class="line">migrate users</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后重新<code>createsuperuser</code></p>
<p>使用自己定义的用户名密码可以登进系统。</p>
<blockquote>
<p>默认是用户名 + 密码。后面会讲到如何实现用户名 或 邮箱和密码登录。</p>
</blockquote>
<h3 id="修改setting中对应语言，时区，以及数据库写入时间。"><a href="#修改setting中对应语言，时区，以及数据库写入时间。" class="headerlink" title="修改setting中对应语言，时区，以及数据库写入时间。"></a>修改setting中对应语言，时区，以及数据库写入时间。</h3><p>修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 语言改为中文</span><br><span class="line">LANGUAGE_CODE &#x3D; &#39;zh-hans&#39;</span><br><span class="line"></span><br><span class="line"># 时区改为上海</span><br><span class="line">TIME_ZONE &#x3D; &#39;Asia&#x2F;Shanghai&#39;</span><br><span class="line"># 数据库存储使用时间，True时间会被存为UTC的时间</span><br><span class="line">USE_TZ &#x3D; False</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>点击运行可以看到被换成汉语的效果:</p>
<p>注意: django 2.0.1 并不会看到汉化后的默认页面。只有admin被汉化了。</p>
<p>组对应数据表: auth_group</p>
<p>在Django的admin中可以把上章的表都注册进来。对于表进行任意的增删改查。</p>
<p>默认其实会把user也注册进来的，但是因为我们通过userProfile覆盖了user。所以没有显示。</p>
<h3 id="注册UserProfile进来"><a href="#注册UserProfile进来" class="headerlink" title="注册UserProfile进来"></a>注册UserProfile进来</h3><p>users/admin.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line"></span><br><span class="line"># 因为同一个目录，所以可以直接.models</span><br><span class="line">from .models import UserProfile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 写一个管理器:命名, model+Admin</span><br><span class="line">class UserProfileAdmin(admin.ModelAdmin):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 将UserProfile注册进我们的admin中, 并为它选择管理器</span><br><span class="line">admin.site.register(UserProfile,UserProfileAdmin)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/125.png" alt="img"></p>
<blockquote>
<p>可以看到我们的用户信息就注册进来了。</p>
</blockquote>
<p><code>USERS</code> 是用户所在表名称。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/126.png" alt="img"></p>
<p>进入页面可以看到Django为我们把每个不同类型的字段生成了不同的前端样式。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/127.png" alt="img"></p>
<blockquote>
<p>Django会自动帮我们把密码加密，而且不能反解。单向性。</p>
</blockquote>
<p>如果出现错误, 可能是<code>initial</code>文件在我们拖入apps时路径被改变。之后我们添加了环境变量, 前面再加上apps就会报错。</p>
<p>这时把<code>initial.py</code> 中路径进行修改。</p>
<p>错误2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">新增用户信息提示：</span><br><span class="line">Cannot add or update a child row: a foreign key constraint fails</span><br><span class="line">(1452, &#39;Cannot add or update a child row: a foreign key constraint fails </span><br><span class="line">&#96;mxonline&#96;.&#96;django_admin_log&#96;, CONSTRAINT &#96;django_admin_log_user_id_c564eba6_fk_auth_user_id&#96; </span><br><span class="line">FOREIGN KEY (&#96;user_id&#96;) REFERENCES &#96;auth_user&#96; (&#96;id&#96;))&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>解决方案1: 不用解决，之后换Xadmin就好了。</p>
</blockquote>
<p>解决方案2: 在setting的databases中添加以下代码取消外键检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DATABASES &#x3D; &#123;</span><br><span class="line">    &#39;default&#39;: &#123;</span><br><span class="line">        &#39;ENGINE&#39;: &#39;django.db.backends.mysql&#39;,</span><br><span class="line">        &#39;NAME&#39;: &#39;mxonline2&#39;,</span><br><span class="line">        &#39;USER&#39;: &#39;root&#39;,</span><br><span class="line">        &#39;PASSWORD&#39;: &#39;你的密码&#39;,</span><br><span class="line">        &#39;HOST&#39;:&#39;127.0.0.1&#39;,</span><br><span class="line">        &#39;OPTIONS&#39;: &#123;</span><br><span class="line">          &quot;init_command&quot;: &quot;SET foreign_key_checks&#x3D;0;&quot;,</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>实验成功为了不影响后面，把options删除</p>
<p>本小节结束对应commit:</p>
<blockquote>
<p>admin中添加管理器&amp;注册。时区,语言,utc(False).数据库中选项参数。female的长度修改, createsuperuser.对应5-1</p>
</blockquote>
<h2 id="xadmin的安装"><a href="#xadmin的安装" class="headerlink" title="xadmin的安装"></a>xadmin的安装</h2><p>一套基于admin, 比admin更强大的系统。</p>
<ol>
<li>通过pip安装</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install xadmin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Python3-amp-Django2-0-1安装官方适配Django2-0的包"><a href="#Python3-amp-Django2-0-1安装官方适配Django2-0的包" class="headerlink" title="Python3 &amp; Django2.0.1安装官方适配Django2.0的包"></a>Python3 &amp; Django2.0.1安装官方适配Django2.0的包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install git+git:&#x2F;&#x2F;github.com&#x2F;sshwsfc&#x2F;xadmin.git@django2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>xadmin可以把我们的后台做的很强大，可扩展。</p>
<h3 id="注册Xadmin-与-crispy-forms"><a href="#注册Xadmin-与-crispy-forms" class="headerlink" title="注册Xadmin 与 crispy-forms"></a>注册Xadmin 与 crispy-forms</h3><p>Mxonline2/settings.py的INSTALLED_APPS中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#39;xadmin&#39;,</span><br><span class="line">&#39;crispy_forms&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后把urls中默认admin指向Xadmin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 导入x admin，替换admin</span><br><span class="line">import xadmin</span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    url(r&#39;^xadmin&#x2F;&#39;, xadmin.site.urls),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Python3 Django2.0.1 的url的配置中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path(&#39;xadmin&#x2F;&#39;, xadmin.site.urls),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>注意：Django 2.0.1中不需要加r也不需要加^</strong></p>
<p>将我们原来写的user/admin.py中代码注释掉。</p>
<p>此时直接运行项目会报错，因为我们Xadmin的默认数据表并没有migarte</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ProgrammingError: (1146, &quot;Table &#39;mxonline2.xadmin_usersettings&#39; doesn&#39;t exist&quot;)</span><br><span class="line">[09&#x2F;Jan&#x2F;2018 06:40:27] &quot;GET &#x2F;xadmin&#x2F; HTTP&#x2F;1.1&quot; 500 150414</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>点击<code>Tools 菜单下 Run manage.py Task</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>前往Navicat进行验证。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-12561778ec508abe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/162" alt="img"></p>
<blockquote>
<p>可以看到新增的表。</p>
</blockquote>
<p>Xadmin的后台采用的是bootstrap。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/129.png" alt="img"></p>
<p>mark</p>
<blockquote>
<p>后面我们会介绍如何制作插件</p>
</blockquote>
<h3 id="源码安装："><a href="#源码安装：" class="headerlink" title="源码安装："></a>源码安装：</h3><p>github: <a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=https://github.com/sshwsfc/xadmin">https://github.com/sshwsfc/xadmin</a></p>
<p>下载或<code>git clone</code>将源码下载到本地。</p>
<blockquote>
<p>解压后将Xadmin文件夹复制到我们的项目中。</p>
</blockquote>
<h4 id="Python3版本源码安装-与url配置不同"><a href="#Python3版本源码安装-与url配置不同" class="headerlink" title="Python3版本源码安装:与url配置不同"></a>Python3版本源码安装:与url配置不同</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone -b django2 https:&#x2F;&#x2F;github.com&#x2F;sshwsfc&#x2F;xadmin.git</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其余操作一样。</p>
<h3 id="新建extra-apps，并在setting中注册地址"><a href="#新建extra-apps，并在setting中注册地址" class="headerlink" title="新建extra_apps，并在setting中注册地址"></a>新建extra_apps，并在setting中注册地址</h3><p>新建new package: extra_apps</p>
<blockquote>
<p>使用该目录存放我们的第三方插件，将Xadmin移入。<br>右键mark为SourceRoot, 但是这时候cmd下回报错。</p>
</blockquote>
<p>所以在setting.py中加入。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sys.path.insert(0,os.path.join(BASE_DIR, &#39;extra_apps&#39;))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>因为我们的source目录已经有Xadmin了，就不会再去系统环境中找了。这时候卸载我们的Xadmin。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">workon mxonline2</span><br><span class="line">pip uninstall xadmin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是他的依赖包我们还需要，所以只需要卸载Xadmin。此时我们运行会报错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    from future.utils import iteritems</span><br><span class="line">ImportError: No module named future.utils</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>安装必要的包:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pip install future</span><br><span class="line">pip install six</span><br><span class="line">pip install httplib2</span><br><span class="line">pip install django-import-export</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时又可以成功运行了</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/131.png" alt="img"></p>
<p>日志记录：后台管理人员做的操作都会生成一条记录。</p>
<p>源码安装优点:</p>
<ul>
<li>xadmin新特性</li>
<li>对于源码进行自己的修改。</li>
</ul>
<p>本小节结束对应commit:</p>
<blockquote>
<p>Xadmin的安装与源码安装，配置setting中extra_apps. 对应5-2</p>
</blockquote>
<h2 id="users-app-的model注册"><a href="#users-app-的model注册" class="headerlink" title="users app 的model注册"></a>users app 的model注册</h2><h3 id="遗留问题-django2-0-1使用xadmin时。如验证码等带dateTimefield区域出错。"><a href="#遗留问题-django2-0-1使用xadmin时。如验证码等带dateTimefield区域出错。" class="headerlink" title="遗留问题: django2.0.1使用xadmin时。如验证码等带dateTimefield区域出错。"></a>遗留问题: django2.0.1使用xadmin时。如验证码等带dateTimefield区域出错。</h3><p>xadmin/widgets.py</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/132.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">input_html &#x3D; [ht for ht in super(AdminSplitDateTime, self).render(</span><br><span class="line">    name, value, attrs).split(&#39;&#x2F;&gt;&lt;&#39;) if ht !&#x3D; &#39;&#39;]</span><br><span class="line">        if (len(input_html) &gt; 1):</span><br><span class="line">            input_html[0] &#x3D; input_html[0] + &quot;&#x2F;&gt;&quot;</span><br><span class="line">            input_html[1] &#x3D; &quot;&lt;&quot; + input_html[1]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/133.png" alt="img"></p>
<blockquote>
<p>此时可以看到已经运行正常</p>
</blockquote>
<h3 id="真正开始"><a href="#真正开始" class="headerlink" title="真正开始"></a>真正开始</h3><p>Xadmin是基于Django的admin来开发的，所以Xadmin也继承了许多admin的用法。</p>
<ul>
<li>比如: models的注册。</li>
</ul>
<p>UserProfile已经被自动注册进去了，我们从验证码开始注册。</p>
<p>我们需要新建一个<code>adminx.py</code>文件，Xadmin会自动搜寻这种命名的文件。</p>
<h3 id="新建py文件的初始化模板"><a href="#新建py文件的初始化模板" class="headerlink" title="新建py文件的初始化模板"></a>新建py文件的初始化模板</h3><p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/134.png"></p>
<p>新建users/adminx.py：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line"></span><br><span class="line">import xadmin</span><br><span class="line"></span><br><span class="line">from .models import EmailVerifyRecord</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建admin的管理类,这里不再是继承admin，而是继承object</span><br><span class="line">class EmailVerifyRecordAdmin(object):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xadmin.site.register(EmailVerifyRecord, EmailVerifyRecordAdmin)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/135.png" alt="img"></p>
<blockquote>
<p>可以看到这时候访问已经有邮箱验证码了。</p>
</blockquote>
<p>邮箱验证码这几个字就是我们代码中Meta中verbose_name定义的:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class Meta:</span><br><span class="line">    verbose_name &#x3D; &quot;邮箱验证码&quot;</span><br><span class="line">    verbose_name_plural &#x3D; verbose_name</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>verbose_name_plural</code>是<code>verbose_name</code>的复数形式。</p>
<p>字段的verbose_name会直接显示在后台。<code>sendtype</code>和<code>sendtime</code>没有设置所以直接显示了英文。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/136.png" alt="img"></p>
<blockquote>
<p>可以看到我们添加验证码成功。注意:上节版本中我们进行了: makemigaration &amp; migrate。<br>但是它是pip安装的Xadmin的数据表生成。我们卸载之后，源码安装需要重新运行进行数据迁移。(django需要通过app文件夹下的init文件来记录表的更改记录，pip的都卸了，所以就没法找到了)</p>
</blockquote>
<p>会报错:</p>
<blockquote>
<p>Xadmin_log不存在错误。只需要运行这两条命令即可。</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/137.png" alt="img"></p>
<h4 id="解决后台部分英文显示"><a href="#解决后台部分英文显示" class="headerlink" title="解决后台部分英文显示"></a>解决后台部分英文显示</h4><blockquote>
<p>全部models中字段自行添加verbose_name</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/138.png" alt="img"></p>
<p>这里就不贴出来了，自行检查都加上(没写出的请自行修改全部加上verbose_name)。</p>
<h4 id="解决EmailVerifyRecord-object显示"><a href="#解决EmailVerifyRecord-object显示" class="headerlink" title="解决EmailVerifyRecord object显示"></a>解决EmailVerifyRecord object显示</h4><blockquote>
<p><strong>全部</strong>(没写出的请自行修改)model，py2:重载<code>__unicode</code> py3:重载<code>__str__</code></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 重载Unicode方法使后台不再直接显示object</span><br><span class="line">def __unicode__(self):</span><br><span class="line">    return &#39;&#123;0&#125;(&#123;1&#125;)&#39;.format(self.code,self.email)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>上面代码是python的自身基础语法。</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/139.png" alt="img"></p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/140.png" alt="img"></p>
<h4 id="配置显示列"><a href="#配置显示列" class="headerlink" title="配置显示列"></a>配置显示列</h4><p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/141.png" alt="img"></p>
<p>users/adminx.py的管理器中设置list_display:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 创建admin的管理类,这里不再是继承admin，而是继承object</span><br><span class="line">class EmailVerifyRecordAdmin(object):</span><br><span class="line">    # 配置后台我们需要显示的列</span><br><span class="line">    list_display &#x3D; [&#39;code&#39;, &#39;email&#39;,&#39;send_type&#39;, &#39;send_time&#39;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>list_display可以使用列表或元祖，建议使用列表。否则元组只有一个元素，忘记加逗号就会报错。</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/142.png" alt="img"></p>
<p>选择框的生成是因为我们加上了<code>choices</code></p>
<h4 id="配置搜索searchfield"><a href="#配置搜索searchfield" class="headerlink" title="配置搜索searchfield"></a>配置搜索searchfield</h4><p>users/adminx.py的管理器中EmailVerifyRecordAdmin添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 配置搜索字段,不做时间搜索</span><br><span class="line">search_fields &#x3D;  [&#39;code&#39;, &#39;email&#39;,&#39;send_type&#39;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/143.png" alt="img"></p>
<p>再添加一条数据验证搜索功能</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/144.png" alt="img"></p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/145.png" alt="img"></p>
<h4 id="xadmin导出csv中文乱码解决"><a href="#xadmin导出csv中文乱码解决" class="headerlink" title="xadmin导出csv中文乱码解决"></a>xadmin导出csv中文乱码解决</h4><p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/146.png" alt="img"></p>
<blockquote>
<p>set=utf-8<code> 改为</code>charset=gbk`</p>
</blockquote>
<h4 id="xadmin导出xml报错"><a href="#xadmin导出xml报错" class="headerlink" title="xadmin导出xml报错"></a>xadmin导出xml报错</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TypeError at &#x2F;xadmin&#x2F;users&#x2F;emailverifyrecord&#x2F;</span><br><span class="line">unicode argument expected, got &#39;str&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>io.StringIO这个库新版本的python3直接往这个库中加入了一些新的内容，使得该库在Python2.7中较为混乱。</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/147.png" alt="img"></p>
<blockquote>
<p>将StringIo变为BytesIO</p>
</blockquote>
<h4 id="通过时间筛选字段。"><a href="#通过时间筛选字段。" class="headerlink" title="通过时间筛选字段。"></a>通过时间筛选字段。</h4><p>users/adminx.py的管理器中EmailVerifyRecordAdmin添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 配置筛选字段</span><br><span class="line">list_filter &#x3D;  [&#39;code&#39;, &#39;email&#39;,&#39;send_type&#39;, &#39;send_time&#39;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/148.png" alt="img"></p>
<h3 id="Django的admin-Xadmin和其他系统区别"><a href="#Django的admin-Xadmin和其他系统区别" class="headerlink" title="Django的admin, Xadmin和其他系统区别"></a>Django的admin, Xadmin和其他系统区别</h3><blockquote>
<p>不像php等其他语言是一个功能模块一个功能设计的。<br>Django是对于每张表增删改查的管理器，我们可以在增删改成的基础上加上我们自己的后台逻辑。<br>因此某种程度可以说他是不依赖于具体业务的。不管啥系统后台都是由表组成。</p>
</blockquote>
<p>不依赖于后台逻辑，又可以加上逻辑。</p>
<h3 id="user-models的注册"><a href="#user-models的注册" class="headerlink" title="user/models的注册"></a>user/models的注册</h3><p>users/adminx.py中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 创建banner的管理类</span><br><span class="line">from .models import EmailVerifyRecord, Banner</span><br><span class="line">class BannerAdmin(object):</span><br><span class="line">    list_display &#x3D; [&#39;title&#39;, &#39;image&#39;, &#39;url&#39;,&#39;index&#39;, &#39;add_time&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;title&#39;, &#39;image&#39;, &#39;url&#39;,&#39;index&#39;]</span><br><span class="line">    list_filter &#x3D; [&#39;title&#39;, &#39;image&#39;, &#39;url&#39;,&#39;index&#39;, &#39;add_time&#39;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 将model与admin管理器进行关联注册</span><br><span class="line">xadmin.site.register(Banner, BannerAdmin)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时后台页面。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/149.png" alt="img"></p>
<blockquote>
<p>可以自行测试轮播图是否可以新建成功。</p>
</blockquote>
<p>本小节结束对应commit:</p>
<blockquote>
<p>usersmodels三张表注册进xadmin, 配置搜索过滤展示字段，修复xadmin导出xml错误,导出csv乱码，Unicode重载。</p>
</blockquote>
<p>py3(django2.0.1):</p>
<blockquote>
<p>usersmodels三张表注册进xadmin, 配置搜索过滤展示字段，修复xadmin导出csv乱码，修复django2.0.1的indexError, str重载。</p>
</blockquote>
<h2 id="剩余app-model注册"><a href="#剩余app-model注册" class="headerlink" title="剩余app model注册"></a>剩余app model注册</h2><h3 id="courses注册"><a href="#courses注册" class="headerlink" title="courses注册"></a>courses注册</h3><p>新建courses/adminx.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line"></span><br><span class="line">from .models import Course, Lesson, Video, CourseResource</span><br><span class="line">import xadmin</span><br><span class="line"></span><br><span class="line"># Course的admin管理器</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class CourseAdmin(object):</span><br><span class="line">    list_display &#x3D; [</span><br><span class="line">        &#39;name&#39;,</span><br><span class="line">        &#39;desc&#39;,</span><br><span class="line">        &#39;detail&#39;,</span><br><span class="line">        &#39;degree&#39;,</span><br><span class="line">        &#39;learn_times&#39;,</span><br><span class="line">        &#39;students&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;name&#39;, &#39;desc&#39;, &#39;detail&#39;, &#39;degree&#39;, &#39;students&#39;]</span><br><span class="line">    list_filter &#x3D; [</span><br><span class="line">        &#39;name&#39;,</span><br><span class="line">        &#39;desc&#39;,</span><br><span class="line">        &#39;detail&#39;,</span><br><span class="line">        &#39;degree&#39;,</span><br><span class="line">        &#39;learn_times&#39;,</span><br><span class="line">        &#39;students&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class LessonAdmin(object):</span><br><span class="line">    list_display &#x3D; [&#39;course&#39;, &#39;name&#39;, &#39;add_time&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;course&#39;, &#39;name&#39;]</span><br><span class="line"></span><br><span class="line">    # __name代表使用外键中name字段</span><br><span class="line">    list_filter &#x3D; [&#39;course__name&#39;, &#39;name&#39;, &#39;add_time&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class VideoAdmin(object):</span><br><span class="line">    list_display &#x3D; [&#39;lesson&#39;, &#39;name&#39;, &#39;add_time&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;lesson&#39;, &#39;name&#39;]</span><br><span class="line">    list_filter &#x3D; [&#39;lesson&#39;, &#39;name&#39;, &#39;add_time&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class CourseResourceAdmin(object):</span><br><span class="line">    list_display &#x3D; [&#39;course&#39;, &#39;name&#39;, &#39;download&#39;, &#39;add_time&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;course&#39;, &#39;name&#39;, &#39;download&#39;]</span><br><span class="line">    # __name代表使用外键中name字段</span><br><span class="line">    list_filter &#x3D; [&#39;course__name&#39;, &#39;name&#39;, &#39;download&#39;, &#39;add_time&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 将管理器与model进行注册关联</span><br><span class="line">xadmin.site.register(Course, CourseAdmin)</span><br><span class="line">xadmin.site.register(Lesson, LessonAdmin)</span><br><span class="line">xadmin.site.register(Video, VideoAdmin)</span><br><span class="line">xadmin.site.register(CourseResource, CourseResourceAdmin)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/150.png"></p>
<blockquote>
<p>注意：对应后台显示英文的字段自行检查<code>verbosename</code>，自行加上。<br>注意: py2下重载<code>__unicode__</code>方法，py3下重载<code>__str__</code>方法</p>
</blockquote>
<p>如(注意缩进):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def __str__(self):</span><br><span class="line">    return &#39;《&#123;0&#125;》课程的章节 &gt;&gt; &#123;1&#125;&#39;.format(self.course,self.name)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/151.png" alt="img"></p>
<p><code>int</code>类型后台会生成如下图区间取值:</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/152.png" alt="img"></p>
<p>可以看到有外键关系的会有一个小符号。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/153.png"></p>
<h3 id="注册机构app的adminx"><a href="#注册机构app的adminx" class="headerlink" title="注册机构app的adminx"></a>注册机构app的adminx</h3><p>新建<code>organization/adminx.py</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line"></span><br><span class="line">import xadmin</span><br><span class="line"></span><br><span class="line">from .models import CityDict, CourseOrg, Teacher</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 机构所属城市名后台管理器</span><br><span class="line">class CityDictAdmin(object):</span><br><span class="line">    list_display &#x3D; [&#39;name&#39;, &#39;desc&#39;, &#39;add_time&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;name&#39;, &#39;desc&#39;]</span><br><span class="line">    list_filter &#x3D; [&#39;name&#39;, &#39;desc&#39;, &#39;add_time&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 机构课程信息管理器</span><br><span class="line">class CourseOrgAdmin(object):</span><br><span class="line">    list_display &#x3D; [&#39;name&#39;, &#39;desc&#39;, &#39;click_nums&#39;, &#39;fav_nums&#39;,&#39;add_time&#39; ]</span><br><span class="line">    search_fields &#x3D; [&#39;name&#39;, &#39;desc&#39;, &#39;click_nums&#39;, &#39;fav_nums&#39;]</span><br><span class="line">    list_filter &#x3D; [&#39;name&#39;, &#39;desc&#39;, &#39;click_nums&#39;, &#39;fav_nums&#39;,&#39;city__name&#39;,&#39;address&#39;,&#39;add_time&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class TeacherAdmin(object):</span><br><span class="line">    list_display &#x3D; [ &#39;name&#39;,&#39;org&#39;, &#39;work_years&#39;, &#39;work_company&#39;,&#39;add_time&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;org&#39;, &#39;name&#39;, &#39;work_years&#39;, &#39;work_company&#39;]</span><br><span class="line">    list_filter &#x3D; [&#39;org__name&#39;, &#39;name&#39;, &#39;work_years&#39;, &#39;work_company&#39;,&#39;click_nums&#39;, &#39;fav_nums&#39;, &#39;add_time&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xadmin.site.register(CityDict, CityDictAdmin)</span><br><span class="line">xadmin.site.register(CourseOrg, CourseOrgAdmin)</span><br><span class="line">xadmin.site.register(Teacher, TeacherAdmin)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：对应后台显示英文的字段自行检查verbosename，自行加上。<br>注意: py2下重载<code>__unicode__</code>方法，py3下重载<code>__str__</code>方法</p>
</blockquote>
<p>如(注意缩进):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def __str__(self):</span><br><span class="line">  return &quot;[&#123;0&#125;]的教师: &#123;1&#125;&quot;.format(self.org, self.name)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果注册后没有显示： 重新登录，或重启项目</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/154.png" alt="img"></p>
<h3 id="operation-app注册xadmin"><a href="#operation-app注册xadmin" class="headerlink" title="operation app注册xadmin"></a>operation app注册xadmin</h3><p>新建<code>operation/adminx.py</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line"></span><br><span class="line">import xadmin</span><br><span class="line"></span><br><span class="line">from .models import UserAsk, UserCourse, UserMessage, CourseComments, UserFavorite</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 用户表单我要学习后台管理器</span><br><span class="line">class UserAskAdmin(object):</span><br><span class="line">    list_display &#x3D; [&#39;name&#39;, &#39;mobile&#39;, &#39;course_name&#39;, &#39;add_time&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;name&#39;, &#39;mobile&#39;, &#39;course_name&#39;]</span><br><span class="line">    list_filter &#x3D; [&#39;name&#39;, &#39;mobile&#39;, &#39;course_name&#39;, &#39;add_time&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 用户课程学习后台管理器</span><br><span class="line">class UserCourseAdmin(object):</span><br><span class="line">    list_display &#x3D; [&#39;user&#39;, &#39;course&#39;, &#39;add_time&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;user&#39;, &#39;course&#39;]</span><br><span class="line">    list_filter &#x3D; [&#39;user&#39;, &#39;course&#39;, &#39;add_time&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 用户消息后台管理器</span><br><span class="line">class UserMessageAdmin(object):</span><br><span class="line">    list_display &#x3D; [&#39;user&#39;, &#39;message&#39;, &#39;has_read&#39;, &#39;add_time&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;user&#39;, &#39;message&#39;, &#39;has_read&#39;]</span><br><span class="line">    list_filter &#x3D; [&#39;user&#39;, &#39;message&#39;, &#39;has_read&#39;, &#39;add_time&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 用户评论后台管理器</span><br><span class="line">class CourseCommentsAdmin(object):</span><br><span class="line">    list_display &#x3D; [&#39;user&#39;, &#39;course&#39;, &#39;comments&#39;, &#39;add_time&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;user&#39;, &#39;course&#39;, &#39;comments&#39;]</span><br><span class="line">    list_filter &#x3D; [&#39;user&#39;, &#39;course&#39;, &#39;comments&#39;, &#39;add_time&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 用户收藏后台管理器</span><br><span class="line">class UserFavoriteAdmin(object):</span><br><span class="line">    list_display &#x3D; [&#39;user&#39;, &#39;fav_id&#39;, &#39;fav_type&#39;, &#39;add_time&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;user&#39;, &#39;fav_id&#39;, &#39;fav_type&#39;]</span><br><span class="line">    list_filter &#x3D; [&#39;user&#39;, &#39;fav_id&#39;, &#39;fav_type&#39;, &#39;add_time&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 将后台管理器与models进行关联注册。</span><br><span class="line">xadmin.site.register(UserAsk, UserAskAdmin)</span><br><span class="line">xadmin.site.register(UserCourse, UserCourseAdmin)</span><br><span class="line">xadmin.site.register(UserMessage, UserMessageAdmin)</span><br><span class="line">xadmin.site.register(CourseComments, CourseCommentsAdmin)</span><br><span class="line">xadmin.site.register(UserFavorite, UserFavoriteAdmin)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：对应后台显示英文的字段自行检查<code>verbosename</code>，自行加上。<br>注意: py2下重载<code>__unicode__</code>方法，py3下重载<code>__str__</code>方法</p>
</blockquote>
<p>如(注意缩进):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def __str__(self):</span><br><span class="line">  return &quot;[&#123;0&#125;]的教师: &#123;1&#125;&quot;.format(self.org, self.name)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>成功性验证:</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/155.png" alt="img"></p>
<h2 id="xadmin全局配置"><a href="#xadmin全局配置" class="headerlink" title="xadmin全局配置"></a>xadmin全局配置</h2><p>将全局配置修改:</p>
<ul>
<li>如左上角：django Xadmin。下面的我的公司</li>
<li>主题修改，app名称汉化，菜单收叠。</li>
</ul>
<h3 id="使用Xadmin的主题功能。"><a href="#使用Xadmin的主题功能。" class="headerlink" title="使用Xadmin的主题功能。"></a>使用Xadmin的主题功能。</h3><p>把全站的配置放在users\adminx.py中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from xadmin import views</span><br><span class="line"># 创建X admin的全局管理器并与view绑定。</span><br><span class="line">class BaseSetting(object):</span><br><span class="line">    # 开启主题功能</span><br><span class="line">    enable_themes &#x3D; True</span><br><span class="line">    use_bootswatch &#x3D; True</span><br><span class="line"></span><br><span class="line"># 将全局配置管理与view绑定注册</span><br><span class="line">xadmin.site.register(views.BaseAdminView, BaseSetting)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="解决django1-9-python2-下Xadmin主题不生效问题。"><a href="#解决django1-9-python2-下Xadmin主题不生效问题。" class="headerlink" title="解决django1.9(python2)下Xadmin主题不生效问题。"></a>解决django1.9(python2)下Xadmin主题不生效问题。</h3><p><a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=https://my.oschina.net/u/2396236/blog/1083251">https://my.oschina.net/u/2396236/blog/1083251</a></p>
<ul>
<li>安装requests</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install requests</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>/xadmin/plugins/themes.py 引入requests</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>修改block_top_navmenu方法：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">def block_top_navmenu(self, context, nodes):</span><br><span class="line"></span><br><span class="line">       themes &#x3D; [</span><br><span class="line">           &#123;&#39;name&#39;: _(u&quot;Default&quot;), &#39;description&#39;: _(u&quot;Default bootstrap theme&quot;), &#39;css&#39;: self.default_theme&#125;,</span><br><span class="line">           &#123;&#39;name&#39;: _(u&quot;Bootstrap2&quot;), &#39;description&#39;: _(u&quot;Bootstrap 2.x theme&quot;), &#39;css&#39;: self.bootstrap2_theme&#125;,</span><br><span class="line">           ]</span><br><span class="line">       select_css &#x3D; context.get(&#39;site_theme&#39;, self.default_theme)</span><br><span class="line"></span><br><span class="line">       if self.user_themes:</span><br><span class="line">           themes.extend(self.user_themes)</span><br><span class="line"></span><br><span class="line">       if self.use_bootswatch:</span><br><span class="line">           ex_themes &#x3D; cache.get(THEME_CACHE_KEY)</span><br><span class="line">           if ex_themes:</span><br><span class="line">               themes.extend(json.loads(ex_themes))</span><br><span class="line">           else:</span><br><span class="line">               ex_themes &#x3D; []</span><br><span class="line">               try:</span><br><span class="line">                   flag &#x3D; False#假如为True使用原来的代码，假如为Flase，使用requests库来访问</span><br><span class="line">                   if flag:</span><br><span class="line">                       h &#x3D; httplib2.Http()</span><br><span class="line">                       resp, content &#x3D; h.request(&quot;http:&#x2F;&#x2F;bootswatch.com&#x2F;api&#x2F;3.json&quot;, &#39;GET&#39;, &#39;&#39;,</span><br><span class="line">                           headers&#x3D;&#123;&quot;Accept&quot;: &quot;application&#x2F;json&quot;, &quot;User-Agent&quot;: self.request.META[&#39;HTTP_USER_AGENT&#39;]&#125;)</span><br><span class="line">                       if six.PY3:</span><br><span class="line">                           content &#x3D; content.decode()</span><br><span class="line">                       watch_themes &#x3D; json.loads(content)[&#39;themes&#39;]</span><br><span class="line">                   else:</span><br><span class="line">                       content &#x3D; requests.get(&quot;https:&#x2F;&#x2F;bootswatch.com&#x2F;api&#x2F;3.json&quot;)</span><br><span class="line">                       if six.PY3:</span><br><span class="line">                           content &#x3D; content.text.decode()</span><br><span class="line">                       watch_themes &#x3D; json.loads(content.text)[&#39;themes&#39;]</span><br><span class="line"></span><br><span class="line">                   ex_themes.extend([</span><br><span class="line">                       &#123;&#39;name&#39;: t[&#39;name&#39;], &#39;description&#39;: t[&#39;description&#39;],</span><br><span class="line">                           &#39;css&#39;: t[&#39;cssMin&#39;], &#39;thumbnail&#39;: t[&#39;thumbnail&#39;]&#125;</span><br><span class="line">                       for t in watch_themes])</span><br><span class="line">               except Exception as e:</span><br><span class="line">                   print(e)</span><br><span class="line"></span><br><span class="line">               cache.set(THEME_CACHE_KEY, json.dumps(ex_themes), 24 * 3600)</span><br><span class="line">               themes.extend(ex_themes)</span><br><span class="line"></span><br><span class="line">       nodes.append(loader.render_to_string(&#39;xadmin&#x2F;blocks&#x2F;comm.top.theme.html&#39;, &#123;&#39;themes&#39;: themes, &#39;select_css&#39;: select_css&#125;))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="修改django-admin-和下面的我的公司收起菜单"><a href="#修改django-admin-和下面的我的公司收起菜单" class="headerlink" title="修改django admin 和下面的我的公司收起菜单"></a>修改django admin 和下面的我的公司收起菜单</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># x admin 全局配置参数信息设置</span><br><span class="line">class GlobalSettings(object):</span><br><span class="line">    site_title &#x3D; &quot;xxxx&quot;</span><br><span class="line">    site_footer &#x3D; &quot;xxx&quot;</span><br><span class="line">    # 收起菜单</span><br><span class="line">    menu_style &#x3D; &quot;accordion&quot;</span><br><span class="line"># 将头部与脚部信息进行注册:</span><br><span class="line">xadmin.site.register(views.CommAdminView, GlobalSettings)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="apps-py配置app的显示名称"><a href="#apps-py配置app的显示名称" class="headerlink" title="apps.py配置app的显示名称"></a>apps.py配置app的显示名称</h3><p>每个app下执行同样操作:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from django.apps import AppConfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class CoursesConfig(AppConfig):</span><br><span class="line">    name &#x3D; &#39;courses&#39;</span><br><span class="line">    verbose_name &#x3D; u&quot;课程&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>注意自行找猫画虎为每个app添加中文名</strong></p>
<blockquote>
<p>新建app时并没有引用apps的配置</p>
</blockquote>
<p>在app下的init.py中添加:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">default_app_config &#x3D; &quot;operation.apps.OperationConfig&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/156.png" alt="img"></p>
<p>注意对应关系。</p>
<p><strong>注意为每个都添加对应的default_app_config</strong></p>
<h3 id="自定义导航菜单顺序"><a href="#自定义导航菜单顺序" class="headerlink" title="自定义导航菜单顺序"></a>自定义导航菜单顺序</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">class GlobalSetting(object):</span><br><span class="line">     def get_site_menu(self):</span><br><span class="line">        return (</span><br><span class="line">            &#123;&#39;title&#39;: &#39;课程管理&#39;, &#39;menus&#39;: (</span><br><span class="line">                &#123;&#39;title&#39;: &#39;课程信息&#39;, &#39;url&#39;: self.get_model_url(Course, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;章节信息&#39;, &#39;url&#39;: self.get_model_url(Lesson, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;视频信息&#39;, &#39;url&#39;: self.get_model_url(Video, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;课程资源&#39;, &#39;url&#39;: self.get_model_url(CourseResource, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;课程评论&#39;, &#39;url&#39;: self.get_model_url(CourseComments, &#39;changelist&#39;)&#125;,</span><br><span class="line">            )&#125;,</span><br><span class="line">            &#123;&#39;title&#39;: &#39;机构管理&#39;, &#39;menus&#39;: (</span><br><span class="line">                &#123;&#39;title&#39;: &#39;所在城市&#39;, &#39;url&#39;: self.get_model_url(CityDict, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;机构讲师&#39;, &#39;url&#39;: self.get_model_url(Teacher, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;机构信息&#39;, &#39;url&#39;: self.get_model_url(CourseOrg, &#39;changelist&#39;)&#125;,</span><br><span class="line">            )&#125;,</span><br><span class="line">            &#123;&#39;title&#39;: &#39;用户管理&#39;, &#39;menus&#39;: (</span><br><span class="line">                &#123;&#39;title&#39;: &#39;用户信息&#39;, &#39;url&#39;: self.get_model_url(UserProfile, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;用户验证&#39;, &#39;url&#39;: self.get_model_url(EmailVerifyRecord, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;用户课程&#39;, &#39;url&#39;: self.get_model_url(UserCourse, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;用户收藏&#39;, &#39;url&#39;: self.get_model_url(UserFavorite, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;用户消息&#39;, &#39;url&#39;: self.get_model_url(UserMessage, &#39;changelist&#39;)&#125;,</span><br><span class="line">            )&#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#123;&#39;title&#39;: &#39;系统管理&#39;, &#39;menus&#39;: (</span><br><span class="line">                &#123;&#39;title&#39;: &#39;用户咨询&#39;, &#39;url&#39;: self.get_model_url(UserAsk, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;首页轮播&#39;, &#39;url&#39;: self.get_model_url(Banner, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;用户分组&#39;, &#39;url&#39;: self.get_model_url(Group, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;用户权限&#39;, &#39;url&#39;: self.get_model_url(Permission, &#39;changelist&#39;)&#125;,</span><br><span class="line">                &#123;&#39;title&#39;: &#39;日志记录&#39;, &#39;url&#39;: self.get_model_url(Log, &#39;changelist&#39;)&#125;,</span><br><span class="line">            )&#125;,</span><br><span class="line"></span><br><span class="line">xadmin.site.register(views.CommAdminView, GlobalSetting)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最终成型菜单:</p>
<h3 id="日志记录的使用"><a href="#日志记录的使用" class="headerlink" title="日志记录的使用"></a>日志记录的使用</h3><blockquote>
<p>日志记录会记录下我们进行过什么操作。</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/157.png" alt="img"></p>
<p>通过点击动作，进入当时修改的某条信息</p>
<p>写一个自己遇到的问题 在自定义导航栏的菜单顺序时 找了半天也没在xadmin中找到Group<br>最后从django.contrib.auth.models中成功导入</p>
<h1 id="完成登录-amp-注册-amp-找回密码-amp-激活-amp-验证码集成"><a href="#完成登录-amp-注册-amp-找回密码-amp-激活-amp-验证码集成" class="headerlink" title="完成登录 &amp; 注册 &amp; 找回密码 &amp; 激活 &amp; 验证码集成"></a><center>完成登录 &amp; 注册 &amp; 找回密码 &amp; 激活 &amp; 验证码集成</center></h1><h2 id="首页和登录页面的配置"><a href="#首页和登录页面的配置" class="headerlink" title="首页和登录页面的配置"></a>首页和登录页面的配置</h2><p>用户访问我们的根目录，我们需要把html文件返回给用户。因此我们第一步把html文件放入template目录。 </p>
<p>在html中找到首页的html。拷贝到我们的template目录 </p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/158.png"></p>
<h3 id="新建static目录-1"><a href="#新建static目录-1" class="headerlink" title="新建static目录"></a>新建static目录</h3><blockquote>
<p>用来存放css, js等静态文件</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/159.png"></p>
<h4 id="配置处理静态文件的url。"><a href="#配置处理静态文件的url。" class="headerlink" title="配置处理静态文件的url。"></a>配置处理静态文件的url。</h4><p>Django2.0.1版本下:</p>
<p>Mxonline3/urls.py：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from django.views.generic import TemplateView</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    path(&#39;xadmin&#x2F;&#39;, xadmin.site.urls),</span><br><span class="line">    # TemplateView.as_view会将template转换为view</span><br><span class="line">    path(&#39;&#39;, TemplateView.as_view(template_name&#x3D; &quot;index.html&quot;), name&#x3D;  &quot;index&quot;)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>Django1.9.8版本下:</p>
<p>Mxonline2/urls.py：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from django.views.generic import TemplateView</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    url(r&#39;^xadmin&#x2F;&#39;, xadmin.site.urls),</span><br><span class="line">    url(&#39;^$&#39;, TemplateView.as_view(template_name&#x3D;&quot;index.html&quot;), name&#x3D;&quot;index&quot;)</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>此时运行访问就可以访问到我们的index页面，不过会没有样式。</p>
<h3 id="设置static文件"><a href="#设置static文件" class="headerlink" title="设置static文件"></a>设置static文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 说明静态文件放在哪个目录</span><br><span class="line"></span><br><span class="line">STATIC_URL &#x3D; &#39;&#x2F;static&#x2F;&#39;</span><br><span class="line"></span><br><span class="line">STATICFILES_DIRS &#x3D; (</span><br><span class="line">    os.path.join(BASE_DIR, &quot;static&quot;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="修改index页面中前端样式的引用地址"><a href="#修改index页面中前端样式的引用地址" class="headerlink" title="修改index页面中前端样式的引用地址"></a>修改index页面中前端样式的引用地址</h3><p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/160.png"></p>
<p>使用ctrl+f查找出所有<code>../</code>,全部替换为<code>/static/</code></p>
<p>然后点击运行，刷新页面可以看到我们的页面已经显示正常了。</p>
<h3 id="拷贝登录页面到template"><a href="#拷贝登录页面到template" class="headerlink" title="拷贝登录页面到template"></a>拷贝登录页面到template</h3><p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/161.png" alt="mark"></p>
<p>使用ctrl+f查找出所有<code>../</code>,全部替换为<code>/static/</code></p>
<blockquote>
<p>将css，js，图片全部替换完。</p>
</blockquote>
<h4 id="url配置跳转登录页面"><a href="#url配置跳转登录页面" class="headerlink" title="url配置跳转登录页面"></a>url配置跳转登录页面</h4><p>Mxonline2/urls.py：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 登录页面跳转url</span><br><span class="line">url(&#39;^login&#x2F;$&#39;, TemplateView.as_view(template_name&#x3D;&quot;login.html&quot;), name&#x3D;&quot;login&quot;)</span><br></pre></td></tr></table></figure>

<p>Mxonline3/urls.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># TemplateView.as_view会将template转换为view</span><br><span class="line">path(&#39;&#39;, TemplateView.as_view(template_name&#x3D; &quot;index.html&quot;), name&#x3D;  &quot;index&quot;),</span><br><span class="line">path(&#39;login&#x2F;&#39;, TemplateView.as_view(template_name&#x3D; &quot;login.html&quot;), name&#x3D;  &quot;login&quot;)</span><br></pre></td></tr></table></figure>

<p>在index页面，ctrl+f找到登录。将a标签中地址替换为login的url。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/162.png" alt="mark"></p>
<p>取消注释后，将login.html改为<code>/login/</code></p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/163.png" alt="mark"></p>
<p>点击左侧减号收起。然后使用<code>&lt;!--</code>与<code>--&gt;</code>将个人中心暂时注释。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/164.png" alt="mark"></p>
<p>可以看到登录注册，点击登录。</p>
<blockquote>
<p>根路径下的所有url都不需要斜杠</p>
<p>此时我们的首页已经可以成功显示，通过首页点击登录也可以成功跳转登录页面</p>
</blockquote>
<h2 id="用户登录-1"><a href="#用户登录-1" class="headerlink" title="用户登录-1"></a>用户登录-1</h2><p>Django的view实际就是一个函数，接收request请求对象，处理后返回response对象。</p>
<p>users/views.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line"># 当我们配置url被这个view处理时，自动传入request对象.</span><br><span class="line">def login(request):</span><br><span class="line">    # 前端向后端发送的请求方式: get 或post</span><br><span class="line"></span><br><span class="line">    # 登录提交表单为post</span><br><span class="line">    if request.method &#x3D;&#x3D; &quot;POST&quot;:</span><br><span class="line">        pass</span><br><span class="line">    # 获取登录页面为get</span><br><span class="line">    elif request.method &#x3D;&#x3D; &quot;GET&quot;:</span><br><span class="line">        # render就是渲染html返回用户</span><br><span class="line">        # render三变量: request 模板名称 一个字典写明传给前端的值</span><br><span class="line">        return render(request, &quot;login.html&quot;, &#123;&#125;)</span><br></pre></td></tr></table></figure>

<p>django1.9.8/urls.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from users.views import user_login</span><br><span class="line">    # 登录页面跳转url login不要直接调用。而只是指向这个函数对象。</span><br><span class="line">    url(&#39;^login&#x2F;$&#39;,login, name&#x3D;&quot;login&quot;)</span><br></pre></td></tr></table></figure>

<p>django2.0.1/urls.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from users.views import login</span><br><span class="line">    path(&#39;login&#x2F;&#39;, login, name&#x3D;&quot;login&quot;)</span><br></pre></td></tr></table></figure>

<p>在两行返回语句的位置打上断点:</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/165.png" alt="mark"></p>
<p>点击debug，进入首页后点击登录。可以看到</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/166.png" alt="mark"></p>
<p>说明确实是通过get请求请求页面的。</p>
<p>通过值浏览器窗口可以看到这是一个<code>&lt;WSGIRequest: GET &#39;/login/&#39;&gt;</code>对象</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/167.png"></p>
<h2 id="用户登录2"><a href="#用户登录2" class="headerlink" title="用户登录2"></a>用户登录2</h2><h3 id="html-form基础知识"><a href="#html-form基础知识" class="headerlink" title="html form基础知识"></a>html form基础知识</h3><p>templates/login.html:</p>
<blockquote>
<p>可以看到form表单中有input。点击提交会把值提交到后台。我们需要修改action让它指向我们的后台相应地址。</p>
</blockquote>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/168.png" alt="mark"></p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/169.png" alt="mark"></p>
<blockquote>
<p>input中的name值会被传递到后台。回组成键值对形式。</p>
</blockquote>
<p>submit类型的input</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/170.png"></p>
<p>只保留post这里的断点。输入用户名密码。查看debug情况</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/171.png" alt="mark"></p>
<p><code>403禁止访问</code>错误: html页面内必须加上<code>crsf token</code> 才能传值到后台。</p>
<blockquote>
<p>我会随机的给前端发一串符号，你必须把这串符号带回来，我才允许你post。</p>
</blockquote>
<p>![</p>
<p>mark](Django-Xadmin开发在线学习平台/172.png)</p>
<p>from表单之前写上<code>crsf token</code></p>
<p>此时我们查看前端页面：</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/173.png"></p>
<p>可以看到html中登录下面有一个隐藏着的值：crsf token, 不会显示。</p>
<p>此时点击登录跳转到pass位置。</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/174.png" alt="mark"></p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/175.png" alt="mark"></p>
<p>可以看到request中的POST中是一个queryset的对象。我们可以把它当成一个字典来用。<br>来取到前端的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if request.method &#x3D;&#x3D; &quot;POST&quot;:</span><br><span class="line">    # 取不到时为空，username，password为前端页面name值</span><br><span class="line">    user_name &#x3D; request.POST.get(&quot;username&quot;, &quot;&quot;)</span><br><span class="line">    pass_word &#x3D; request.POST.get(&quot;password&quot;, &quot;&quot;)</span><br></pre></td></tr></table></figure>

<p>取到用户名和密码我们就要开始进行验证登录。使用Django自带的<code>auth</code>方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from django.contrib.auth import authenticate, login</span><br><span class="line"></span><br><span class="line">    # 登录提交表单为post</span><br><span class="line">    if request.method &#x3D;&#x3D; &quot;POST&quot;:</span><br><span class="line">         # 取不到时为空，username，password为前端页面name值</span><br><span class="line">        user_name &#x3D; request.POST.get(&quot;username&quot;, &quot;&quot;)</span><br><span class="line">        pass_word &#x3D; request.POST.get(&quot;password&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">        # 成功返回user对象,失败返回null</span><br><span class="line">        user &#x3D; authenticate(username&#x3D; user_name, password&#x3D; pass_word)</span><br><span class="line"></span><br><span class="line">        # 如果不是null说明验证成功</span><br><span class="line">        if user is not None:</span><br><span class="line">            # login_in 两参数：request, user</span><br><span class="line">            # 实际是对request写了一部分东西进去，然后在render的时候：</span><br><span class="line">            # request是要render回去的。这些信息也就随着返回浏览器。完成登录</span><br><span class="line">            login(request, user)</span><br><span class="line">            # 跳转到首页 user request会被带回到首页</span><br><span class="line">            return render(request, &quot;index.html&quot;)</span><br><span class="line">        # 没有成功说明里面的值是None，并再次跳转回主页面</span><br><span class="line">        else:</span><br><span class="line">            return render(request, &quot;login.html&quot;, &#123;&#125;)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>authenticate调用只需要传入用户名和密码。成功会返回user对象，失败返回null </p>
</blockquote>
<p>html中通过</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/176.png"></p>
<blockquote>
<p>设置成如果登录显示个人中心那段，未登录显示登录注册</p>
</blockquote>
<p>打上断点</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/177.png"></p>
<p>点击debug后可以看到</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/178.png" alt="mark"></p>
<blockquote>
<p>我们成功的取到了值。</p>
</blockquote>
<p>Django默认我们使用用户名和密码来登录</p>
<p>成功的登录user值如下</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/179.png" alt="mark"></p>
<p>但是继续执行报错:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login() takes exactly 1 argument (2 given)</span><br></pre></td></tr></table></figure>

<p>这时因为我们处理登录的自定义函数也叫login。就直接调用了自身，而不是调用Django提供的login。<strong>所以我们一定不要把自定义view函数命名与Django提供的冲突</strong></p>
<blockquote>
<p>解决方案：将我们的login改为<code>def user_login(request):</code></p>
</blockquote>
<p>并且前往urls.py中将login也一并改了</p>
<p>此时运行可以看到我们的个人中心已经出来了。</p>
<h3 id="改造为使用邮箱用户名均可。Setting中重载变量"><a href="#改造为使用邮箱用户名均可。Setting中重载变量" class="headerlink" title="改造为使用邮箱用户名均可。Setting中重载变量"></a>改造为使用邮箱用户名均可。Setting中重载变量</h3><blockquote>
<p>自定义authenticate方法</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from django.contrib.auth.backends import ModelBackend</span><br><span class="line">from .models import UserProfile</span><br><span class="line"># 并集运算</span><br><span class="line">from django.db.models import Q</span><br><span class="line"></span><br><span class="line"># 实现用户名邮箱均可登录</span><br><span class="line"># 继承ModelBackend类，因为它有方法authenticate，可点进源码查看</span><br><span class="line">class CustomBackend(ModelBackend):</span><br><span class="line">    def authenticate(self, username&#x3D;None, password&#x3D;None, **kwargs):</span><br><span class="line">        try:</span><br><span class="line">            # 不希望用户存在两个，get只能有一个。两个是get失败的一种原因 Q为使用并集查询</span><br><span class="line"></span><br><span class="line">            user &#x3D; UserProfile.objects.get(Q(username&#x3D;username)|Q(email&#x3D;username))</span><br><span class="line"></span><br><span class="line">            # django的后台中密码加密：所以不能password&#x3D;&#x3D;password</span><br><span class="line">            # UserProfile继承的AbstractUser中有def check_password(self, raw_password):</span><br><span class="line"></span><br><span class="line">            if user.check_password(password):</span><br><span class="line">                return user</span><br><span class="line">        except Exception as e:</span><br><span class="line">            return None</span><br></pre></td></tr></table></figure>

<p>Mxonline2/settings.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 设置邮箱和用户名均可登录</span><br><span class="line">AUTHENTICATION_BACKENDS &#x3D; (</span><br><span class="line">    &#39;users.views.CustomBackend&#39;,</span><br><span class="line"></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/180.png" alt="mark"></p>
<blockquote>
<p>使用xadmin的退出，注销当前用户的退出。</p>
</blockquote>
<p>此时我们可以通过邮箱和用户名都可以完成登录。</p>
<h3 id="用户提示：return页面时提供它的错误信息"><a href="#用户提示：return页面时提供它的错误信息" class="headerlink" title="用户提示：return页面时提供它的错误信息"></a>用户提示：return页面时提供它的错误信息</h3><p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/181.png%5D" alt="mark"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">return render(request, &quot;login.html&quot;, &#123;&quot;msg&quot;:&quot;用户名或密码错误! &quot;&#125;)</span><br></pre></td></tr></table></figure>

<p>Html中如何取到这个值;</p>
<p>login html中这段是用来做错误提示的。</p>
<p><a target="_blank" rel="noopener" href="http://myphoto.mtianyan.cn/blog/180110/3i7BF5edj8.png?imageslim"><img src="http://myphoto.mtianyan.cn/blog/180110/3i7BF5edj8.png?imageslim" alt="mark"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class&#x3D;&quot;error btns login-form-tips&quot; id&#x3D;&quot;jsLoginTips&quot;&gt;&#123;&#123; msg &#125;&#125;&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure>

<p>验证：</p>
<p><a target="_blank" rel="noopener" href="http://myphoto.mtianyan.cn/blog/180110/7I9gdJ5DLj.png?imageslim"><img src="http://myphoto.mtianyan.cn/blog/180110/7I9gdJ5DLj.png?imageslim" alt="mark"></a></p>
<h2 id="用form实现登录-1"><a href="#用form实现登录-1" class="headerlink" title="用form实现登录-1"></a>用form实现登录-1</h2><p>上面我们的用户登录的方法是基于函数来做的。本节我们做一个基于类方法的版本。<br>要求对类的继承有了解。</p>
<p>基础教程中基本上都是基于函数来做的，其实更推荐基于类来做。基于类可以带来不少好处</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 基于类实现需要继承的view</span><br><span class="line">from django.views.generic.base import View</span><br><span class="line">class LoginView(View):</span><br><span class="line">    # 直接调用get方法免去判断</span><br><span class="line">    def get(self, request):</span><br><span class="line">        # render就是渲染html返回用户</span><br><span class="line">        # render三变量: request 模板名称 一个字典写明传给前端的值</span><br><span class="line">        return render(request, &quot;login.html&quot;, &#123;&#125;)</span><br><span class="line">    def post(self, request):</span><br><span class="line">        # 取不到时为空，username，password为前端页面name值</span><br><span class="line">        user_name &#x3D; request.POST.get(&quot;username&quot;, &quot;&quot;)</span><br><span class="line">        pass_word &#x3D; request.POST.get(&quot;password&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">        # 成功返回user对象,失败返回null</span><br><span class="line">        user &#x3D; authenticate(username&#x3D;user_name, password&#x3D;pass_word)</span><br><span class="line"></span><br><span class="line">        # 如果不是null说明验证成功</span><br><span class="line">        if user is not None:</span><br><span class="line">            # login_in 两参数：request, user</span><br><span class="line">            # 实际是对request写了一部分东西进去，然后在render的时候：</span><br><span class="line">            # request是要render回去的。这些信息也就随着返回浏览器。完成登录</span><br><span class="line">            login(request, user)</span><br><span class="line">            # 跳转到首页 user request会被带回到首页</span><br><span class="line">            return render(request, &quot;index.html&quot;)</span><br><span class="line">        # 没有成功说明里面的值是None，并再次跳转回主页面</span><br><span class="line">        else:</span><br><span class="line">            return render(request, &quot;login.html&quot;, &#123;&quot;msg&quot;: &quot;用户名或密码错误! &quot;&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-523a287af519d5c8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/686" alt="img"></p>
<p>mark</p>
<blockquote>
<p>继承的view中的方法。</p>
</blockquote>
<p>django1.9.8 urls中的配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 换用类实现</span><br><span class="line">from users.views import LoginView</span><br><span class="line">    # 基于类方法实现登录,这里是调用它的方法</span><br><span class="line">    url(&#39;^login&#x2F;$&#39;, LoginView.as_view(), name&#x3D;&quot;login&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Django2.0.1 urls配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 基于类方法实现登录,这里是调用它的方法</span><br><span class="line">path(&#39;login&#x2F;&#39;, LoginView.as_view(), name&#x3D;&quot;login&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="form字段验证"><a href="#form字段验证" class="headerlink" title="form字段验证"></a>form字段验证</h2><p>验证最大长度，是否为空等一系列。</p>
<p>users下新建forms文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line"># 引入Django表单</span><br><span class="line">from  django import forms</span><br><span class="line"></span><br><span class="line"># 登录表单验证</span><br><span class="line">class LoginForm(forms.Form):</span><br><span class="line">    # 用户名密码不能为空</span><br><span class="line">    username &#x3D; forms.CharField(required&#x3D;True)</span><br><span class="line">    password &#x3D; forms.CharField(required&#x3D;True, min_length&#x3D;5)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>定义好forms之后我们来使用它做验证。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">def post(self, request):</span><br><span class="line">        # 类实例化需要一个字典参数dict:request.POST就是一个QueryDict所以直接传入</span><br><span class="line">        # POST中的usernamepassword，会对应到form中</span><br><span class="line">        login_form &#x3D; LoginForm(request.POST)</span><br><span class="line">        #is_valid判断我们字段是否有错执行我们原有逻辑，验证失败跳回login页面</span><br><span class="line">        if login_form.is_valid():</span><br><span class="line">            # 取不到时为空，username，password为前端页面name值</span><br><span class="line">            user_name &#x3D; request.POST.get(&quot;username&quot;, &quot;&quot;)</span><br><span class="line">            pass_word &#x3D; request.POST.get(&quot;password&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">            # 成功返回user对象,失败返回null</span><br><span class="line">            user &#x3D; authenticate(username&#x3D;user_name, password&#x3D;pass_word)</span><br><span class="line"></span><br><span class="line">            # 如果不是null说明验证成功</span><br><span class="line">            if user is not None:</span><br><span class="line">                # login_in 两参数：request, user</span><br><span class="line">                # 实际是对request写了一部分东西进去，然后在render的时候：</span><br><span class="line">                # request是要render回去的。这些信息也就随着返回浏览器。完成登录</span><br><span class="line">                login(request, user)</span><br><span class="line">                # 跳转到首页 user request会被带回到首页</span><br><span class="line">                return render(request, &quot;index.html&quot;)</span><br><span class="line">        # 验证不成功跳回登录页面</span><br><span class="line">        # 没有成功说明里面的值是None，并再次跳转回主页面</span><br><span class="line">        else:</span><br><span class="line">            return render(request, &quot;login.html&quot;, &#123;&quot;msg&quot;: &quot;用户名或密码错误! &quot;&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="完善错误提示"><a href="#完善错误提示" class="headerlink" title="完善错误提示"></a>完善错误提示</h3><p>比如：既然表单都验证失败了，就不用显示密码出错了</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-9d9f75e4719061c4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/516" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 仅当用户真的密码出错时</span><br><span class="line">            else:</span><br><span class="line">                return render(request, &quot;login.html&quot;,&#123;&quot;msg&quot;:&quot;用户名或密码错误!&quot;&#125;)</span><br><span class="line">        # 验证不成功跳回登录页面</span><br><span class="line">        # 没有成功说明里面的值是None，并再次跳转回主页面</span><br><span class="line">        else:</span><br><span class="line">            return render(</span><br><span class="line">                request, &quot;login.html&quot;, &#123;</span><br><span class="line">                    &quot;login_form&quot;: login_form &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>forms中的名称username和password必须和html中的一致。毕竟他是使用的request.POST<br>而request是从前面传过来的。</p>
<p>实例化<code>LoginView</code>时已经对于我们的字段进行了验证。</p>
<p>打上断点:</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-48097f9c52012320.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/271" alt="img"></p>
<p><code>debug</code>后<code>f6</code>运行到</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-96d68c21c7bc2798.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/396" alt="img"></p>
<p>此时可以看到<code>errors(ErrorDict)</code>中的错误</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-79c518169c71f76a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/638" alt="img"></p>
<p>将form传回前端:</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-b21a22404e83f9a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/442" alt="img"></p>
<p>前端中取值：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-621f2a96dc923313.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/452" alt="img"></p>
<p>给这个class加上errorput会显示红色外框。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-ce9082d461fe20e2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<blockquote>
<p>注意:写在class里面</p>
</blockquote>
<h3 id="将forms错误信息显示出来"><a href="#将forms错误信息显示出来" class="headerlink" title="将forms错误信息显示出来"></a>将forms错误信息显示出来</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class&#x3D;&quot;error btns login-form-tips&quot; id&#x3D;&quot;jsLoginTips&quot;&gt;</span><br><span class="line">&#123;% for key, error in login_form.errors.items %&#125;</span><br><span class="line">&#123;&#123; error &#125;&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&#123;&#123; msg &#125;&#125;&lt;&#x2F;div&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-37c1b309dc808918.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/347" alt="img"></p>
<ul>
<li>写了一个类继承Django的view，然后写了get post方法(get/post的if是Django替我们完成的)</li>
<li>在url中调用Loginview的as_view方法需要加上括号，进行调用。</li>
<li>Django的form进行表单验证并把error值传到前台。</li>
<li>is_valid方法，验证表单</li>
</ul>
<h2 id="session和cookie自动登录机制"><a href="#session和cookie自动登录机制" class="headerlink" title="session和cookie自动登录机制"></a>session和cookie自动登录机制</h2><blockquote>
<p>我们本节来讲session和cookie</p>
</blockquote>
<p>User1如何实现登录的。</p>
<h3 id="cookie的存储"><a href="#cookie的存储" class="headerlink" title="cookie的存储"></a>cookie的存储</h3><p>cookie是浏览器支持的一种本地存储方式。以dict，键值对方式存储。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;sessionkey&quot;: &quot;123&quot;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>浏览器会自动对于它进行解析。</p>
<h3 id="http请求是一种无状态的请求"><a href="#http请求是一种无状态的请求" class="headerlink" title="http请求是一种无状态的请求"></a>http请求是一种无状态的请求</h3><p>用户向服务器发起的两次请求之间是没有状态的。也就是服务器并不知道这是同一个用户发的。</p>
<p>做到记住用户:</p>
<blockquote>
<p>浏览器a在向服务器发起请求，服务器会自动给浏览器a回复一个id，浏览器a把id放到cookie当中，在下一次请求时带上这个cookie里的id值向浏览器请求，服务器就知道你是哪个浏览器发过来的了。</p>
</blockquote>
<h3 id="有状态请求-cookie"><a href="#有状态请求-cookie" class="headerlink" title="有状态请求(cookie)"></a>有状态请求(cookie)</h3><p><img src="https://upload-images.jianshu.io/upload_images/1779926-612243ba21241503.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/431" alt="img"></p>
<p>服务器<code>a</code>发回来的<code>id</code>会放到服务器<code>a</code>的域之下。<strong>不能跨域访问cookie。</strong></p>
<p>使用浏览器随便打开一个网页，然后<code>f12</code>打开。</p>
<p>比如我使用的<code>Chrome</code>浏览器</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-3550753a280509f1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p>会找到存储在浏览器本地的cookie值</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-96e7d37b5ccd3d4b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/103" alt="img"></p>
<p>mark</p>
<p>点击<code>clear all</code>清空所有的<code>cookie</code> <code>f5</code>刷新页面，会发现又把这些cookie值进来。</p>
<p>如果将用户名和密码直接保存在cookie，可以实现<strong>最垃圾最简略版本的</strong>自动登录。</p>
<h3 id="解决cookie放在本地不安全的问题-session"><a href="#解决cookie放在本地不安全的问题-session" class="headerlink" title="解决cookie放在本地不安全的问题(session)"></a>解决cookie放在本地不安全的问题(session)</h3><blockquote>
<p>用户在第一次请求后，浏览器回复的id既可以是用户的user id。<br>也可以一段任意的字符串，我们把它叫做session id</p>
</blockquote>
<p>根据用户名和密码，服务器会采用自己的规则生成<code>session id</code>。这个<code>session id</code>保存在本地cookie。浏览器请求服务器会携带。</p>
<ul>
<li>输入用户名 &amp; 密码</li>
<li>调用 login(), 后端程序会根据用户名密码生成session id。保存在数据库中。</li>
<li>用户登录之后，需要通过这个<code>session id</code>取出这些基本信息。</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-3700e1f80a155853.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/211" alt="img"></p>
<p>Django的默认表中的<code>session</code>表就记录了用户登录时，后端我们Django为用户生成的<code>sessionid</code>。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-6adaef92f2d7fd1c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/486" alt="img"></p>
<p>可以看到<code>session key value</code> 和过期时间。</p>
<p>我们可以清空这张表的数据。运行项目进行登录。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-f3f30181ba569b11.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/624" alt="img"></p>
<blockquote>
<p>可以看到我们刚刚生成的session id。</p>
</blockquote>
<p>此时通过<code>f12</code>查看浏览器在本地存储的<code>session id</code>。可以看到如下图和我们数据库中的一致。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-c415c354a473ea3a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/394" alt="img"></p>
<blockquote>
<p><strong>session_key 发到浏览器叫做session id</strong></p>
</blockquote>
<p>通过session id 用户访问任何一个页面都会携带，服务器就会认识。</p>
<p>Setting.py中，</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-5b7d25dd2d20459e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/256" alt="img"></p>
<p>这个app会拦截我们每次的request请求，在<code>request</code>中找到session id，然后去数据表中进行查询。<br>然后通过<code>session key</code> 去找到<code>session data</code>。此时直接为我们取出了user。</p>
<p>在服务器返回浏览器的<code>response</code>中也会直接加上<code>session id</code></p>
<blockquote>
<p>cookie是浏览器本地存储机制，存在域名之下，存储不安全。<br>服务器在返回id时通过规则生成一串字符，并设置了过期时间。存储在服务器端(数据库)</p>
</blockquote>
<p>文章: <a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=http://projectsedu.com/2016/10/17/django%25E4%25BB%258E%25E8%25AF%25B7%25E6%25B1%2582%25E5%2588%25B0%25E8%25BF%2594%25E5%259B%259E%25E9%2583%25BD%25E7%25BB%258F%25E5%258E%2586%25E4%25BA%2586%25E4%25BB%2580%25E4%25B9%2588/">http://projectsedu.com/2016/10/17/django%E4%BB%8E%E8%AF%B7%E6%B1%82%E5%88%B0%E8%BF%94%E5%9B%9E%E9%83%BD%E7%BB%8F%E5%8E%86%E4%BA%86%E4%BB%80%E4%B9%88/</a></p>
<h2 id="用户注册"><a href="#用户注册" class="headerlink" title="用户注册"></a>用户注册</h2><h3 id="拷贝注册页面进入template目录"><a href="#拷贝注册页面进入template目录" class="headerlink" title="拷贝注册页面进入template目录"></a>拷贝注册页面进入template目录</h3><h3 id="书写我们对应要处理的view-RegisterView"><a href="#书写我们对应要处理的view-RegisterView" class="headerlink" title="书写我们对应要处理的view(RegisterView)"></a>书写我们对应要处理的view(RegisterView)</h3><p>users/views.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 注册功能的view</span><br><span class="line">class RegisterView(View):</span><br><span class="line">    # get方法直接返回页面</span><br><span class="line">    def get(self, request):</span><br><span class="line">        return render(request, &quot;register.html&quot;, &#123;&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="配置对应的url"><a href="#配置对应的url" class="headerlink" title="配置对应的url"></a>配置对应的url</h3><p>Django1.9.8 url配置如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from users.views import RegisterView</span><br><span class="line">    # 注册url</span><br><span class="line">    url(&quot;^register&#x2F;&quot;, RegisterView.as_view(), name&#x3D;&quot;register&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Django2.0.1 url配置如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from users.views import RegisterView</span><br><span class="line">    # 注册url</span><br><span class="line">    path(&quot;register&#x2F;&quot;, RegisterView.as_view(), name &#x3D; &quot;register&quot; )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="修改index页面中注册url"><a href="#修改index页面中注册url" class="headerlink" title="修改index页面中注册url"></a>修改index页面中注册url</h3><p><img src="https://upload-images.jianshu.io/upload_images/1779926-2b919a69f0233b4a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/460" alt="img"></p>
<p>此时访问首页发现可以成功跳转到注册页面</p>
<h3 id="修改静态文件中static目录引用"><a href="#修改静态文件中static目录引用" class="headerlink" title="修改静态文件中static目录引用"></a>修改静态文件中static目录引用</h3><h4 id="关键步骤load-staticfile"><a href="#关键步骤load-staticfile" class="headerlink" title="关键步骤load staticfile"></a>关键步骤load staticfile</h4><p><img src="https://upload-images.jianshu.io/upload_images/1779926-54963c9fe084328e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/180" alt="img"></p>
<h4 id="然后修改路径为一个相对于static的相对路径"><a href="#然后修改路径为一个相对于static的相对路径" class="headerlink" title="然后修改路径为一个相对于static的相对路径"></a>然后修改路径为一个相对于static的相对路径</h4><p><img src="https://upload-images.jianshu.io/upload_images/1779926-0f5c7eb3eede49dc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/445" alt="img"></p>
<blockquote>
<p>他会自动根据setting中配置，为我们加上前缀</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-a7458ede39349ebe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/277" alt="img"></p>
<blockquote>
<p>如果我们把目录在setting中改到mystatic。url中会自动添加指定的前缀</p>
</blockquote>
<p>可以看到可以访问成功。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-876bdc127ef9ed99.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/365" alt="img"></p>
<h4 id="将目前的三个html中的静态文件全部修改目录"><a href="#将目前的三个html中的静态文件全部修改目录" class="headerlink" title="将目前的三个html中的静态文件全部修改目录"></a>将目前的三个html中的静态文件全部修改目录</h4><blockquote>
<p>枯燥但是要有耐心。</p>
</blockquote>
<p>这时候访问三个页面，查看样式是否完好。</p>
<h3 id="验证码库实现验证码"><a href="#验证码库实现验证码" class="headerlink" title="验证码库实现验证码"></a>验证码库实现验证码</h3><p><a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=https://github.com/mbi/django-simple-captcha">https://github.com/mbi/django-simple-captcha</a></p>
<h4 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">workon mxonline3</span><br><span class="line">pip install  django-simple-captcha</span><br><span class="line">workon mxonline2</span><br><span class="line">pip install  django-simple-captcha&#x3D;&#x3D;0.4.6</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Add <code>captcha</code> to the <code>INSTALLED_APPS</code> in your <code>settings.py</code></li>
<li>Add an entry to your <code>urls.py</code>:</li>
</ul>
<p>django1.9.8如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from django.conf.urls import url, include</span><br><span class="line">urlpatterns +&#x3D; [</span><br><span class="line">    url(r&#39;^captcha&#x2F;&#39;, include(&#39;captcha.urls&#39;)),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>django2.0.1如下；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 验证码url</span><br><span class="line">path(&quot;captcha&#x2F;&quot;, include(&#39;captcha.urls&#39;))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-63535fda53aa7a8d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/361" alt="img"></p>
<p>进入数据库查看生成的表</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-fdda273afbbf264c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/186" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-bc61d5637f17f61d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/450" alt="img"></p>
<h3 id="将验证码展示到页面"><a href="#将验证码展示到页面" class="headerlink" title="将验证码展示到页面"></a>将验证码展示到页面</h3><p>users/forms.py:</p>
<h4 id="定义我们的register-form"><a href="#定义我们的register-form" class="headerlink" title="定义我们的register form:"></a>定义我们的register form:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 引入验证码field</span><br><span class="line">from captcha.fields import CaptchaField</span><br><span class="line"></span><br><span class="line"># 验证码form &amp; 注册表单form</span><br><span class="line">class RegisterForm(forms.Form):</span><br><span class="line">    # 此处email与前端name需保持一致。</span><br><span class="line">    email &#x3D; forms.EmailField(required&#x3D;True)</span><br><span class="line">    # 密码不能小于5位</span><br><span class="line">    password &#x3D; forms.CharField(required&#x3D;True, min_length&#x3D;5)</span><br><span class="line">    # 应用验证码</span><br><span class="line">    captcha &#x3D; CaptchaField()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>users/views.py</p>
<h4 id="在我们的registerform中实例化并传送到前端"><a href="#在我们的registerform中实例化并传送到前端" class="headerlink" title="在我们的registerform中实例化并传送到前端:"></a>在我们的registerform中实例化并传送到前端:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># form表单验证 &amp; 验证码</span><br><span class="line">from .forms import LoginForm, RegisterForm</span><br><span class="line"></span><br><span class="line"># 注册功能的view</span><br><span class="line">class RegisterView(View):</span><br><span class="line">    # get方法直接返回页面</span><br><span class="line">    def get(self, request):</span><br><span class="line">        # 添加验证码</span><br><span class="line">        register_form &#x3D; RegisterForm()</span><br><span class="line">        return render(request, &quot;register.html&quot;, &#123;&#39;register_form&#39;:register_form&#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="前端获取验证码值"><a href="#前端获取验证码值" class="headerlink" title="前端获取验证码值"></a>前端获取验证码值</h4><p><img src="https://upload-images.jianshu.io/upload_images/1779926-29a9dcfaac567377.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/405" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-ce4ead1d1712af18.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p>找到上图验证码部分。修改为下图</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-dc61ed3ad7f84bc8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/298" alt="img"></p>
<p>Forms中的field会生成不同的框。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-9be9b7a201ab4149.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p>我们只有label但是前端可以查看到input框等，也就是Registerform会为我们生成输入框+验证码。</p>
<blockquote>
<p>隐藏的字符串的框会被带到后台，由Django为我们进行验证。验证该验证码是否保存过。</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-1c7789dbd803c837.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<blockquote>
<p>可以看得我们数据库中将这个hashkey进行了保存。这个key与验证码内容对应。</p>
</blockquote>
<p>后台会把验证码值 和 hashkey进行联合查询。</p>
<h3 id="编写register-view的后台逻辑-RegisterView"><a href="#编写register-view的后台逻辑-RegisterView" class="headerlink" title="编写register view的后台逻辑(RegisterView)"></a>编写register view的后台逻辑(RegisterView)</h3><p>users/views.py的RegisterView中添加post方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def post(self, request):</span><br><span class="line">    # 实例化form</span><br><span class="line">    register_form &#x3D; RegisterForm(request.POST)</span><br><span class="line">    if register_form.is_valid():</span><br><span class="line">        pass</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-064bcf57fdcf4e35.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/284" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-52220188cb9b03be.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/684" alt="img"></p>
<p>修改form表单提交方式与提交到哪个url</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-d080c1fe9346013b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/160" alt="img"></p>
<p>前端的form提交加上对应的crsf token</p>
<p>刷新验证码是前端帮我们完成的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;刷新验证码</span><br><span class="line">function refresh_captcha(event)&#123;</span><br><span class="line">    $.get(&quot;&#x2F;captcha&#x2F;refresh&#x2F;?&quot;+Math.random(), function(result)&#123;</span><br><span class="line">        $(&#39;#&#39;+event.data.form_id+&#39; .captcha&#39;).attr(&quot;src&quot;,result.image_url);</span><br><span class="line">        $(&#39;#id_captcha_0&#39;).attr(&quot;value&quot;,result.key);</span><br><span class="line">    &#125;);</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="获取前端页面值并封装成一个user-profile对象，保存到数据库。"><a href="#获取前端页面值并封装成一个user-profile对象，保存到数据库。" class="headerlink" title="获取前端页面值并封装成一个user_profile对象，保存到数据库。"></a>获取前端页面值并封装成一个user_profile对象，保存到数据库。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from django.contrib.auth.hashers import make_password</span><br><span class="line"></span><br><span class="line">        if register_form.is_valid():</span><br><span class="line">            user_name &#x3D; request.POST.get(&quot;email&quot;, &quot;&quot;)</span><br><span class="line">            pass_word &#x3D; request.POST.get(&quot;password&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">            # 实例化一个user_profile对象，将前台值存入</span><br><span class="line">            user_profile &#x3D; UserProfile()</span><br><span class="line">            user_profile.username &#x3D; user_name</span><br><span class="line">            user_profile.email &#x3D; user_name</span><br><span class="line"></span><br><span class="line">            # 加密password进行保存</span><br><span class="line">            user_profile.password &#x3D; make_password(pass_word)</span><br><span class="line">            user_profile.save()</span><br><span class="line">            pass</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="发送邮件实现"><a href="#发送邮件实现" class="headerlink" title="发送邮件实现"></a>发送邮件实现</h4><p>setting中配置；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 发送邮件的setting设置</span><br><span class="line"></span><br><span class="line">EMAIL_HOST &#x3D; &quot;smtp.qq.com&quot;</span><br><span class="line">EMAIL_PORT &#x3D; 25</span><br><span class="line">EMAIL_HOST_USER &#x3D; &quot;mxonline.mtianyan.cn&quot;</span><br><span class="line">EMAIL_HOST_PASSWORD &#x3D; &quot; &quot;</span><br><span class="line">EMAIL_USE_TLS&#x3D; True</span><br><span class="line">EMAIL_FROM &#x3D; &quot;mxonline.mtianyan.cn&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新建package后新建文件。</p>
<p><code>apps：utils/email_send.py</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from random import Random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">from  users.models import EmailVerifyRecord</span><br><span class="line"># 导入Django自带的邮件模块</span><br><span class="line">from django.core.mail import send_mail</span><br><span class="line"># 导入setting中发送邮件的配置</span><br><span class="line">from Mxonline2.settings import EMAIL_FROM</span><br><span class="line"></span><br><span class="line"># 生成随机字符串</span><br><span class="line">def random_str(random_length&#x3D;8):</span><br><span class="line">    str &#x3D; &#39;&#39;</span><br><span class="line">    # 生成字符串的可选字符串</span><br><span class="line">    chars &#x3D; &#39;AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz0123456789&#39;</span><br><span class="line">    length &#x3D; len(chars) - 1</span><br><span class="line">    random &#x3D; Random()</span><br><span class="line">    for i in range(random_length):</span><br><span class="line">        str +&#x3D; chars[random.randint(0, length)]</span><br><span class="line">    return str</span><br><span class="line"></span><br><span class="line"># 发送注册邮件</span><br><span class="line">def send_register_eamil(email, send_type&#x3D;&quot;register&quot;):</span><br><span class="line">    # 发送之前先保存到数据库，到时候查询链接是否存在</span><br><span class="line"></span><br><span class="line">    # 实例化一个EmailVerifyRecord对象</span><br><span class="line">    email_record &#x3D; EmailVerifyRecord()</span><br><span class="line">    # 生成随机的code放入链接</span><br><span class="line">    code &#x3D; random_str(16)</span><br><span class="line">    email_record.code &#x3D; code</span><br><span class="line">    email_record.email &#x3D; email</span><br><span class="line">    email_record.send_type &#x3D; send_type</span><br><span class="line"></span><br><span class="line">    email_record.save()</span><br><span class="line"></span><br><span class="line">    # 定义邮件内容:</span><br><span class="line">    email_title &#x3D; &quot;&quot;</span><br><span class="line">    email_body &#x3D; &quot;&quot;</span><br><span class="line"></span><br><span class="line">    if send_type &#x3D;&#x3D; &quot;register&quot;:</span><br><span class="line">        email_title &#x3D; &quot;mtianyan慕课小站 注册激活链接&quot;</span><br><span class="line">        email_body &#x3D; &quot;请点击下面的链接激活你的账号: http:&#x2F;&#x2F;127.0.0.1:8000&#x2F;active&#x2F;&#123;0&#125;&quot;.format(code)</span><br><span class="line"></span><br><span class="line">        # 使用Django内置函数完成邮件发送。四个参数：主题，邮件内容，从哪里发，接受者list</span><br><span class="line">        send_status &#x3D; send_mail(email_title, email_body, EMAIL_FROM, [email])</span><br><span class="line">        # 如果发送成功</span><br><span class="line">        if send_status:</span><br><span class="line">            pass</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-74f4c6aac6a70679.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/579" alt="img"></p>
<p>上图为qq邮箱开启smtp服务</p>
<p>点击生成授权码</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-ac8cdb71cd6039f1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/542" alt="img"></p>
<p>def post中加上发送邮件</p>
<p><code>users/views.py</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 发送邮件</span><br><span class="line">from utils.email_send import send_register_eamil</span><br><span class="line">            # 发送注册激活邮件</span><br><span class="line">            send_register_eamil(user_name, &quot;register&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>点击注册提交，因为我们没有return。一直在转圈圈。</p>
<p>但是数据库中已经添加了字段。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-ced978e9e13071a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p>可以看到我们的邮件已经被发送到邮箱中。</p>
<p>如果注册成功返回login页面:不成功，返回register页面并报错。</p>
<h4 id="完善错误提示。"><a href="#完善错误提示。" class="headerlink" title="完善错误提示。"></a>完善错误提示。</h4><blockquote>
<p>找猫画虎：将login中的错误提示搬运到register中来。</p>
</blockquote>
<ul>
<li>register_form的报错信息。</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-0eed72fabf78497d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/377" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-3c8f05712e18e8ad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/390" alt="img"></p>
<ul>
<li>邮箱 &amp; 密码 form验证</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-481623d4690362e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/374" alt="img"></p>
<h4 id="完善用户值回填逻辑"><a href="#完善用户值回填逻辑" class="headerlink" title="完善用户值回填逻辑"></a>完善用户值回填逻辑</h4><p><img src="https://upload-images.jianshu.io/upload_images/1779926-86fa87baca3e1066.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p>如果传回的有值则，显示传回来值。</p>
<p>密码也做同样操作</p>
<h4 id="修改默认的激活状态为false"><a href="#修改默认的激活状态为false" class="headerlink" title="修改默认的激活状态为false"></a>修改默认的激活状态为false</h4><p>post方法中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 默认激活状态为false</span><br><span class="line">user_profile.is_active &#x3D; False</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>书写处理激活的view。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 激活用户的view</span><br><span class="line">class ActiveUserView(View):</span><br><span class="line">    def get(self, request, active_code):</span><br><span class="line">        # 查询邮箱验证记录是否存在</span><br><span class="line">        all_record &#x3D; EmailVerifyRecord.objects.filter(code &#x3D; active_code)</span><br><span class="line">        # 激活form负责给激活跳转进来的人加验证码</span><br><span class="line">        active_form &#x3D; ActiveForm(request.GET)</span><br><span class="line">        # 如果不为空也就是有用户</span><br><span class="line">        if all_record:</span><br><span class="line">            for record in all_record:</span><br><span class="line">                # 获取到对应的邮箱</span><br><span class="line">                email &#x3D; record.email</span><br><span class="line">                # 查找到邮箱对应的user</span><br><span class="line">                user &#x3D; UserProfile.objects.get(email&#x3D;email)</span><br><span class="line">                user.is_active &#x3D; True</span><br><span class="line">                user.save()</span><br><span class="line">                # 激活成功跳转到登录页面</span><br><span class="line">                return render(request, &quot;login.html&quot;, )</span><br><span class="line">        # 自己瞎输的验证码</span><br><span class="line">        else:</span><br><span class="line">            return render(request, &quot;register.html&quot;, &#123;&quot;msg&quot;: &quot;您的激活链接无效&quot;,&quot;active_form&quot;: active_form&#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置用户激活的url并通过url提取到变量:</p>
<p>django1.9.8:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 激活用户url</span><br><span class="line">url(r&#39;^active&#x2F;(?P&lt;active_code&gt;.*)&#x2F;$&#39;,ActiveUserView.as_view(), name&#x3D; &quot;user_active&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>django2.0.1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 激活用户url</span><br><span class="line">re_path(&#39;active&#x2F;(?P&lt;active_code&gt;.*)&#x2F;&#39;, ActiveUserView.as_view(), name&#x3D; &quot;user_active&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里通过<code>?p</code>将后面<code>.*</code>代表全部提取的正则，符合的内容传入参数active_code中<code>/$</code>代表以<code>/$</code>为结尾</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-0c97bd29b85eac60.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/552" alt="img"></p>
<blockquote>
<p>其他细节根据自己需要进行优化。</p>
</blockquote>
<p>注册功能制作完毕。</p>
<h2 id="密码找回"><a href="#密码找回" class="headerlink" title="密码找回"></a>密码找回</h2><h3 id="拷入forgetpassword页面"><a href="#拷入forgetpassword页面" class="headerlink" title="拷入forgetpassword页面"></a>拷入forgetpassword页面</h3><h3 id="书写处理忘记密码的view"><a href="#书写处理忘记密码的view" class="headerlink" title="书写处理忘记密码的view"></a>书写处理忘记密码的view</h3><p>users/views.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 用户忘记密码的处理view</span><br><span class="line">class ForgetPwdView(View):</span><br><span class="line">    # get方法直接返回页面</span><br><span class="line">    def get(self, request):</span><br><span class="line">        return render(request, &quot;forgetpwd.html&quot;, &#123; &#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>django2.0.1 urls中配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 忘记密码</span><br><span class="line">path(&#39;forget&#x2F;&#39;, ForgetPwdView.as_view(), name&#x3D; &quot;forget_pwd&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Django1.9.8 urls中配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 忘记密码</span><br><span class="line">url(&#39;forget&#x2F;$&#39;, ForgetPwdView.as_view(), name&#x3D;&quot;forget_pwd&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="login-html中忘记密码"><a href="#login-html中忘记密码" class="headerlink" title="login html中忘记密码"></a>login html中忘记密码</h4><p><img src="https://upload-images.jianshu.io/upload_images/1779926-d744609e96a86e01.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/395" alt="img"></p>
<h4 id="配置忘记密码页面中静态文件。"><a href="#配置忘记密码页面中静态文件。" class="headerlink" title="配置忘记密码页面中静态文件。"></a>配置忘记密码页面中静态文件。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">load static</span><br><span class="line">修改static的目录</span><br><span class="line">修改其中的url</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="定义一个给forget的form"><a href="#定义一个给forget的form" class="headerlink" title="定义一个给forget的form"></a>定义一个给forget的form</h4><p>users/forms.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 注册验证码实现</span><br><span class="line">class ForgetForm(forms.Form):</span><br><span class="line">    # 此处email与前端name需保持一致。</span><br><span class="line">    email &#x3D; forms.EmailField(required&#x3D;True)</span><br><span class="line">    # 应用验证码 自定义错误输出key必须与异常一样</span><br><span class="line">    captcha &#x3D; CaptchaField(error_messages&#x3D;&#123;&quot;invalid&quot;: u&quot;验证码错误&quot;&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="添加验证码"><a href="#添加验证码" class="headerlink" title="添加验证码"></a>添加验证码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 用户忘记密码的处理view</span><br><span class="line">class ForgetPwdView(View):</span><br><span class="line">    # get方法直接返回页面</span><br><span class="line">    def get(self, request):</span><br><span class="line">        forget_from &#x3D; ForgetForm()</span><br><span class="line">        return render(request, &quot;forgetpwd.html&quot;, &#123;&quot;forget_from&quot;:forget_from &#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="html中加上验证码"><a href="#html中加上验证码" class="headerlink" title="html中加上验证码"></a>html中加上验证码</h4><p><img src="https://upload-images.jianshu.io/upload_images/1779926-ac402410d27431d9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/391" alt="img"></p>
<h4 id="post中逻辑"><a href="#post中逻辑" class="headerlink" title="post中逻辑"></a>post中逻辑</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># post方法实现</span><br><span class="line">def post(self, request):</span><br><span class="line">    forget_form &#x3D; ForgetForm(request.POST)</span><br><span class="line">    # form验证合法情况下取出email</span><br><span class="line">    if forget_form.is_valid():</span><br><span class="line">        email &#x3D; request.POST.get(&quot;email&quot;,&quot;&quot;)</span><br><span class="line">        # 发送找回密码邮件</span><br><span class="line">        send_register_eamil(email, &quot;forget&quot;)</span><br><span class="line">        # 发送完毕返回登录页面并显示发送邮件成功。</span><br><span class="line">        return render(request, &quot;login.html&quot;, &#123;&quot;msg&quot;:&quot;重置密码邮件已发送,请注意查收&quot;&#125;)</span><br><span class="line">    # 如果表单验证失败也就是他验证码输错等。</span><br><span class="line">    else:</span><br><span class="line">        return render(request, &quot;forgetpwd.html&quot;, &#123;&quot;forget_from&quot;: forget_form &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="邮箱重置密码邮件发送"><a href="#邮箱重置密码邮件发送" class="headerlink" title="邮箱重置密码邮件发送"></a>邮箱重置密码邮件发送</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">elif send_type &#x3D;&#x3D; &quot;forget&quot;:</span><br><span class="line">       email_title &#x3D; &quot;mtianyan慕课小站 找回密码链接&quot;</span><br><span class="line">       email_body &#x3D; loader.render_to_string(</span><br><span class="line">           &quot;email_forget.html&quot;,  # 需要渲染的html模板</span><br><span class="line">           &#123;</span><br><span class="line">               &quot;active_code&quot;: code  # 参数</span><br><span class="line">           &#125;</span><br><span class="line">       )</span><br><span class="line">       msg &#x3D; EmailMessage(email_title, email_body, EMAIL_FROM, [email])</span><br><span class="line">       msg.content_subtype &#x3D; &quot;html&quot;</span><br><span class="line">       send_status &#x3D; msg.send()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-37697402c2c1d340.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/684" alt="img"></p>
<h4 id="前端页面添加错误信息"><a href="#前端页面添加错误信息" class="headerlink" title="前端页面添加错误信息"></a>前端页面添加错误信息</h4><p>已经重复很多遍这个操作了。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-ca1308d1a60c0514.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/451" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-710fe9c11f1c0592.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-9862123a3651aacd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<blockquote>
<p>上述三图进行改正，不一一列举</p>
</blockquote>
<h4 id="书写重置密码view"><a href="#书写重置密码view" class="headerlink" title="书写重置密码view"></a>书写重置密码view</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 重置密码的view</span><br><span class="line">class ResetView(View):</span><br><span class="line">    def get(self, request, active_code):</span><br><span class="line">        # 查询邮箱验证记录是否存在</span><br><span class="line">        all_record &#x3D; EmailVerifyRecord.objects.filter(code&#x3D;active_code)</span><br><span class="line">        # 如果不为空也就是有用户</span><br><span class="line">        active_form &#x3D; ActiveForm(request.GET)</span><br><span class="line">        if all_record:</span><br><span class="line">            for record in all_record:</span><br><span class="line">                # 获取到对应的邮箱</span><br><span class="line">                email &#x3D; record.email</span><br><span class="line">                # 将email传回来</span><br><span class="line">                return render(request, &quot;password_reset.html&quot;, &#123;&quot;email&quot;:email&#125;)</span><br><span class="line">        # 自己瞎输的验证码</span><br><span class="line">        else:</span><br><span class="line">            return render(</span><br><span class="line">                request, &quot;forgetpwd.html&quot;, &#123;</span><br><span class="line">                    &quot;msg&quot;: &quot;您的重置密码链接无效,请重新请求&quot;, &quot;active_form&quot;: active_form&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="配置重置密码url"><a href="#配置重置密码url" class="headerlink" title="配置重置密码url"></a>配置重置密码url</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Django1.9.8:</span><br><span class="line">    # 重置密码urlc ：用来接收来自邮箱的重置链接</span><br><span class="line">    url(&#39;reset&#x2F;(?P&lt;active_code&gt;.*)&#x2F;$&#39;, ResetView.as_view(), name&#x3D;&quot;reset_pwd&quot;),</span><br><span class="line"># django2.0.1:</span><br><span class="line"></span><br><span class="line">    # 重置密码urlc ：用来接收来自邮箱的重置链接</span><br><span class="line">    re_path(&#39;reset&#x2F;(?P&lt;active_code&gt;.*)&#x2F;&#39;, ResetView.as_view(), name&#x3D;&quot;reset_pwd&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="拷贝进来password-reset页面"><a href="#拷贝进来password-reset页面" class="headerlink" title="拷贝进来password reset页面"></a>拷贝进来password reset页面</h4><p><img src="https://upload-images.jianshu.io/upload_images/1779926-50e2bac45215f39b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/448" alt="img"></p>
<blockquote>
<p>添加一个隐藏的input框，以便于我们知道到底是哪个用户在重置密码</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-e56d852474ebd343.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/423" alt="img"></p>
<p>配置html中三大变化加url配置。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-c1257a82940c3eec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/619" alt="img"></p>
<p><code>reset</code>的<code>url</code>需要我们传参进来,但是<code>modify</code>的不需要。<br>所以url配置和view都得分开。</p>
<h4 id="创建改变密码的forms"><a href="#创建改变密码的forms" class="headerlink" title="创建改变密码的forms:"></a>创建改变密码的forms:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 重置密码form实现</span><br><span class="line">class ModifyPwdForm(forms.Form):</span><br><span class="line">    # 密码不能小于5位</span><br><span class="line">    password1 &#x3D; forms.CharField(required&#x3D;True, min_length&#x3D;5)</span><br><span class="line">    # 密码不能小于5位</span><br><span class="line">    password2 &#x3D; forms.CharField(required&#x3D;True, min_length&#x3D;5)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="书写改变密码的view；"><a href="#书写改变密码的view；" class="headerlink" title="书写改变密码的view；"></a>书写改变密码的view；</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> # 改变密码的view</span><br><span class="line">class ModifyPwdView(View):</span><br><span class="line">    def post(self, request):</span><br><span class="line">        modiypwd_form &#x3D; ModifyPwdForm(request.POST)</span><br><span class="line">        if modiypwd_form.is_valid():</span><br><span class="line">            pwd1 &#x3D; request.POST.get(&quot;password1&quot;, &quot;&quot;)</span><br><span class="line">            pwd2 &#x3D; request.POST.get(&quot;password2&quot;, &quot;&quot;)</span><br><span class="line">            email &#x3D; request.POST.get(&quot;email&quot;, &quot;&quot;)</span><br><span class="line">            # 如果两次密码不相等，返回错误信息</span><br><span class="line">            if pwd1 !&#x3D; pwd2:</span><br><span class="line">                return render(request, &quot;password_reset.html&quot;, &#123;&quot;email&quot;: email, &quot;msg&quot;: &quot;密码不一致&quot;&#125;)</span><br><span class="line">            # 如果密码一致</span><br><span class="line">            user &#x3D; UserProfile.objects.get(email&#x3D;email)</span><br><span class="line">            # 加密成密文</span><br><span class="line">            user.password &#x3D; make_password(pwd2)</span><br><span class="line">            # save保存到数据库</span><br><span class="line">            user.save()</span><br><span class="line">            return render(request, &quot;login.html&quot;, &#123;&quot;msg&quot;: &quot;密码修改成功，请登录&quot;&#125;)</span><br><span class="line">        # 验证失败说明密码位数不够。</span><br><span class="line">        else:</span><br><span class="line">            email &#x3D; request.POST.get(&quot;email&quot;, &quot;&quot;)</span><br><span class="line">            return render(request, &quot;password_reset.html&quot;, &#123;&quot;email&quot;: email, &quot;modiypwd_form&quot;:modiypwd_form&#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="配置modify的url。"><a href="#配置modify的url。" class="headerlink" title="配置modify的url。"></a>配置modify的url。</h4><p>django2.0.1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 修改密码url; 用于passwordreset页面提交表单</span><br><span class="line">path(&#39;modify_pwd&#x2F;&#39;, ModifyPwdView.as_view(), name&#x3D;&quot;modify_pwd&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>django1.9.8:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 修改密码url; 用于passwordreset页面提交表单</span><br><span class="line">url(r&#39;^modify_pwd&#x2F;$&#39;, ModifyPwdView.as_view(), name&#x3D;&quot;modify_pwd&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建议自行走一遍注册，登录，忘记密码。重置密码。<br>错误的激活链接，错误的重置链接。值回填，form报错</p>
<p>更多: 重置密码链接是否被点击过，过期时间。</p>
<h1 id="完成授课机构的功能实现"><a href="#完成授课机构的功能实现" class="headerlink" title="完成授课机构的功能实现"></a><center>完成授课机构的功能实现</center></h1><h2 id="django-templates模板继承1"><a href="#django-templates模板继承1" class="headerlink" title="django templates模板继承1"></a>django templates模板继承1</h2><ul>
<li>机构可以筛选类别</li>
<li>机构可以根据所在地区进行分类</li>
</ul>
<p>右侧我要学习功能: form表单提交<br>右下：授课机构排名</p>
<p>页面头部与底部为全局头和全局底部。</p>
<h3 id="Django-template-共用头部底部机制"><a href="#Django-template-共用头部底部机制" class="headerlink" title="Django template 共用头部底部机制"></a>Django template 共用头部底部机制</h3><p>将head和foot放在两个html中，然后在写其他需要这两个部分的页面时include进来。</p>
<p>Django也是支持include机制的。</p>
<h3 id="include的问题"><a href="#include的问题" class="headerlink" title="include的问题"></a>include的问题</h3><p>include的进来的死页面，这时候该怎么办？</p>
<p>解决这种问题：进行模板的继承机制。定义一个父类的框架，子类可以替换其中一部分block，子类只需要重写自己需要改变的block。</p>
<h3 id="template中新建base-html"><a href="#template中新建base-html" class="headerlink" title="template中新建base.html"></a>template中新建base.html</h3><p>将课程机构列表页。orglist拷贝进template目录</p>
<p>将orglist内容替换base内容。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-0269443b69f80570.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/239" alt="img"></p>
<p>将div收起来</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-5f1ccbc5794f87d0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/220" alt="img"></p>
<p>loadstaticfiles &amp; 修改静态文件路径为static</p>
<blockquote>
<p>这个步骤做过太多遍了，自行完成。耐心就行了。</p>
</blockquote>
<h3 id="定义父模板-包含head-amp-footer"><a href="#定义父模板-包含head-amp-footer" class="headerlink" title="定义父模板: 包含head &amp; footer"></a>定义父模板: 包含head &amp; footer</h3><p>title应该是可以被子页面替换的所以要包起来。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-9a1dbc2dbfe1fa24.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/481" alt="img"></p>
<p>css有共用的部分，也有可以被子页面替换的部分。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-b6a74b2bb63653fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/341" alt="img"></p>
<p>js同理</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-af7f46dd38bd5f8e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/289" alt="img"></p>
<p>面包屑是需要被各个页面自己替换的。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-0f082eed1f72b00b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/188" alt="img"></p>
<p>将正文内容包起来；</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-20d387c6bff07d56.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/174" alt="img"></p>
<p>此时base页面就制作好了</p>
<h2 id="开始orglist编写"><a href="#开始orglist编写" class="headerlink" title="开始orglist编写"></a>开始orglist编写</h2><p>第一步:清空所有内容</p>
<ul>
<li>继承base页面</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-3e2e112cf2c39350.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/253" alt="img"></p>
<ul>
<li>覆盖父类的title</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-392bc373f442d09a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/199" alt="img"></p>
<ul>
<li>书写课程机构view<br>organization/views.py</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from django.views.generic.base import View</span><br><span class="line"># 处理课程机构列表的view</span><br><span class="line">class OrgView(View):</span><br><span class="line">    def get(self,request):</span><br><span class="line">        return render(request, &quot;org-list.html&quot;, &#123; &#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Django2.0.1配置课程机构首页url</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 课程机构首页url</span><br><span class="line">path(&#39;org_list&#x2F;&#39;, OrgView.as_view(), name&#x3D;&quot;org_list&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Django1.9.8配置url：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 课程机构首页url</span><br><span class="line">url(r&#39;^org_list&#x2F;$&#39;, OrgView.as_view(), name&#x3D;&quot;org_list&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="修改面包屑"><a href="#修改面包屑" class="headerlink" title="修改面包屑"></a>修改面包屑</h3><ul>
<li>base中只保留首页</li>
<li>org中重写block custom_bread</li>
<li>block之间没有先后顺序。</li>
<li>将base中block content拿到orglist重写</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-29b97ffccbb18776.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/196" alt="img"></p>
<ul>
<li>然后将base中block中间section删除掉</li>
</ul>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-cab5c7f004fcd239.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/299" alt="img"></p>
<blockquote>
<p>orglist开始loadstaticfiles</p>
</blockquote>
<p><code>ctrl+d</code>快速删除</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-a863b3cbdeec1219.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/244" alt="img"></p>
<p>页面的继承关系使得变量也可以直接用</p>
<blockquote>
<p>比如user中的form数据传递到register文件当中.如果register继承的是base页面。<br>base页面当中也是可以用这些数据的。<code>参数的向上传递</code></p>
</blockquote>
<p>每个request对象都会传递到html中来，如果继承了base，request也会向上传递到base。<br>base中就可以加入我们的逻辑: 用户是否登录等。</p>
<p>小节结束对应commit:</p>
<blockquote>
<p>完成Django templates的继承关系了解，机构列表展示页。对应7-1 &amp; 2</p>
</blockquote>
<h2 id="课程机构列表页数据展示1"><a href="#课程机构列表页数据展示1" class="headerlink" title="课程机构列表页数据展示1"></a>课程机构列表页数据展示1</h2><p>确定由后台传过来的动态数据:</p>
<p>授课机构列表本身， 授课机构的排名，所在地区(后台取出所有地区), 机构类别写成静态，因为一般不怎么变动。</p>
<p>在xadmin中添加城市信息，课程信息。</p>
<p>添加城市</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-00b5504640872151.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/454" alt="img"></p>
<p>添加机构。</p>
<p>插播知识点：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-1a4a3bb3db05e42e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/451" alt="img"></p>
<p>这里指定的路径是一个相对路径</p>
<p>setting中要配置我们把文件存放在哪个根目录之下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 设置我们上传文件的路径</span><br><span class="line"></span><br><span class="line">MEDIA_URL &#x3D; &#39;&#x2F;media&#x2F;&#39;</span><br><span class="line">MEDIA_ROOT &#x3D; os.path.join(BASE_DIR, &#39;media&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在项目根目录创建media文件夹</p>
<p>在后台上传图片</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-a6681f24ccb16635.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/197" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-920a803d08e95abe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/255" alt="img"></p>
<p>修改机构信息中封面图为logo</p>
<p>自行添加十个课程机构</p>
<h3 id="models中添加机构类别"><a href="#models中添加机构类别" class="headerlink" title="models中添加机构类别"></a>models中添加机构类别</h3><p>organization/models.py：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class CourseOrg(models.Model):</span><br><span class="line">    ORG_CHOICES &#x3D;(</span><br><span class="line">        (&quot;pxjg&quot;, u&quot;培训机构&quot;),</span><br><span class="line">        (&quot;gx&quot;, u&quot;高校&quot;),</span><br><span class="line">        (&quot;gr&quot;, u&quot;个人&quot;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    name &#x3D; models.CharField(max_length&#x3D;50, verbose_name&#x3D;u&quot;机构名称&quot;)</span><br><span class="line">    # 机构描述，后面会替换为富文本展示</span><br><span class="line">    desc &#x3D; models.TextField(verbose_name&#x3D;u&quot;机构描述&quot;)</span><br><span class="line">    # 机构类别:</span><br><span class="line">    category &#x3D; models.CharField(max_length&#x3D;20, choices&#x3D;ORG_CHOICES, verbose_name&#x3D;u&quot;机构类别&quot;, default&#x3D;&quot;pxjg&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改了models之后做数据库的变动:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makemigrations organization</span><br><span class="line">migrate organization</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-6d38fe7fbc30dcd9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/352" alt="img"></p>
<p>完成之后打开Navicat进行验证：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-fc3fadf0c3bf8e27.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/86" alt="img"></p>
<p>可以看到新增了。</p>
<h3 id="完善我们的view"><a href="#完善我们的view" class="headerlink" title="完善我们的view"></a>完善我们的view</h3><p>将列表里的静态数据变成后台获取的动态数据</p>
<p>organization/views.py</p>
<pre><code>from .models import CourseOrg, CityDict

class OrgView(View):
    def get(self,request):
        # 查找到所有的课程机构

        all_orgs = CourseOrg.objects.all()

        # 取出所有的城市

        all_citys = CityDict.objects.all()

        return render(request, &quot;org-list.html&quot;, &#123;
                    &quot;all_orgs&quot;:all_orgs,
                    &quot;all_citys&quot;: all_citys,
    &#125;)</code></pre>
<h2 id="课程机构列表页数据展示2"><a href="#课程机构列表页数据展示2" class="headerlink" title="课程机构列表页数据展示2"></a>课程机构列表页数据展示2</h2><h3 id="前去html中进行数据填充"><a href="#前去html中进行数据填充" class="headerlink" title="前去html中进行数据填充"></a>前去html中进行数据填充</h3><p><img src="https://upload-images.jianshu.io/upload_images/1779926-3bc25b1c7b1fb235.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/541" alt="img"></p>
<blockquote>
<p>可以看到所有城市是通过a标签，当前选中城市为active。</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-40d118e1ee22f368.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/597" alt="img"></p>
<p>之后把下面的写死的城市删除掉。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-83dfdbfbaa20542d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/656" alt="img"></p>
<p>这时就是我们在后台添加的数据了</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-2eb22db915719213.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/323" alt="img"></p>
<p>可以看到每个课程机构都是一个dl</p>
<p>同理使用for循环。</p>
<h3 id="如何将imageField转换为图片地址"><a href="#如何将imageField转换为图片地址" class="headerlink" title="如何将imageField转换为图片地址"></a>如何将imageField转换为图片地址</h3><p>数据库中img存放的是字符串：相对路径</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-53103bff844f22bd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/158" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-4e076b8495da8019.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/256" alt="img"></p>
<p>上图这种取法会取出一个相对地址。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-7c3f56ea58b34976.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/344" alt="img"></p>
<p>将setting中配置的mediaurl放在前面可以补全地址。</p>
<h3 id="设置media处理器"><a href="#设置media处理器" class="headerlink" title="设置media处理器"></a>设置media处理器</h3><p><img src="https://upload-images.jianshu.io/upload_images/1779926-8d0f3064ef7c0046.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/503" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-7b269fdf75aadd09.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/421" alt="img"></p>
<blockquote>
<p>注册之后，mediaurl将可以在html中使用</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-bb9af0c094309efc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/219" alt="img"></p>
<p>图片还是没有显示。因为url中没有处理图片相应路径的url</p>
<p>Django1.9.8 urls.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from django.views.static import serve</span><br><span class="line">    # 处理图片显示的url,使用Django自带serve,传入参数告诉它去哪个路径找，我们有配置好的路径MEDIAROOT</span><br><span class="line">    url(r&#39;^media&#x2F;(?P&lt;path&gt;.*)$&#39;, serve, &#123;&quot;document_root&quot;: MEDIA_ROOT &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-9d831518aec0223a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/541" alt="img"></p>
<p>Django2.0.1 urls.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from django.views.static import serve</span><br><span class="line"># 处理图片显示的url,使用Django自带serve,传入参数告诉它去哪个路径找，我们有配置好的路径MEDIAROOT</span><br><span class="line">    re_path(r&#39;^media&#x2F;(?P&lt;path&gt;.*)&#39;, serve, &#123;&quot;document_root&quot;: MEDIA_ROOT &#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="完善xadmin的adminx为机构添加分类索引字段"><a href="#完善xadmin的adminx为机构添加分类索引字段" class="headerlink" title="完善xadmin的adminx为机构添加分类索引字段"></a>完善xadmin的adminx为机构添加分类索引字段</h3><p>organization/adminx.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 机构课程信息管理器</span><br><span class="line">class CourseOrgAdmin(object):</span><br><span class="line">    list_display &#x3D; [&#39;name&#39;, &#39;desc&#39;,&#39;category&#39;, &#39;click_nums&#39;, &#39;fav_nums&#39;,&#39;add_time&#39; ]</span><br><span class="line">    search_fields &#x3D; [&#39;name&#39;, &#39;desc&#39;, &#39;category&#39;,&#39;click_nums&#39;, &#39;fav_nums&#39;]</span><br><span class="line">    list_filter &#x3D; [&#39;name&#39;, &#39;desc&#39;,&#39;category&#39; ,&#39;click_nums&#39;, &#39;fav_nums&#39;,&#39;city__name&#39;,&#39;address&#39;,&#39;add_time&#39;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去除加载小圈圈"><a href="#去除加载小圈圈" class="headerlink" title="去除加载小圈圈"></a>去除加载小圈圈</h3><p>static/css/style.css中scrollLoading置为空:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.scrollLoading &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="列表分页功能"><a href="#列表分页功能" class="headerlink" title="列表分页功能"></a>列表分页功能</h2><p>github搜索django-pure-pagination</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install django-pure-pagination</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-275219a33e37848b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/441" alt="img"></p>
<p>install app中添加:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#39;pure_pagination&#39;,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可设置参数；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PAGINATION_SETTINGS &#x3D; &#123;</span><br><span class="line">    &#39;PAGE_RANGE_DISPLAYED&#39;: 10,</span><br><span class="line">    &#39;MARGIN_PAGES_DISPLAYED&#39;: 2,</span><br><span class="line">    &#39;SHOW_FIRST_PAGE_WHEN_INVALID&#39;: True,</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-58d6c360e4ae963f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p><code>PAGE_RANGE_DISPLAYED</code>是总共会显示多少个page。(包括省略号，包括两边和中间)<br><code>MARGIN_PAGES_DISPLAYED</code>是旁边会显示多少个。<br><code>SHOW_FIRST_PAGE_WHEN_INVALID</code>:当输入页数不合法是否要跳到第一页</p>
<p>官方实例；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">from django.shortcuts import render_to_response</span><br><span class="line"></span><br><span class="line">from pure_pagination import Paginator, EmptyPage, PageNotAnInteger</span><br><span class="line"></span><br><span class="line">    # 尝试获取页数参数</span><br><span class="line">    try:</span><br><span class="line">        page &#x3D; request.GET.get(&#39;page&#39;, 1)</span><br><span class="line">    except PageNotAnInteger:</span><br><span class="line">        page &#x3D; 1</span><br><span class="line">    # objects是取到的数据</span><br><span class="line">    objects &#x3D; [&#39;john&#39;, &#39;edward&#39;, &#39;josh&#39;, &#39;frank&#39;]</span><br><span class="line"></span><br><span class="line">    # Provide Paginator with the request object for complete querystring generation</span><br><span class="line">    # 对于取到的数据进行分页处理。</span><br><span class="line">    p &#x3D; Paginator(objects, request&#x3D;request)</span><br><span class="line">    # 此时前台显示的就应该是我们此时获取的第几页的数据</span><br><span class="line">    people &#x3D; p.page(page)</span><br><span class="line"></span><br><span class="line">    return render_to_response(&#39;index.html&#39;, &#123;</span><br><span class="line">        &#39;people&#39;: people,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们对照着的实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">from pure_pagination import Paginator, EmptyPage, PageNotAnInteger</span><br><span class="line">class OrgView(View):</span><br><span class="line">    def get(self,request):</span><br><span class="line">        # 查找到所有的课程机构</span><br><span class="line">        all_orgs &#x3D; CourseOrg.objects.all()</span><br><span class="line">        # 总共有多少家机构使用count进行统计</span><br><span class="line">        org_nums &#x3D; all_orgs.count()</span><br><span class="line">        # 取出所有的城市</span><br><span class="line">        all_city &#x3D; CityDict.objects.all()</span><br><span class="line">        # 对课程机构进行分页</span><br><span class="line">        # 尝试获取前台get请求传递过来的page参数</span><br><span class="line">        # 如果是不合法的配置参数默认返回第一页</span><br><span class="line">        try:</span><br><span class="line">            page &#x3D; request.GET.get(&#39;page&#39;, 1)</span><br><span class="line">        except PageNotAnInteger:</span><br><span class="line">            page &#x3D; 1</span><br><span class="line">        # 这里指从allorg中取五个出来，每页显示5个</span><br><span class="line">        p &#x3D; Paginator(all_orgs, 5, request&#x3D;request)</span><br><span class="line">        orgs &#x3D; p.page(page)</span><br><span class="line"></span><br><span class="line">        return render(request, &quot;org-list.html&quot;, &#123;</span><br><span class="line">            &quot;all_orgs&quot;:orgs,</span><br><span class="line">            &quot;all_city&quot;: all_city,</span><br><span class="line">            &quot;org_nums&quot;: org_nums,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="对于html中分页进行配置"><a href="#对于html中分页进行配置" class="headerlink" title="对于html中分页进行配置"></a>对于html中分页进行配置</h3><blockquote>
<p>不再是objects，而是objectlist</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-1493d3cb2a0b5ad9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/405" alt="img"></p>
<blockquote>
<p>使用默认的render</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-1b62adaffd345c87.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/253" alt="img"></p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-de5a88f372285e72.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/152" alt="img"></p>
<h3 id="自定义html的样式"><a href="#自定义html的样式" class="headerlink" title="自定义html的样式"></a>自定义html的样式</h3><p><img src="https://upload-images.jianshu.io/upload_images/1779926-30dc35d6c19cf3fc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/658" alt="img"></p>
<h2 id="分类筛选功能"><a href="#分类筛选功能" class="headerlink" title="分类筛选功能"></a>分类筛选功能</h2><p><img src="https://upload-images.jianshu.io/upload_images/1779926-aa8b0670ecbf66e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/525" alt="img"></p>
<p>当用户点击某一个city时对应加上参数city的id</p>
<h3 id="在后台处理这个city"><a href="#在后台处理这个city" class="headerlink" title="在后台处理这个city"></a>在后台处理这个city</h3><p><img src="https://upload-images.jianshu.io/upload_images/1779926-39abc6680f10002d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/377" alt="img"></p>
<p>获取传入的参数进行进一步筛选。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-1ec9f66912ea1bc6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/224" alt="img"></p>
<blockquote>
<p>将city_id传回html，使得可以知道哪个是选中的。</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-6a43ae8fba8f53ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p>因为city.id是后端传回来的值是一个int。所以我们要做类型转换。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-1ae5d63ae1f5d7d7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/602" alt="img"></p>
<p>当city_id为空的时候，显示全部。</p>
<h3 id="后台处理类别"><a href="#后台处理类别" class="headerlink" title="后台处理类别"></a>后台处理类别</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 类别筛选</span><br><span class="line">      category &#x3D; request.GET.get(&#39;ct&#39;, &quot;&quot;)</span><br><span class="line">      if category:</span><br><span class="line">          # 我们就在机构中作进一步筛选类别</span><br><span class="line">          all_orgs &#x3D; all_orgs.filter(category&#x3D;category)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>返回前台类别值以active</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">return render(request, &quot;org-list.html&quot;, &#123;</span><br><span class="line">          &quot;all_orgs&quot;:orgs,</span><br><span class="line">          &quot;all_city&quot;: all_city,</span><br><span class="line">          &quot;org_nums&quot;: org_nums,</span><br><span class="line">          &quot;city_id&quot;:city_id,</span><br><span class="line">          &quot;category&quot;:category,</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-72d903ef5200a1e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p>对于类别做同样的ifequal判断</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-2305e782e28994d3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p>如上图所示进行城市与分类的联动:</p>
<p>当选择全部类别的时候，就只通过当前城市id。<br>当选择全部城市的时候，就只通过当前目录id。<br>当两者都选的时候使用&amp;连接。</p>
<p>刚才统计机构数目过早，应该移到后面后面已经筛选过后，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 总共有多少家机构使用count进行统计</span><br><span class="line">       org_nums &#x3D; all_orgs.count()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="课程机构排名"><a href="#课程机构排名" class="headerlink" title="课程机构排名"></a>课程机构排名</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 热门机构,如果不加负号会是有小到大。</span><br><span class="line">     hot_orgs &#x3D; all_orgs.order_by(&quot;-click_nums&quot;)[:3]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-ddd1ad924aa2a513.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/486" alt="img"></p>
<p>循环时内置变量forloop.counter取当前循环到第几次</p>
<p>待完成:点击排名机构的连接</p>
<h3 id="课程机构排序。"><a href="#课程机构排序。" class="headerlink" title="课程机构排序。"></a>课程机构排序。</h3><p>学习人数，课程数</p>
<p>organization/models.py<br>CourseOrg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 当学生点击学习课程，找到所属机构，学习人数加1</span><br><span class="line">   students &#x3D; models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;学习人数&quot;)</span><br><span class="line">   # 当发布课程就加1</span><br><span class="line">   course_nums &#x3D;  models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;课程数&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makemigrations organization</span><br><span class="line">migrate organization</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>前端页面学习人数，添加参数sort</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-b05db6ec30dc16e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/647" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 进行排序</span><br><span class="line">       sort &#x3D; request.GET.get(&#39;sort&#39;, &quot;&quot;)</span><br><span class="line">       if sort:</span><br><span class="line">           if sort &#x3D;&#x3D; &quot;students&quot;:</span><br><span class="line">               all_orgs &#x3D; all_orgs.order_by(&quot;-students&quot;)</span><br><span class="line">           elif sort &#x3D;&#x3D; &quot;courses&quot;:</span><br><span class="line">               all_orgs &#x3D; all_orgs.order_by(&quot;-course_nums&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加选择效果</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-504eec2c00e2a6c2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/649" alt="img"></p>
<h2 id="modelform-提交我要学习咨询1"><a href="#modelform-提交我要学习咨询1" class="headerlink" title="modelform 提交我要学习咨询1"></a>modelform 提交我要学习咨询1</h2><p>对应表<code>userask</code></p>
<p><code>form</code>会对字段先做验证，然后保存到数据库中。</p>
<p>可以看到我们的forms和我们的model中有很多内容是一样的。我们如何让代码重复利用呢？</p>
<p>使用modelform解决这个问题。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from django import forms</span><br><span class="line"></span><br><span class="line">from operation.models import UserAsk</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 普通版本的form</span><br><span class="line"># class UserAskForm(forms.Form):</span><br><span class="line">#     name &#x3D; forms.CharField(required&#x3D;True, min_length&#x3D;2, max_length&#x3D;20)</span><br><span class="line">#     phone &#x3D; forms.CharField(required&#x3D;True, max_length&#x3D;11, min_length&#x3D;11)</span><br><span class="line">#     course_name &#x3D; forms.CharField(required&#x3D;True, min_length&#x3D;5, max_length&#x3D;50)</span><br><span class="line"></span><br><span class="line"># 进阶版本的modelform：它可以向model一样save</span><br><span class="line">class AnotherUserForm(forms.ModelForm):</span><br><span class="line">    # 继承之余还可以新增字段</span><br><span class="line"></span><br><span class="line">    # 是由哪个model转换的</span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; UserAsk</span><br><span class="line">        # 我需要验证的字段</span><br><span class="line">        fields &#x3D; [&#39;name&#39;,&#39;mobile&#39;,&#39;course_name&#39;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="include的机制配置应用自己的url"><a href="#include的机制配置应用自己的url" class="headerlink" title="include的机制配置应用自己的url"></a>include的机制配置应用自己的url</h3><p>django1.9.8 创建organization/urls.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line"></span><br><span class="line"># encoding: utf-8</span><br><span class="line">from organization.views import OrgView</span><br><span class="line">from django.conf.urls import url</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    # 课程机构列表url</span><br><span class="line">    url(&#39;list&#x2F;&amp;&#39;, OrgView.as_view(), name&#x3D;&quot;org_list&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>django1.9.8 Mxonline2/urls.py:<br>删掉orglist,新增如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 课程机构app的url配置</span><br><span class="line">  url(r&quot;^org&#x2F;&quot;, include(&#39;organization.urls&#39;,namespace&#x3D;&quot;org&quot;)),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>django2.0.1: 新建organization/urls.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from organization.views import OrgView</span><br><span class="line"></span><br><span class="line">from django.urls import path, re_path</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    # 课程机构列表url</span><br><span class="line">    path(&#39;list&#x2F;&#39;, OrgView.as_view(), name&#x3D;&quot;org_list&quot;),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>django2.0.1: urls.py中:</p>
<p>删掉org_list，新增include</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 课程机构app的url配置</span><br><span class="line">path(&quot;org&#x2F;&quot;, include(&#39;organization.urls&#39;,namespace&#x3D;&quot;org&quot;)),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用命名空间防止重复</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-f1e131c3c0a0abe9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/439" alt="img"></p>
<p>解决Django2.0.1报错:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">   &#39;Specifying a namespace in include() without providing an app_name &#39; </span><br><span class="line">django.core.exceptions.ImproperlyConfigured: Specifying a namespace in </span><br><span class="line">include() without providing an app_name is not supported. Set the app_name </span><br><span class="line">attribute in the included module, or pass a 2-tuple containing the list of </span><br><span class="line">patterns and app_name instead. </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在自己的app下的urls中写上appname</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from organization.views import OrgView</span><br><span class="line"></span><br><span class="line">from django.urls import path, re_path</span><br><span class="line"></span><br><span class="line">app_name &#x3D; &quot;organization&quot;</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line"></span><br><span class="line">    # 课程机构列表url</span><br><span class="line">    path(&#39;list&#x2F;&#39;, OrgView.as_view(), name&#x3D;&quot;org_list&quot;),</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>html中使用命名空间方式:</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-ed075c1077b21a8a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/511" alt="img"></p>
<h3 id="使用modelform做提交"><a href="#使用modelform做提交" class="headerlink" title="使用modelform做提交"></a>使用modelform做提交</h3><p>比较合理的操作是异步的，不会对整个页面进行刷新。<br>如果有错误，显示错误。一种ajax的异步操作。</p>
<p>因此我们此时不能直接render一个页面回来。<br>应该是给前端返回json数据，而不是页面</p>
<p><code>HttpResponse</code>类指明给用户返回哪种类型数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from django.http import HttpResponse</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置一个modelform的view</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 用户添加我要学习</span><br><span class="line">class AddUserAskView(View):</span><br><span class="line">    # 处理表单提交当然post</span><br><span class="line">    def post(self,request):</span><br><span class="line">        userask_form &#x3D; UserAskForm(request.POST)</span><br><span class="line">        # 判断该form是否有效</span><br><span class="line">        if userask_form.is_valid():</span><br><span class="line">            # 这里是modelform和form的区别</span><br><span class="line">            # 它有model的属性</span><br><span class="line">            # 当commit为true进行真正保存</span><br><span class="line">            user_ask &#x3D; userask_form.save(commit&#x3D;True)</span><br><span class="line">            # 这样就不需要把一个一个字段取出来然后存到model的对象中之后save</span><br><span class="line"></span><br><span class="line">            # 如果保存成功,返回json字符串,后面content type是告诉浏览器的,</span><br><span class="line">            return HttpResponse(&quot;&#123;&#39;status&#39;: &#39;success&#39;&#125;&quot;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line">        else:</span><br><span class="line">            # 如果保存失败，返回json字符串,并将form的报错信息通过msg传递到前端</span><br><span class="line">            return HttpResponse(&quot;&#123;&#39;status&#39;: &#39;fail&#39;, &#39;msg&#39;:&#123;0&#125;&#125;&quot;.format(userask_form.errors),  content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="配置相应的url"><a href="#配置相应的url" class="headerlink" title="配置相应的url"></a>配置相应的url</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 添加我要学习</span><br><span class="line">path(&#39;add_ask&#x2F;&#39;, AddUserAskView.as_view(), name&#x3D;&quot;add_ask&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="modelform-提交我要学习"><a href="#modelform-提交我要学习" class="headerlink" title="modelform 提交我要学习"></a>modelform 提交我要学习</h2><h3 id="分析ajax请求"><a href="#分析ajax请求" class="headerlink" title="分析ajax请求"></a>分析ajax请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    $(function()&#123;</span><br><span class="line">        $(&#39;#jsStayBtn&#39;).on(&#39;click&#39;, function()&#123;</span><br><span class="line">            $.ajax(&#123;</span><br><span class="line">                cache: false,</span><br><span class="line">                type: &quot;POST&quot;,</span><br><span class="line">                url:&quot;&#123;% url &quot;org:add_ask&quot; %&#125;&quot;,</span><br><span class="line">                data:$(&#39;#jsStayForm&#39;).serialize(),</span><br><span class="line">                async: true,</span><br><span class="line">                success: function(data) &#123;</span><br><span class="line">                    if(data.status &#x3D;&#x3D; &#39;success&#39;)&#123;</span><br><span class="line">                        $(&#39;#jsStayForm&#39;)[0].reset();</span><br><span class="line">                        alert(&quot;提交成功&quot;)</span><br><span class="line">                    &#125;else if(data.status &#x3D;&#x3D; &#39;fail&#39;)&#123;</span><br><span class="line">                        $(&#39;#jsCompanyTips&#39;).html(data.msg)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>监听这个button，用户如果点击了button。我们来向这个url进行post请求。<br>将我们的表单进行序列化。</p>
</blockquote>
<p>form表单添加crsf_token</p>
<p>如果后台返回的状态值为success，那么我们将弹出提交成功。<br>失败，就会在错误提示框中写入。</p>
<h3 id="手机号码正则表达式验证"><a href="#手机号码正则表达式验证" class="headerlink" title="手机号码正则表达式验证:"></a>手机号码正则表达式验证:</h3><p>organization/forms.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 手机号的正则表达式验证</span><br><span class="line">    def clean_mobile(self):</span><br><span class="line">        mobile &#x3D; self.cleaned_data[&#39;mobile&#39;]</span><br><span class="line">        REGEX_MOBILE &#x3D; &quot;^1[358]\d&#123;9&#125;$|^147\d&#123;8&#125;$|^176\d&#123;8&#125;$&quot;</span><br><span class="line">        p &#x3D; re.compile(REGEX_MOBILE)</span><br><span class="line">        if p.match(mobile):</span><br><span class="line">            return mobile</span><br><span class="line">        else:</span><br><span class="line">            raise forms.ValidationError(u&quot;手机号码非法&quot;, code&#x3D;&quot;mobile_invalid&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="机构详情"><a href="#机构详情" class="headerlink" title="机构详情"></a>机构详情</h2><ul>
<li>机构首页</li>
<li>机构课程</li>
<li>机构介绍</li>
<li>机构讲师</li>
</ul>
<p>登录xadmin添加基础的必要数据。添加课程与讲师。</p>
<p>课程中应该有一个外键指向它是哪个机构的。</p>
<p>courses/models.py</p>
<p>Django1.9.8中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">from organization.models import CourseOrg</span><br><span class="line"></span><br><span class="line">course_org &#x3D; models.ForeignKey(CourseOrg, verbose_name&#x3D;u&quot;所属机构&quot;,null&#x3D;True,blank&#x3D;True)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>django2.0.1下；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">course_org &#x3D; models.ForeignKey(CourseOrg,on_delete&#x3D;models.CASCADE, verbose_name&#x3D;u&quot;所属机构&quot;,null&#x3D;True,blank&#x3D;True)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新增外键字段应该<code>null=true,blank=true。</code></p>
<blockquote>
<p>因为历史数据中没有这个外键字段</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makemigration course</span><br><span class="line">migrate course</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将前端给我们的org相关的四个页面拷进template</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-e84178ba30796d0f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/173" alt="img"></p>
<p>新建org_base页面</p>
<p>将org_home页面内容拿过去。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-d1ac59bf53507cfe.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/317" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-0ed04eb784fd710c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/398" alt="img"></p>
<ul>
<li>loadstaticfiles -&gt; 改css文件路径-&gt;改js文件路径-&gt;改图片路径</li>
<li>改已经实现的url。-&gt;将子页面继承后需要改得地方使用block包裹。</li>
</ul>
<p>将home页面清空</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-b12422d8d71faaed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/557" alt="img"></p>
<p>完成替换之后添加访问的view以及URl</p>
<p>organization/views.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class OrgHomeView(View):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">   机构首页</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def get(self, request, org_id):</span><br><span class="line">        # 根据id取到课程机构</span><br><span class="line">        course_org &#x3D; CourseOrg.objects.get(id&#x3D; int(org_id))</span><br><span class="line">        # 通过课程机构找到课程。内建的变量，找到指向这个字段的外键引用</span><br><span class="line">        all_courses &#x3D; course_org.course_set.all()[:4]</span><br><span class="line">        all_teacher &#x3D; course_org.teacher_set.all()[:2]</span><br><span class="line"></span><br><span class="line">        return render(request, &#39;org-detail-homepage.html&#39;,&#123;</span><br><span class="line">           &#39;all_courses&#39;:all_courses,</span><br><span class="line">            &#39;all_teacher&#39;:all_teacher,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Django2.0.1下url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">   # home页面,取纯数字</span><br><span class="line">re_path(&#39;home&#x2F;(?P&lt;org_id&gt;\d+)&#x2F;&#39;, OrgHomeView.as_view(), name&#x3D;&quot;org_home&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>django1.9.8下url:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># home页面,取纯数字</span><br><span class="line">url(r&#39;home&#x2F;(?P&lt;org_id&gt;\d+)&#x2F;$&#39;, OrgHomeView.as_view(), name&#x3D;&quot;org_home&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>html中使用for循环遍历:</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-3904e74bdf0f37f2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/313" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-6ecfdedeb67e23de.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/468" alt="img"></p>
<blockquote>
<p>如上图可以直接通过外键字段再找到外键对象的字段</p>
</blockquote>
<p>templates/org-list.html</p>
<p>配置里面跳转到详情页的url</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-916cfee6a62b1a93.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/388" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">return render(request, &#39;org-detail-homepage.html&#39;,&#123;</span><br><span class="line">   &#39;all_courses&#39;:all_courses,</span><br><span class="line">    &#39;all_teacher&#39;:all_teacher,</span><br><span class="line">    &#39;course_org&#39;: course_org,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将<code>course_org</code>也return回来，就可以把网页里这部分值替换掉</p>
<p>templates/org_base.html</p>
<p>数值会随继承链向上传递。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-44bca4fc2f2370e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/584" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-a84aafa89037174b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/391" alt="img"></p>
<h3 id="为讲师增加头像字段"><a href="#为讲师增加头像字段" class="headerlink" title="为讲师增加头像字段"></a>为讲师增加头像字段</h3><p>organization/models.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">image &#x3D; models.ImageField(</span><br><span class="line">    default&#x3D; &#39;&#39;,</span><br><span class="line">    upload_to&#x3D;&quot;teacher&#x2F;%Y&#x2F;%m&quot;,</span><br><span class="line">    verbose_name&#x3D;u&quot;头像&quot;,</span><br><span class="line">    max_length&#x3D;100)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makemgration organization</span><br><span class="line">migrate organization</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-785deb9fdc5f2647.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/283" alt="img"></p>
<p>使用for循环填充数据</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-191fcde311217246.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/543" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-124c00e49522243b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/422" alt="img"></p>
<p>同理可得，我们把机构课程页不同的部分拿出来即可</p>
<h3 id="配置访问的view和url"><a href="#配置访问的view和url" class="headerlink" title="配置访问的view和url"></a>配置访问的view和url</h3><p>organization/urls.py:</p>
<p>Django 2.0.1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 访问课程</span><br><span class="line">re_path(&#39;course&#x2F;(?P&lt;org_id&gt;\d+)&#x2F;&#39;, OrgCourseView.as_view(), name&#x3D;&quot;org_course&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Django 1.9.8：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 访问课程</span><br><span class="line">url(r&#39;^course&#x2F;(?P&lt;org_id&gt;\d+)&#x2F;$&#39;, OrgCourseView.as_view(), name&#x3D;&quot;org_course&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>organization/views.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">class OrgCourseView(View):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">   机构课程列表页</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def get(self, request, org_id):</span><br><span class="line">        # 根据id取到课程机构</span><br><span class="line">        course_org &#x3D; CourseOrg.objects.get(id&#x3D; int(org_id))</span><br><span class="line">        # 通过课程机构找到课程。内建的变量，找到指向这个字段的外键引用</span><br><span class="line">        all_courses &#x3D; course_org.course_set.all()</span><br><span class="line"></span><br><span class="line">        return render(request, &#39;org-detail-course.html&#39;,&#123;</span><br><span class="line">           &#39;all_courses&#39;:all_courses,</span><br><span class="line">            &#39;course_org&#39;: course_org,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>base页面的left链接修改</p>
<blockquote>
<p>这里能直接用到course_org.id。是因为子页面render时都向上传递了course_org对象</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-091c34151ad3f216.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/488" alt="img"></p>
<p>使用for循环，填充内容。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-a5f100c4c1896e95.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/623" alt="img"></p>
<h3 id="左侧active修改"><a href="#左侧active修改" class="headerlink" title="左侧active修改"></a>左侧active修改</h3><p>因为现在没有值能判断当前是哪个页面。所以在orghomeview中传值回来current page</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-2ed070392f05f939.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-0bf3f5c25a4bf24a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/510" alt="img"></p>
<p>写两个view</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">class OrgDescView(View):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">   机构描述详情页</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def get(self, request, org_id):</span><br><span class="line">        # 向前端传值，表明现在在home页</span><br><span class="line">        current_page &#x3D; &quot;desc&quot;</span><br><span class="line">        # 根据id取到课程机构</span><br><span class="line">        course_org &#x3D; CourseOrg.objects.get(id&#x3D; int(org_id))</span><br><span class="line">        # 通过课程机构找到课程。内建的变量，找到指向这个字段的外键引用</span><br><span class="line">        # 向前端传值说明用户是否收藏</span><br><span class="line">        has_fav &#x3D; False</span><br><span class="line">        # 必须是用户已登录我们才需要判断。</span><br><span class="line">        if request.user.is_authenticated:</span><br><span class="line">            if UserFavorite.objects.filter(user&#x3D;request.user, fav_id&#x3D;course_org.id, fav_type&#x3D;2):</span><br><span class="line">                has_fav &#x3D; True</span><br><span class="line">        return render(request, &#39;org-detail-desc.html&#39;,&#123;</span><br><span class="line">            &#39;course_org&#39;: course_org,</span><br><span class="line">            &quot;current_page&quot;:current_page,</span><br><span class="line">            &quot;has_fav&quot;:has_fav,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">class OrgTeacherView(View):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">   机构讲师列表页</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def get(self, request, org_id):</span><br><span class="line">        # 向前端传值，表明现在在home页</span><br><span class="line">        current_page &#x3D; &quot;teacher&quot;</span><br><span class="line">        # 根据id取到课程机构</span><br><span class="line">        course_org &#x3D; CourseOrg.objects.get(id&#x3D; int(org_id))</span><br><span class="line">        # 通过课程机构找到课程。内建的变量，找到指向这个字段的外键引用</span><br><span class="line">        all_teachers &#x3D; course_org.teacher_set.all()</span><br><span class="line">        # 向前端传值说明用户是否收藏</span><br><span class="line">        has_fav &#x3D; False</span><br><span class="line">        # 必须是用户已登录我们才需要判断。</span><br><span class="line">        if request.user.is_authenticated:</span><br><span class="line">            if UserFavorite.objects.filter(user&#x3D;request.user, fav_id&#x3D;course_org.id, fav_type&#x3D;2):</span><br><span class="line">                has_fav &#x3D; True</span><br><span class="line">        return render(request, &#39;org-detail-teachers.html&#39;,&#123;</span><br><span class="line">           &#39;all_teachers&#39;:all_teachers,</span><br><span class="line">            &#39;course_org&#39;: course_org,</span><br><span class="line">            &quot;current_page&quot;:current_page,</span><br><span class="line">            &quot;has_fav&quot;:has_fav</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>加两个url</p>
<p>Django2.0.1下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 访问机构描述</span><br><span class="line">re_path(&#39;desc&#x2F;(?P&lt;org_id&gt;\d+)&#x2F;&#39;, OrgDescView.as_view(), name&#x3D;&quot;org_desc&quot;),</span><br><span class="line"></span><br><span class="line"># 访问机构讲师</span><br><span class="line">re_path(&#39;teacher&#x2F;(?P&lt;org_id&gt;\d+)&#x2F;&#39;, OrgTeacherView.as_view(), name&#x3D;&quot;org_teacher&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Django1.9.8下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 访问机构描述</span><br><span class="line">url(r&#39;^desc&#x2F;(?P&lt;org_id&gt;\d+)&#x2F;$&#39;, OrgDescView.as_view(), name&#x3D;&quot;org_desc&quot;),</span><br><span class="line"></span><br><span class="line"># 访问机构讲师</span><br><span class="line">url(r&#39;^teacher&#x2F;(?P&lt;org_id&gt;\d+)&#x2F;$&#39;, OrgTeacherView.as_view(), name&#x3D;&quot;org_teacher&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改base页面相关跳转链接，注意点：加上course_org.id</p>
<p>重载我们的pagepath，使得面包屑动态显示</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-5e965efd1df7eb13.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/496" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-a607a5b377f66e73.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<h2 id="课程机构收藏功能"><a href="#课程机构收藏功能" class="headerlink" title="课程机构收藏功能"></a>课程机构收藏功能</h2><p>书写收藏的后台逻辑:</p>
<p>url配置</p>
<p>django2.0.1下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 机构收藏</span><br><span class="line">path(&#39;add_fav&#x2F;&#39;, AddFavView.as_view(), name&#x3D;&quot;add_fav&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>django1.9.8下；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 机构收藏</span><br><span class="line">url(r&#39;^add_fav&#x2F;$&#39;, AddFavView.as_view(), name&#x3D;&quot;add_fav&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配套的view；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">class AddFavView(View):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    用户收藏与取消收藏功能</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def post(self, request):</span><br><span class="line">        # 表明你收藏的不管是课程，讲师，还是机构。他们的id</span><br><span class="line">        # 默认值取0是因为空串转int报错</span><br><span class="line">        id &#x3D; request.POST.get(&#39;fav_id&#39;, 0)</span><br><span class="line">        # 取到你收藏的类别，从前台提交的ajax请求中取</span><br><span class="line">        type &#x3D; request.POST.get(&#39;fav_type&#39;, 0)</span><br><span class="line"></span><br><span class="line">        # 收藏与已收藏取消收藏</span><br><span class="line">        # 判断用户是否登录:即使没登录会有一个匿名的user</span><br><span class="line">        if not request.user.is_authenticated:</span><br><span class="line">            # 未登录时返回json提示未登录，跳转到登录页面是在ajax中做的</span><br><span class="line">            return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;:&quot;用户未登录&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line">        exist_records &#x3D; UserFavorite.objects.filter(user&#x3D;request.user, fav_id&#x3D;int(id), fav_type&#x3D;int(type))</span><br><span class="line">        if exist_records:</span><br><span class="line">            # 如果记录已经存在， 则表示用户取消收藏</span><br><span class="line">            exist_records.delete()</span><br><span class="line">            return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;success&quot;, &quot;msg&quot;:&quot;收藏&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line">        else:</span><br><span class="line">            user_fav &#x3D; UserFavorite()</span><br><span class="line">            # 过滤掉未取到fav_id type的默认情况</span><br><span class="line">            if int(type) &gt;0 and int(id) &gt;0:</span><br><span class="line">                user_fav.fav_id &#x3D; int(id)</span><br><span class="line">                user_fav.fav_type &#x3D; int(type)</span><br><span class="line">                user_fav.user &#x3D; request.user</span><br><span class="line">                user_fav.save()</span><br><span class="line">                return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;success&quot;, &quot;msg&quot;:&quot;已收藏&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line">            else:</span><br><span class="line">                return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;:&quot;收藏出错&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>相关处理收藏的jQuery代码写在org base Html</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-74ce9bf772f25479.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/488" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-c6cec339c23c0923.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/326" alt="img"></p>
<p>添加返回页面的收藏值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 向前端传值说明用户是否收藏</span><br><span class="line">       has_fav &#x3D; False</span><br><span class="line">       # 必须是用户已登录我们才需要判断。</span><br><span class="line">       if request.user.is_authenticated:</span><br><span class="line">           if UserFavorite.objects.filter(user&#x3D;request.user, fav_id&#x3D;course_org.id, fav_type&#x3D;2):</span><br><span class="line">               has_fav &#x3D; True</span><br><span class="line"></span><br><span class="line"># return redener加上值</span><br><span class="line">            &quot;has_fav&quot;: has_fav</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-86511eb4e6fd4f29.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/524" alt="img"></p>
<p>前台 org_base.html中</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-380d114294efbc07.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/271" alt="img"></p>
<p>同理添加剩下的几个页面的。</p>
<h1 id="课程相关功能实现"><a href="#课程相关功能实现" class="headerlink" title="课程相关功能实现"></a><center>课程相关功能实现</center></h1><h2 id="课程列表"><a href="#课程列表" class="headerlink" title="课程列表"></a>课程列表</h2><p>拷贝课程列表页到template目录</p>
<p>创建课程相关的urls.py</p>
<p>Mxonline2/urls.py中声明包含到course的url中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 课程app的url配置</span><br><span class="line">url(r&quot;^course&#x2F;&quot;, include(&#39;courses.urls&#39;, namespace&#x3D;&quot;course&quot;)),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>django2.0.1版本:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 课程app的url配置</span><br><span class="line">path(&quot;course&#x2F;&quot;, include(&#39;courses.urls&#39;, namespace&#x3D;&quot;course&quot;)),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>书写处理列表展示相关的view</p>
<p>courses/views.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class CourseListView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        return render(request, &quot;course-list.html&quot;, &#123; &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>courses/urls.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from courses.views import CourseListView</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">from django.conf.urls import url</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    # 课程列表url</span><br><span class="line">    url(r&#39;^list&#x2F;$&#39;, CourseListView.as_view(), name&#x3D;&quot;list&quot;),</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>django2.0.1版本:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># encoding: utf-8</span><br><span class="line">from courses.views import CourseListView</span><br><span class="line">from django.urls import path</span><br><span class="line">app_name &#x3D; &quot;courses&quot;</span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    # 课程列表url</span><br><span class="line">    path(&#39;list&#x2F;&#39;, CourseListView.as_view(), name&#x3D;&quot;list&quot;),</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时访问没有样式。我们开始对于course list html进行工作<br>可以观察到它和orglist一样可以有共同的头尾。所以继承base页面</p>
<p>xadmin中添加一些课程。</p>
<p>然后在view中返回课程数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">class CourseListView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        all_course &#x3D; Course.objects.all()</span><br><span class="line">        return render(request, &quot;course-list.html&quot;, &#123;</span><br><span class="line">            &quot;all_course&quot;:all_course,</span><br><span class="line">            </span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-3976f6f2f0d2d283.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/458" alt="img"></p>
<p>保留一个div</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-2dde0d56e76b9904.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<blockquote>
<p>通过外键字段取外键表中字段</p>
</blockquote>
<h3 id="分页功能"><a href="#分页功能" class="headerlink" title="分页功能"></a>分页功能</h3><p>拷贝代码:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from pure_pagination import Paginator, EmptyPage, PageNotAnInteger</span><br><span class="line"> # 对课程机构进行分页</span><br><span class="line">        # 尝试获取前台get请求传递过来的page参数</span><br><span class="line">        # 如果是不合法的配置参数默认返回第一页</span><br><span class="line">        try:</span><br><span class="line">            page &#x3D; request.GET.get(&#39;page&#39;, 1)</span><br><span class="line">        except PageNotAnInteger:</span><br><span class="line">            page &#x3D; 1</span><br><span class="line">        # 这里指从allorg中取五个出来，每页显示5个</span><br><span class="line">        p &#x3D; Paginator(all_orgs, 4, request&#x3D;request)</span><br><span class="line">        orgs &#x3D; p.page(page)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>改动完成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class CourseListView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        all_course &#x3D; Course.objects.all()</span><br><span class="line">        # 对课程进行分页</span><br><span class="line">        # 尝试获取前台get请求传递过来的page参数</span><br><span class="line">        # 如果是不合法的配置参数默认返回第一页</span><br><span class="line">        try:</span><br><span class="line">            page &#x3D; request.GET.get(&#39;page&#39;, 1)</span><br><span class="line">        except PageNotAnInteger:</span><br><span class="line">            page &#x3D; 1</span><br><span class="line">        # 这里指从allorg中取五个出来，每页显示5个</span><br><span class="line">        p &#x3D; Paginator(all_course,6 , request&#x3D;request)</span><br><span class="line">        courses &#x3D; p.page(page)</span><br><span class="line">        return render(request, &quot;course-list.html&quot;, &#123;</span><br><span class="line">            &quot;all_course&quot;:courses,</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在html中使用时注意object_list</p>
<blockquote>
<p>此时的all_course已经不是一个queryset，而是一个purepage对象。</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-26a2db1d15e596ee.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/324" alt="img"></p>
<h3 id="对于页码进行修改"><a href="#对于页码进行修改" class="headerlink" title="对于页码进行修改"></a>对于页码进行修改</h3><p><img src="https://upload-images.jianshu.io/upload_images/1779926-64f30fd33b3311b8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/359" alt="img"></p>
<p>直接把orglist中的那段拿过来就行了。自行替换变量名称</p>
<p>此时已经好了。</p>
<h3 id="排序功能"><a href="#排序功能" class="headerlink" title="排序功能"></a>排序功能</h3><p>将之前的sort逻辑拷贝过来:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 进行排序</span><br><span class="line">        sort &#x3D; request.GET.get(&#39;sort&#39;, &quot;&quot;)</span><br><span class="line">        if sort:</span><br><span class="line">            if sort &#x3D;&#x3D; &quot;students&quot;:</span><br><span class="line">                all_orgs &#x3D; all_orgs.order_by(&quot;-students&quot;)</span><br><span class="line">            elif sort &#x3D;&#x3D; &quot;courses&quot;:</span><br><span class="line">                all_orgs &#x3D; all_orgs.order_by(&quot;-course_nums&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改完成:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 进行排序</span><br><span class="line">sort &#x3D; request.GET.get(&#39;sort&#39;, &quot;&quot;)</span><br><span class="line">if sort:</span><br><span class="line">    if sort &#x3D;&#x3D; &quot;students&quot;:</span><br><span class="line">        all_course &#x3D; all_course.order_by(&quot;-students&quot;)</span><br><span class="line">    elif sort &#x3D;&#x3D; &quot;hot&quot;:</span><br><span class="line">        all_course &#x3D; all_course.order_by(&quot;-click_nums&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>应放在分页之前。让分页处理所有筛选过的数据</p>
<p>return render时添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;sort&quot;:sort,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>用来判断激活状态。</p>
</blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-328124bfa5053a04.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/684" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-ed8c90123aad0aa3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/357" alt="img"></p>
<p>修改a标签参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 热门课程推荐</span><br><span class="line">    hot_courses &#x3D; Course.objects.all().order_by(&quot;-students&quot;)[:3]</span><br><span class="line">    return render</span><br><span class="line">     &quot;hot_courses&quot;:hot_courses</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改html中</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-cbe1c790936b4ac4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/451" alt="img"></p>
<p>mark</p>
<p>for循环填充内容</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-684356fcee55fbfb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/669" alt="img"></p>
<p>这里的degree我们在数据库中填写的是字母。如何显示为中文。</p>
<ul>
<li>个人猜测: template if</li>
</ul>
<p>get_degree_display degree是字段名。专门用于choice字段显示</p>
<h2 id="课程详情页1"><a href="#课程详情页1" class="headerlink" title="课程详情页1"></a>课程详情页1</h2><p>拷贝course_detail进入template目录</p>
<p>可以看出这个页面也是继承base页面的。将course_list的页面框架拿过来</p>
<p>替换面包屑。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-d95e655c89cf141d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/450" alt="img"></p>
<p>配置url访问</p>
<p>django2.0.1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 课程详情页</span><br><span class="line">re_path(&#39;course&#x2F;(?P&lt;course_id&gt;\d+)&#x2F;&#39;, CourseDetailView.as_view(), name&#x3D;&quot;course_detail&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>书写对应访问的view</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> 课程详情处理view</span><br><span class="line"></span><br><span class="line">class CourseDetailView(View):</span><br><span class="line">    def get(self, request, course_id):</span><br><span class="line">        return  render(request, &quot;course-detail.html&quot;, &#123;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>尝试访问：</p>
<p>在列表展示页放入详情的url。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-1e60d63aa8c0707a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/440" alt="img"></p>
<p>有参数类型的把参数也传进来</p>
<p>进行数据填充:先取出当前的课程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 此处的id为表默认为我们添加的值。</span><br><span class="line">course &#x3D; Course.objects.get(id &#x3D; int(course_id))</span><br><span class="line"></span><br><span class="line">        return  render(request, &quot;course-detail.html&quot;, &#123;</span><br><span class="line">    &quot;course&quot;:course,</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>html中取出数据:</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-a789f4e6596bddea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/587" alt="img"></p>
<p>课程的章节数如何实现？</p>
<p>models.py中自定义方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def get_zj_nums(self):</span><br><span class="line">    # 获取课程章节数的方法</span><br><span class="line">    return self.lesson_set.all().count()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加课程类别字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">category &#x3D; models.CharField(max_length&#x3D;20, default&#x3D;u&quot;&quot;, verbose_name&#x3D;u&quot;课程类别&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migrate</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>operation中专门有张表是做用户学习记录的。</p>
<p>UserCourse查询有哪些学生学习了这门课</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 获取学习这门课程的用户</span><br><span class="line">def get_learn_users(self):</span><br><span class="line">    # 谁的里面添加了它做外键，他都可以取出来</span><br><span class="line">    return self.usercourse_set.all()[:5]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-09b470546eb4befa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p>链式调用取出数据</p>
<p>添加一些用户课程进行验证</p>
<p><img src="Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/181.png"></p>
<p>可以看到已经大功告成</p>
<p>课程详情的view中添加clicknums+1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 增加课程点击数</span><br><span class="line">course.click_nums +&#x3D; 1</span><br><span class="line">course.save()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-899e69891bd0625a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/97" alt="img"></p>
<h2 id="课程详情页2"><a href="#课程详情页2" class="headerlink" title="课程详情页2"></a>课程详情页2</h2><p><img src="https://upload-images.jianshu.io/upload_images/1779926-6a3617d392c3d732.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/356" alt="img"></p>
<p>tab_cont1 中填充我们自己的内容。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-2b24323d03b4aab7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/584" alt="img"></p>
<p>mark</p>
<p>教师数自定义函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def get_teacher_nums:</span><br><span class="line">    return self.teacher_set.all().count</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>不用自定义函数的方法如下</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-58fe976a62992781.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<h3 id="课程是否相关"><a href="#课程是否相关" class="headerlink" title="课程是否相关"></a>课程是否相关</h3><p>定义课程的tag ，如果tag相同，那么是相关课程。</p>
<p>courses/models.py:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tag &#x3D; models.CharField(max_length&#x3D;15, verbose_name&#x3D;u&quot;课程标签&quot;, default&#x3D;u&quot;&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>更改数据库后必然。此处略。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tag &#x3D; course.tag</span><br><span class="line">       if tag:</span><br><span class="line">       # 需要从1开始不然会推荐自己</span><br><span class="line">           relate_courses &#x3D; Course.objects.filter(tag&#x3D;tag)[1:2]</span><br><span class="line">       else:</span><br><span class="line">           relate_courses &#x3D; []</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>return render加上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;relate_courses&quot;:relate_courses,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="收藏功能"><a href="#收藏功能" class="headerlink" title="收藏功能:"></a>收藏功能:</h3><p>将block js写到页面底部。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">&#x2F;&#x2F;收藏分享</span><br><span class="line">function add_fav(current_elem, fav_id, fav_type)&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        cache: false,</span><br><span class="line">        type: &quot;POST&quot;,</span><br><span class="line">        url:&quot;&#123;% url &quot;org:add_fav&quot; %&#125;&quot;,</span><br><span class="line">        data:&#123;&#39;fav_id&#39;:fav_id, &#39;fav_type&#39;:fav_type&#125;,</span><br><span class="line">        async: true,</span><br><span class="line">        beforeSend:function(xhr, settings)&#123;</span><br><span class="line">            xhr.setRequestHeader(&quot;X-CSRFToken&quot;, &quot;&#123;&#123; csrf_token &#125;&#125;&quot;);</span><br><span class="line">        &#125;,</span><br><span class="line">        success: function(data) &#123;</span><br><span class="line">            if(data.status &#x3D;&#x3D; &#39;fail&#39;)&#123;</span><br><span class="line">                if(data.msg &#x3D;&#x3D; &#39;用户未登录&#39;)&#123;</span><br><span class="line">                    window.location.href&#x3D;&quot;&#x2F;login&#x2F;&quot;;</span><br><span class="line">                &#125;else&#123;</span><br><span class="line">                    alert(data.msg)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;else if(data.status &#x3D;&#x3D; &#39;success&#39;)&#123;</span><br><span class="line">                current_elem.text(data.msg)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(&#39;#jsLeftBtn&#39;).on(&#39;click&#39;, function()&#123;</span><br><span class="line">    add_fav($(this), &#123;&#123; course.id &#125;&#125;, 1);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$(&#39;#jsRightBtn&#39;).on(&#39;click&#39;, function()&#123;</span><br><span class="line">    add_fav($(this), &#123;&#123; course.course_org.id &#125;&#125;, 2);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>刷新后又不见了的问题，从view中传递has_fav的参数。前台进行判断。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 是否收藏课程</span><br><span class="line">      has_fav_course &#x3D; False</span><br><span class="line">      has_fav_org &#x3D; False</span><br><span class="line"></span><br><span class="line">      # 必须是用户已登录我们才需要判断。</span><br><span class="line">      if request.user.is_authenticated:</span><br><span class="line">          if UserFavorite.objects.filter(user&#x3D;request.user, fav_id&#x3D;course.id, fav_type&#x3D;1):</span><br><span class="line">              has_fav_course &#x3D; True</span><br><span class="line">          if UserFavorite.objects.filter(user&#x3D;request.user, fav_id&#x3D;course.course_org.id, fav_type&#x3D;2):</span><br><span class="line">              has_fav_org &#x3D; True</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>return render</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;has_fav_course&quot;:has_fav_course,</span><br><span class="line">&quot;has_fav_org&quot;:has_fav_org,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>html中使用；</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-16c181b9f582096d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/451" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-2f230e15debb69bd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/391" alt="img"></p>
<h2 id="课程章节信息"><a href="#课程章节信息" class="headerlink" title="课程章节信息"></a>课程章节信息</h2><p>章节信息，评论信息。</p>
<p>course comments 和 course video放入 template</p>
<p>它也有head和foot继承我们的base页面</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-1588d6c27ba74039.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p>配置相应的url:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 处理课程章节信息页面的view</span><br><span class="line"></span><br><span class="line">class CourseInfoView(View):</span><br><span class="line">    def get(self, request, course_id):</span><br><span class="line">        # 此处的id为表默认为我们添加的值。</span><br><span class="line">        course &#x3D; Course.objects.get(id&#x3D;int(course_id))</span><br><span class="line">        # 是否收藏课程</span><br><span class="line">        return render(request, &quot;course-video.html&quot;, &#123;</span><br><span class="line">            &quot;course&quot;: course,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 课程章节信息页</span><br><span class="line">url(r&#39;^info&#x2F;(?P&lt;course_id&gt;\d+)&#x2F;$&#39;, CourseInfoView.as_view(), name&#x3D;&quot;course_info&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>用户点击开始学习链接修改</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-d34dbb985ee59d1f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/688" alt="img"></p>
<p>为课程添加章节以及视频。</p>
<h2 id="章节视频信息"><a href="#章节视频信息" class="headerlink" title="章节视频信息"></a>章节视频信息</h2><p>为video表添加视频对应的url信息。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url &#x3D; models.CharField(max_length&#x3D;200, default&#x3D;&quot;http:&#x2F;&#x2F;blog.mtianyan.cn&#x2F;&quot; ,verbose_name&#x3D;u&quot;访问地址&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将章节信息填充进页面</p>
<p>通过课程可以找到章节:course.lesson_set</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-f4da10e0b50885e7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/412" alt="img"></p>
<p>video的时长添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 使用分钟做后台记录(存储最小单位)前台转换</span><br><span class="line">   learn_times &#x3D; models.IntegerField(default&#x3D;0, verbose_name&#x3D;u&quot;学习时长(分钟数)&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>资源下载功能:</p>
<p>后台自行上传点文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">all_resources &#x3D; CourseResource.objects.filter(course&#x3D;course)</span><br><span class="line"></span><br><span class="line">          &quot;all_resources&quot;:all_resources,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或者前端直接:</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-8d93aa48922aed99.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p>创建课程与讲师之间的外键关联</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">teacher &#x3D; models.ForeignKey(Teacher,verbose_name&#x3D;u&quot;讲师&quot;, null&#x3D;True, blank&#x3D;True)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>前往课程，设置讲师。</p>
<p><strong>注意:不要在Unicode方法里使用外键字段很容易报错。</strong></p>
<p>增加课程需知字段和老师告诉你学什么？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">you_need_know &#x3D; models.CharField(max_length&#x3D;300, default&#x3D;u&quot;一颗勤学的心是本课程必要前提&quot;,verbose_name&#x3D;u&quot;课程须知&quot;)</span><br><span class="line">  teacher_tell &#x3D; models.CharField(max_length&#x3D;300, default&#x3D;u&quot;按时交作业,不然叫家长&quot;,verbose_name&#x3D;u&quot;老师告诉你&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将这两个字段显示到页面。</p>
<h2 id="课程评论页面"><a href="#课程评论页面" class="headerlink" title="课程评论页面"></a>课程评论页面</h2><p>配置课程评论的url和view</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class CommentsView(View):</span><br><span class="line">    def get(self, request, course_id):</span><br><span class="line">        # 此处的id为表默认为我们添加的值。</span><br><span class="line">        course &#x3D; Course.objects.get(id&#x3D;int(course_id))</span><br><span class="line">        all_resources &#x3D; CourseResource.objects.filter(course&#x3D;course)</span><br><span class="line">        return render(request, &quot;course-comment.html&quot;, &#123;</span><br><span class="line">            &quot;course&quot;: course,</span><br><span class="line">            &quot;all_resources&quot;: all_resources,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 课程章节信息页</span><br><span class="line">    re_path(&#39;comments&#x2F;(?P&lt;course_id&gt;\d+)&#x2F;&#39;, CommentsView.as_view(), name&#x3D;&quot;course_comments&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>course video中跳转到评论链接</p>
<p>发表评论功能</p>
<p>ajax操作。如果发布成功就会刷新页面。</p>
<p>新建view用于添加评论:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># ajax方式添加评论</span><br><span class="line">class AddCommentsView(View):</span><br><span class="line">    def post(self, request):</span><br><span class="line">        if not request.user.is_authenticated:</span><br><span class="line">            # 未登录时返回json提示未登录，跳转到登录页面是在ajax中做的</span><br><span class="line">            return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;:&quot;用户未登录&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line">        course_id &#x3D; request.POST.get(&quot;course_id&quot;, 0)</span><br><span class="line">        comments &#x3D; request.POST.get(&quot;comments&quot;, &quot;&quot;)</span><br><span class="line">        if int(course_id) &gt; 0 and comments:</span><br><span class="line">            course_comments &#x3D; CourseComments()</span><br><span class="line">            # get只能取出一条数据，如果有多条抛出异常。没有数据也抛异常</span><br><span class="line">            # filter取一个列表出来，queryset。没有数据返回空的queryset不会抛异常</span><br><span class="line">            course &#x3D; Course.objects.get(id &#x3D; int(course_id))</span><br><span class="line">            # 外键存入要存入对象</span><br><span class="line">            course_comments.course &#x3D; course</span><br><span class="line">            course_comments.comments &#x3D; comments</span><br><span class="line">            course_comments.user &#x3D; request.user</span><br><span class="line">            course_comments.save()</span><br><span class="line">            return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;success&quot;, &quot;msg&quot;:&quot;评论成功&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line">        else:</span><br><span class="line">            return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;:&quot;评论失败&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加配套的url:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 添加课程评论,已经把参数放到post当中了</span><br><span class="line">path(&#39;add_comment&#x2F;&#39;, AddCommentsView.as_view(), name&#x3D;&quot;add_comment&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>js代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type&#x3D;&quot;text&#x2F;javascript&quot;&gt;</span><br><span class="line">    &#x2F;&#x2F;添加评论</span><br><span class="line">    $(&#39;#js-pl-submit&#39;).on(&#39;click&#39;, function()&#123;</span><br><span class="line">        var comments &#x3D; $(&quot;#js-pl-textarea&quot;).val()</span><br><span class="line">        if(comments &#x3D;&#x3D; &quot;&quot;)&#123;</span><br><span class="line">            alert(&quot;评论不能为空&quot;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            cache: false,</span><br><span class="line">            type: &quot;POST&quot;,</span><br><span class="line">            url:&quot;&#123;% url &#39;course:add_comment&#39; %&#125;&quot;,</span><br><span class="line">            data:&#123;&#39;course_id&#39;:&#123;&#123; course.id &#125;&#125;, &#39;comments&#39;:comments&#125;,</span><br><span class="line">            async: true,</span><br><span class="line">            beforeSend:function(xhr, settings)&#123;</span><br><span class="line">                xhr.setRequestHeader(&quot;X-CSRFToken&quot;, &quot;&#123;&#123; csrf_token &#125;&#125;&quot;);</span><br><span class="line">            &#125;,</span><br><span class="line">            success: function(data) &#123;</span><br><span class="line">                if(data.status &#x3D;&#x3D; &#39;fail&#39;)&#123;</span><br><span class="line">                    if(data.msg &#x3D;&#x3D; &#39;用户未登录&#39;)&#123;</span><br><span class="line">                        window.location.href&#x3D;&quot;&#x2F;login&#x2F;&quot;;</span><br><span class="line">                    &#125;else&#123;</span><br><span class="line">                        alert(data.msg)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;else if(data.status &#x3D;&#x3D; &#39;success&#39;)&#123;</span><br><span class="line">                    window.location.reload();&#x2F;&#x2F;刷新当前页面.</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>后端已经将all_comments传过来了。然后for循环输出。</p>
<h2 id="相关课程推荐"><a href="#相关课程推荐" class="headerlink" title="相关课程推荐:"></a>相关课程推荐:</h2><blockquote>
<p>学过该课程的还学过</p>
</blockquote>
<p>CourseInfoView</p>
<p>添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 选出学了这门课的学生关系</span><br><span class="line">        user_courses &#x3D; UserCourse.objects.filter(course&#x3D; course)</span><br><span class="line">        # 从关系中取出user_id</span><br><span class="line">        user_ids &#x3D; [user_course.user_id for user_course in user_courses]</span><br><span class="line">        # 这些用户学了的课程,外键会自动有id，取到字段</span><br><span class="line">        all_user_courses &#x3D; UserCourse.objects.filter(user_id__in&#x3D;user_ids)</span><br><span class="line">        # 取出所有课程id</span><br><span class="line">        course_ids &#x3D; [all_user_course.course_id for all_user_course in all_user_courses]</span><br><span class="line">        # 获取学过该课程用户学过的其他课程</span><br><span class="line">        relate_courses &#x3D; Course.objects.filter(id__in&#x3D;course_ids).order_by(&quot;-click_nums&quot;)[:5]</span><br><span class="line">        # 是否收藏课程</span><br><span class="line">        return render(request, &quot;course-video.html&quot;, &#123;</span><br><span class="line">            &quot;course&quot;: course,</span><br><span class="line">            &quot;all_resources&quot;: all_resources,</span><br><span class="line">            &quot;relate_courses&quot;:relate_courses,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>重点: 两个下划线代表我传进来的是一个list，你进行遍历。</p>
</blockquote>
<p>comments也做同样处理</p>
<p>用户未登录，不要让他能点进view</p>
<p>如果使用的是方法型编程可以使用装饰器<code>loginrequired</code></p>
<p>而我们使用的是类。所以要继承。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from django.contrib.auth.mixins import LoginRequiredMixin</span><br><span class="line">class CourseInfoView(LoginRequiredMixin, View):</span><br><span class="line">    login_url &#x3D; &#39;&#x2F;login&#x2F;&#39;</span><br><span class="line">    redirect_field_name &#x3D; &#39;redirect_to&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="课程播放页面"><a href="#课程播放页面" class="headerlink" title="课程播放页面"></a>课程播放页面</h2><p>将视频播放页面拷贝到template目录</p>
<p>使用开源库video js</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-9ea5479f0e8165a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/141" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-7743fd38993082ec.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/125" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-b9607b955ad7075c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/520" alt="img"></p>
<p>添加访问的url和view；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 课程视频播放页</span><br><span class="line">url(r&#39;^video&#x2F;(?P&lt;video_id&gt;\d+)&#x2F;$&#39;, VideoPlayView.as_view(), name&#x3D;&quot;video_play&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 播放视频的view</span><br><span class="line">class VideoPlayView(LoginRequiredMixin, View):</span><br><span class="line">    login_url &#x3D; &#39;&#x2F;login&#x2F;&#39;</span><br><span class="line">    redirect_field_name &#x3D; &#39;next&#39;</span><br><span class="line">    def get(self, request, video_id):</span><br><span class="line">        # 此处的id为表默认为我们添加的值。</span><br><span class="line">        video &#x3D; Video.objects.get(id&#x3D;int(video_id))</span><br><span class="line">        # 找到对应的course</span><br><span class="line">        course &#x3D; video.lesson.course</span><br><span class="line">        # 查询用户是否开始学习了该课，如果还未学习则，加入用户课程表</span><br><span class="line">        user_courses &#x3D; UserCourse.objects.filter(user&#x3D;request.user, course&#x3D;course)</span><br><span class="line">        if not user_courses:</span><br><span class="line">            user_course &#x3D; UserCourse(user&#x3D;request.user, course&#x3D;course)</span><br><span class="line">            user_course.save()</span><br><span class="line">        # 查询课程资源</span><br><span class="line">        all_resources &#x3D; CourseResource.objects.filter(course&#x3D;course)</span><br><span class="line">        # 选出学了这门课的学生关系</span><br><span class="line">        user_courses &#x3D; UserCourse.objects.filter(course&#x3D;course)</span><br><span class="line">        # 从关系中取出user_id</span><br><span class="line">        user_ids &#x3D; [user_course.user_id for user_course in user_courses]</span><br><span class="line">        # 这些用户学了的课程,外键会自动有id，取到字段</span><br><span class="line">        all_user_courses &#x3D; UserCourse.objects.filter(user_id__in&#x3D;user_ids)</span><br><span class="line">        # 取出所有课程id</span><br><span class="line">        course_ids &#x3D; [user_course.course_id for user_course in all_user_courses]</span><br><span class="line">        # 获取学过该课程用户学过的其他课程</span><br><span class="line">        relate_courses &#x3D; Course.objects.filter(id__in&#x3D;course_ids).order_by(&quot;-click_nums&quot;).exclude(id&#x3D;course.id)[:4]</span><br><span class="line">        # 是否收藏课程</span><br><span class="line">        return render(request, &quot;course-play.html&quot;, &#123;</span><br><span class="line">            &quot;course&quot;: course,</span><br><span class="line">            &quot;all_resources&quot;: all_resources,</span><br><span class="line">            &quot;relate_courses&quot;: relate_courses,</span><br><span class="line">            &quot;video&quot;: video,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>title 与面包屑的修改</p>
<h1 id="讲师相关功能实现"><a href="#讲师相关功能实现" class="headerlink" title="讲师相关功能实现"></a><center>讲师相关功能实现</center></h1><h2 id="讲师列表页"><a href="#讲师列表页" class="headerlink" title="讲师列表页"></a>讲师列表页</h2><p>teacherlist 和 teacher detail 一起放到template目录之下</p>
<p>继承base页面</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-e5db223afd96b52f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/306" alt="img"></p>
<h3 id="书写view与配置url"><a href="#书写view与配置url" class="headerlink" title="书写view与配置url"></a>书写view与配置url</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 讲师列表</span><br><span class="line">path(&#39;teacher_list&#x2F;&#39;, TeacherListView.as_view(), name&#x3D;&quot;teacher_list&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加讲师的年龄字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">age &#x3D; models.IntegerField(default&#x3D;18, verbose_name&#x3D;u&quot;年龄&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="分页仿照orglist-注意object-list"><a href="#分页仿照orglist-注意object-list" class="headerlink" title="分页仿照orglist 注意object_list"></a>分页仿照orglist 注意object_list</h3><p>view</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 课程讲师列表页</span><br><span class="line">class TeacherListView(View):</span><br><span class="line">        def get(self, request):</span><br><span class="line">            all_teacher &#x3D; Teacher.objects.all()</span><br><span class="line">            # 总共有多少老师使用count进行统计</span><br><span class="line">            teacher_nums &#x3D; all_teacher.count()</span><br><span class="line">            # 对讲师进行分页</span><br><span class="line">            # 尝试获取前台get请求传递过来的page参数</span><br><span class="line">            # 如果是不合法的配置参数默认返回第一页</span><br><span class="line">            try:</span><br><span class="line">                page &#x3D; request.GET.get(&#39;page&#39;, 1)</span><br><span class="line">            except PageNotAnInteger:</span><br><span class="line">                page &#x3D; 1</span><br><span class="line">            # 这里指从allorg中取五个出来，每页显示5个</span><br><span class="line">            p &#x3D; Paginator(all_teacher, 4, request&#x3D;request)</span><br><span class="line">            teachers &#x3D; p.page(page)</span><br><span class="line">            return render(request, &quot;teachers-list.html&quot;, &#123;</span><br><span class="line">            &quot;all_teacher&quot;:teachers,</span><br><span class="line">            &quot;teacher_nums&quot;:teacher_nums</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="排序-amp-讲师排行榜"><a href="#排序-amp-讲师排行榜" class="headerlink" title="排序 &amp; 讲师排行榜"></a>排序 &amp; 讲师排行榜</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sort &#x3D; request.GET.get(&quot;sort&quot;, &quot;&quot;)</span><br><span class="line">           if sort:</span><br><span class="line">               if sort &#x3D;&#x3D; &quot;hot&quot;:</span><br><span class="line">                   all_teacher &#x3D; all_teacher.order_by(&quot;-click_nums&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;sort&quot;:sort</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将sort return到前端。实现active</p>
<p>排行榜讲师</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 排行榜讲师</span><br><span class="line">rank_teacher &#x3D; Teacher.objects.all().order_by(&quot;-fav_nums&quot;)[:5]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-bd7a8603f7da3e4f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/475" alt="img"></p>
<p>forloop.count 取出当前是第几次循环</p>
<h2 id="讲师详情页"><a href="#讲师详情页" class="headerlink" title="讲师详情页"></a>讲师详情页</h2><p><img src="https://upload-images.jianshu.io/upload_images/1779926-45db0547327267a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/285" alt="img"></p>
<p>mark</p>
<h3 id="配置url和view"><a href="#配置url和view" class="headerlink" title="配置url和view"></a>配置url和view</h3><p>列表页中配置入口</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># 教师详情页面</span><br><span class="line"></span><br><span class="line">class TeacherDetailView(View):</span><br><span class="line">    def get(self, request, teacher_id):</span><br><span class="line">        teacher &#x3D; Teacher.objects.get(id &#x3D; int(teacher_id))</span><br><span class="line">        all_course &#x3D; teacher.course_set.all()</span><br><span class="line">        # 排行榜讲师</span><br><span class="line">        rank_teacher &#x3D; Teacher.objects.all().order_by(&quot;-fav_nums&quot;)[:5]</span><br><span class="line"></span><br><span class="line">        has_fav_teacher &#x3D; False</span><br><span class="line">        if UserFavorite.objects.filter(user&#x3D;request.user, fav_type&#x3D;3, fav_id&#x3D; teacher.id):</span><br><span class="line">            has_fav_teacher &#x3D; True</span><br><span class="line">        has_fav_org &#x3D; False</span><br><span class="line">        if  UserFavorite.objects.filter(user&#x3D;request.user, fav_type&#x3D;2, fav_id&#x3D; teacher.org.id):</span><br><span class="line">            has_fav_org &#x3D; True</span><br><span class="line">        return render(request, &quot;teacher-detail.html&quot;, &#123;</span><br><span class="line">            &quot;teacher&quot;:teacher,</span><br><span class="line">            &quot;all_course&quot;:all_course,</span><br><span class="line">            &quot;rank_teacher&quot;:rank_teacher,</span><br><span class="line">            &quot;has_fav_teacher&quot;:has_fav_teacher,</span><br><span class="line">            &quot;has_fav_org&quot;:has_fav_org,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # 访问机构讲师</span><br><span class="line">    re_path(&#39;teacher&#x2F;detail&#x2F;(?P&lt;teacher_id&gt;\d+)&#x2F;&#39;, TeacherDetailView.as_view(), name&#x3D;&quot;teacher_detail&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="全局导航-amp-个人中心-amp-全局搜索"><a href="#全局导航-amp-个人中心-amp-全局搜索" class="headerlink" title="全局导航&amp;个人中心&amp;全局搜索"></a><center>全局导航&amp;个人中心&amp;全局搜索</center></h1><h2 id="配置全局导航"><a href="#配置全局导航" class="headerlink" title="配置全局导航"></a>配置全局导航</h2><p>让index页面也继承base页面</p>
<p>base页面的导航栏配置</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-aecfdab8c06909fa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/599" alt="img"></p>
<p>但是现在我们不知道当前是哪一个页面，因为后端没有传值过来</p>
<p>后台的每个view中添加current nav字段。然后向上传递到base页面</p>
<p>为了满足前台有current view的值，我们写的每个view都得加上这个字段。</p>
<p>小技巧：根据request的地址中的前几位来判断在哪一个区域之下</p>
<p>request.path</p>
<p>修改url中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 访问机构讲师</span><br><span class="line">url(r&#39;^org_teacher&#x2F;(?P&lt;org_id&gt;\d+)&#x2F;$&#39;, OrgTeacherView.as_view(), name&#x3D;&quot;org_teacher&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-ad1b338cfe2ef8b7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/500" alt="img"></p>
<h2 id="全局搜索功能开发"><a href="#全局搜索功能开发" class="headerlink" title="全局搜索功能开发"></a>全局搜索功能开发</h2><p>搜索跳到列表展示</p>
<p>courselist后加参数keywords</p>
<p>搜索的代码放在deco-common js中</p>
<p>课程的搜索功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 搜索功能</span><br><span class="line">search_keywords &#x3D; request.GET.get(&#39;keywords&#39;,&#39;&#39;)</span><br><span class="line">if search_keywords:</span><br><span class="line">    # 在name字段进行操作,做like语句的操作。i代表不区分大小写</span><br><span class="line">    # or操作使用Q</span><br><span class="line">    all_course &#x3D; all_course.filter(Q(name__icontains&#x3D;search_keywords)|Q(desc__icontains&#x3D;search_keywords)|Q(detail__icontains&#x3D;search_keywords))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;search_keywords&quot;:search_keywords,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="个人中心信息展示"><a href="#个人中心信息展示" class="headerlink" title="个人中心信息展示"></a>个人中心信息展示</h2><p>将用户中心相关的六个页面，全部拷贝进template</p>
<p>新建usercenter base页面</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-224ecf2256279c96.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<p>配置url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># user app的url配置</span><br><span class="line">url(r&quot;^users&#x2F;&quot;, include(&#39;users.urls&#39;, namespace&#x3D;&quot;users&quot;)),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># encoding: utf-8</span><br><span class="line">from .views import UserInfoView</span><br><span class="line"></span><br><span class="line">from django.conf.urls import url</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    # 用户信息</span><br><span class="line">    url(r&#39;^info&#x2F;$&#39;, UserInfoView.as_view(), name&#x3D;&quot;user_info&quot;),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 用户个人信息view</span><br><span class="line">class UserInfoView(LoginRequiredMixin,View):</span><br><span class="line">    login_url &#x3D; &#39;&#x2F;login&#x2F;&#39;</span><br><span class="line">    redirect_field_name &#x3D; &#39;next&#39;</span><br><span class="line">    def get(self, request):</span><br><span class="line">        return render(request, &quot;usercenter-info.html&quot;, &#123;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>user app 下新建url</p>
<p>django自带的filter</p>
<p>request.user.mobile|default_if_none:’’</p>
<h2 id="修改密码和修改头像"><a href="#修改密码和修改头像" class="headerlink" title="修改密码和修改头像"></a>修改密码和修改头像</h2><p>新建url 和 view</p>
<p>小技巧:</p>
<blockquote>
<p>django的xadmin和admin当中，实际上是可以对form定义为文件的时候，是可以自动对上传的文件做保存的。<br>使用form的一个字段定义一个文件类型。把字段取出来就是内存中的文件。<br>赋值到user.image 就完成图片的一个存储。</p>
</blockquote>
<p>users/forms.py：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 用于文件上传，修改头像</span><br><span class="line">class UploadImageForm(forms.ModelForm):</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; UserProfile</span><br><span class="line">        fields &#x3D; [&#39;image&#39;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实例化时，传进来是post 和 文件类型的request 存放地址</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-98121b14dfe4925e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/392" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-2b282e75b097eaf8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/340" alt="img"></p>
<p>mark</p>
<p>上传文件时通过一个form完成的。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-9fe3ac2194c79af7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/221" alt="img"></p>
<p>必须指明enctype，才能把文件类型传递到后台</p>
<p>url 和view</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 用户头像上传</span><br><span class="line">url(r&#39;^image&#x2F;upload&#x2F;$&#39;, UploadImageView.as_view(), name&#x3D;&quot;image_upload&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 用户上传图片的view:用于修改头像</span><br><span class="line">class UploadImageView(LoginRequiredMixin, View):</span><br><span class="line">    login_url &#x3D; &#39;&#x2F;login&#x2F;&#39;</span><br><span class="line">    redirect_field_name &#x3D; &#39;next&#39;</span><br><span class="line">    def post(self, request):</span><br><span class="line">        # 这时候用户上传的文件就已经被保存到imageform了</span><br><span class="line">        image_form &#x3D; UploadImageForm(request.POST, request.FILES)</span><br><span class="line">        if image_form.is_valid():</span><br><span class="line">            pass</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-1ea10d80002ec1b3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/507" alt="img"></p>
<p>这里的name必须和form中的一样</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-35c4e451ed148950.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/674" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-74740b8a8c7039c7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/521" alt="img"></p>
<blockquote>
<p>所有验证通过的字段放在cleaned data</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 用户上传图片的view:用于修改头像</span><br><span class="line">class UploadImageView(LoginRequiredMixin, View):</span><br><span class="line">    login_url &#x3D; &#39;&#x2F;login&#x2F;&#39;</span><br><span class="line">    redirect_field_name &#x3D; &#39;next&#39;</span><br><span class="line">    def post(self, request):</span><br><span class="line">        # 这时候用户上传的文件就已经被保存到imageform了 ，为modelform添加instance值直接保存</span><br><span class="line">        image_form &#x3D; UploadImageForm(request.POST, request.FILES, instance&#x3D;request.user)</span><br><span class="line">        if image_form.is_valid():</span><br><span class="line">            image_form.save()</span><br><span class="line">            # # 取出cleaned data中的值,一个dict</span><br><span class="line">            # image &#x3D; image_form.cleaned_data[&#39;image&#39;]</span><br><span class="line">            # request.user.image &#x3D; image</span><br><span class="line">            # request.user.save()</span><br><span class="line">            return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;success&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line">        else:</span><br><span class="line">            return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;fail&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改密码功能:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 在个人中心修改用户密码</span><br><span class="line">class UpdatePwdView(View):</span><br><span class="line">    def post(self, request):</span><br><span class="line">        modiypwd_form &#x3D; ModifyPwdForm(request.POST)</span><br><span class="line">        if modiypwd_form.is_valid():</span><br><span class="line">            pwd1 &#x3D; request.POST.get(&quot;password1&quot;, &quot;&quot;)</span><br><span class="line">            pwd2 &#x3D; request.POST.get(&quot;password2&quot;, &quot;&quot;)</span><br><span class="line">            # 如果两次密码不相等，返回错误信息</span><br><span class="line">            if pwd1 !&#x3D; pwd2:</span><br><span class="line">                return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;:&quot;密码不一致&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line">            # 如果密码一致</span><br><span class="line">            user &#x3D;request.user</span><br><span class="line">            # 加密成密文</span><br><span class="line">            user.password &#x3D; make_password(pwd2)</span><br><span class="line">            # save保存到数据库</span><br><span class="line">            user.save()</span><br><span class="line">            return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;success&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line">        # 验证失败说明密码位数不够。</span><br><span class="line">        else:</span><br><span class="line">            return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;fail&quot;, &quot;msg&quot;:&quot;填写错误请检查&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-91d82f714461fffa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/664" alt="img"></p>
<p>必须与我们的form中定义的一致</p>
<p>实现的js代码在deco-user.js</p>
<p>js文件中的url就一定不能用template的模板语言了</p>
<h2 id="修改邮箱提交form表单"><a href="#修改邮箱提交form表单" class="headerlink" title="修改邮箱提交form表单"></a>修改邮箱提交form表单</h2><p>有两个接口需要完成。点击获取验证码时，后台需要向用户新邮箱发送验证码。<br>邮箱如果出错，会返回错误信息。</p>
<p>输入了邮箱和验证码，验证是否匹配。</p>
<h3 id="获取验证码接口"><a href="#获取验证码接口" class="headerlink" title="获取验证码接口:"></a>获取验证码接口:</h3><p>配置url:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 专用于发送验证码的</span><br><span class="line">url(r&#39;^sendemail_code&#x2F;$&#39;, SendEmailCodeView.as_view(), name&#x3D;&quot;sendemail_code&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新增邮箱验证码model类型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SEND_CHOICES &#x3D; (</span><br><span class="line">        (&quot;register&quot;, u&quot;注册&quot;),</span><br><span class="line">        (&quot;forget&quot;, u&quot;找回密码&quot;),</span><br><span class="line">        (&quot;update_email&quot;, u&quot;修改邮箱&quot;)</span><br><span class="line">    )</span><br><span class="line">           max_length&#x3D;20,</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发送邮箱验证码view</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">class SendEmailCodeView(LoginRequiredMixin, View):</span><br><span class="line">    def get(self,request):</span><br><span class="line">        # 取出需要发送的邮件</span><br><span class="line">        email &#x3D; request.GET.get(&quot;email&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">        # 不能是已注册的邮箱</span><br><span class="line">        if UserProfile.objects.filter(email&#x3D;email):</span><br><span class="line">            return HttpResponse(&#39;&#123;&quot;email&quot;:&quot;邮箱已经存在&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line">        send_register_eamil(email, &quot;update_email&quot;)</span><br><span class="line">        return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;success&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发送邮箱验证码的功能放在deco-user.js中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">elif send_type &#x3D;&#x3D; &quot;update_email&quot;:</span><br><span class="line">    code &#x3D; random_str(4)</span><br><span class="line">    email_title &#x3D; &quot;mtianyan慕课小站 修改邮箱验证码&quot;</span><br><span class="line">    email_body &#x3D; loader.render_to_string(</span><br><span class="line">        &quot;email_update_email.html&quot;,  # 需要渲染的html模板</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;active_code&quot;: code  # 参数</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br><span class="line">    msg &#x3D; EmailMessage(email_title, email_body, EMAIL_FROM, [email])</span><br><span class="line">    msg.content_subtype &#x3D; &quot;html&quot;</span><br><span class="line">    send_status &#x3D; msg.send()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="修改邮箱的view"><a href="#修改邮箱的view" class="headerlink" title="修改邮箱的view"></a>修改邮箱的view</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 修改邮箱的view:</span><br><span class="line">class UpdateEmailView(LoginRequiredMixin, View):</span><br><span class="line">    login_url &#x3D; &#39;&#x2F;login&#x2F;&#39;</span><br><span class="line">    redirect_field_name &#x3D; &#39;next&#39;</span><br><span class="line">    def post(self, request):</span><br><span class="line">        email &#x3D; request.POST.get(&quot;email&quot;, &quot;&quot;)</span><br><span class="line">        code &#x3D; request.POST.get(&quot;code&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">        existed_records &#x3D; EmailVerifyRecord.objects.filter(email&#x3D;email, code&#x3D;code, send_type&#x3D;&#39;update_email&#39;)</span><br><span class="line">        if existed_records:</span><br><span class="line">            user &#x3D; request.user</span><br><span class="line">            user.email &#x3D; email</span><br><span class="line">            user.save()</span><br><span class="line">            return HttpResponse(&#39;&#123;&quot;status&quot;:&quot;success&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line">        else:</span><br><span class="line">            return HttpResponse(&#39;&#123;&quot;email&quot;:&quot;验证码无效&quot;&#125;&#39;, content_type&#x3D;&#39;application&#x2F;json&#39;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改邮箱的url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url(r&#39;^update_email&#x2F;$&#39;, UpdateEmailView.as_view(), name&#x3D;&quot;update_email&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>为userInfo view增加post方法。使用modelform完成直接提交</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def post(self,request):</span><br><span class="line">    # 不像用户咨询是一个新的。需要指明instance。不然无法修改，而是新增用户</span><br><span class="line">    user_info_form &#x3D; UserInfoForm(request.POST, instance&#x3D;request.user)</span><br><span class="line">    if user_info_form.is_valid():</span><br><span class="line">        user_info_form.save()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>user_info_form</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 用于个人中心修改个人信息</span><br><span class="line">class UserInfoForm(forms.ModelForm):</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        model &#x3D; UserProfile</span><br><span class="line">        fields &#x3D; [&#39;nick_name&#39;,&#39;gender&#39;,&#39;birthday&#39;,&#39;address&#39;,&#39;mobile&#39;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-80221e9b67ebdf40.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/581" alt="img"></p>
<p>配置url和view</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 用户中心我的课程</span><br><span class="line">path(&#39;mycourse&#x2F;&#39;, MyCourseView.as_view(), name&#x3D;&quot;mycourse&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>usercenter base中添加链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 个人中心页我的课程</span><br><span class="line"></span><br><span class="line">class MyCourseView(LoginRequiredMixin, View):</span><br><span class="line">    login_url &#x3D; &#39;&#x2F;login&#x2F;&#39;</span><br><span class="line">    redirect_field_name &#x3D; &#39;next&#39;</span><br><span class="line"></span><br><span class="line">    def get(self, request):</span><br><span class="line">        user_courses &#x3D; UserCourse.objects.filter(user&#x3D;request.user)</span><br><span class="line">        return render(request, &quot;usercenter-mycourse.html&quot;, &#123;</span><br><span class="line">            &quot;user_courses&quot;:user_courses,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-4974e972f6b69fcd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/608" alt="img"></p>
<h3 id="配置url和view-1"><a href="#配置url和view-1" class="headerlink" title="配置url和view"></a>配置url和view</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 我收藏的课程机构</span><br><span class="line">path(&#39;myfav&#x2F;org&#x2F;&#39;, MyFavOrgView.as_view(), name&#x3D;&quot;myfav_org&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class MyFavOrgView(LoginRequiredMixin, View):</span><br><span class="line">    login_url &#x3D; &#39;&#x2F;login&#x2F;&#39;</span><br><span class="line">    redirect_field_name &#x3D; &#39;next&#39;</span><br><span class="line"></span><br><span class="line">    def get(self, request):</span><br><span class="line">        org_list &#x3D; []</span><br><span class="line">        fav_orgs&#x3D; UserFavorite.objects.filter(user&#x3D;request.user, fav_type&#x3D;2)</span><br><span class="line">        # 上面的fav_orgs只是存放了id。我们还需要通过id找到机构对象</span><br><span class="line">        for fav_org in fav_orgs:</span><br><span class="line">            # 取出fav_id也就是机构的id。</span><br><span class="line">            org_id &#x3D; fav_org.fav_id</span><br><span class="line">            # 获取这个机构对象</span><br><span class="line">            org &#x3D; CourseOrg.objects.get(id&#x3D;org_id)</span><br><span class="line">            org_list.append(org)</span><br><span class="line">        return render(request, &quot;usercenter-fav-org.html&quot;, &#123;</span><br><span class="line">            &quot;org_list&quot;: org_list,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 我收藏的授课讲师</span><br><span class="line"></span><br><span class="line">class MyFavTeacherView(LoginRequiredMixin, View):</span><br><span class="line">    login_url &#x3D; &#39;&#x2F;login&#x2F;&#39;</span><br><span class="line">    redirect_field_name &#x3D; &#39;next&#39;</span><br><span class="line"></span><br><span class="line">    def get(self, request):</span><br><span class="line">        teacher_list &#x3D; []</span><br><span class="line">        fav_teachers&#x3D; UserFavorite.objects.filter(user&#x3D;request.user, fav_type&#x3D;3)</span><br><span class="line">        # 上面的fav_orgs只是存放了id。我们还需要通过id找到机构对象</span><br><span class="line">        for fav_teacher in fav_teachers:</span><br><span class="line">            # 取出fav_id也就是机构的id。</span><br><span class="line">            teacher_id &#x3D; fav_teacher.fav_id</span><br><span class="line">            # 获取这个机构对象</span><br><span class="line">            teacher &#x3D; Teacher.objects.get(id&#x3D;teacher_id)</span><br><span class="line">            teacher_list.append(teacher)</span><br><span class="line">        return render(request, &quot;usercenter-fav-teacher.html&quot;, &#123;</span><br><span class="line">            &quot;teacher_list&quot;: teacher_list,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>url</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 我收藏的课程机构</span><br><span class="line">path(&#39;myfav&#x2F;org&#x2F;&#39;, MyFavOrgView.as_view(), name&#x3D;&quot;myfav_org&quot;),</span><br><span class="line"></span><br><span class="line"># 我收藏的授课讲师</span><br><span class="line">path(&#39;myfav&#x2F;teacher&#x2F;&#39;, MyFavTeacherView.as_view(), name&#x3D;&quot;myfav_teacher&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="配置view和url"><a href="#配置view和url" class="headerlink" title="配置view和url"></a>配置view和url</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 我收藏的课程</span><br><span class="line"></span><br><span class="line">class MyFavCourseView(LoginRequiredMixin, View):</span><br><span class="line">    login_url &#x3D; &#39;&#x2F;login&#x2F;&#39;</span><br><span class="line">    redirect_field_name &#x3D; &#39;next&#39;</span><br><span class="line"></span><br><span class="line">    def get(self, request):</span><br><span class="line">        course_list &#x3D; []</span><br><span class="line">        fav_courses &#x3D; UserFavorite.objects.filter(user&#x3D;request.user, fav_type&#x3D;1)</span><br><span class="line">        # 上面的fav_orgs只是存放了id。我们还需要通过id找到机构对象</span><br><span class="line">        for fav_course in fav_courses:</span><br><span class="line">            # 取出fav_id也就是机构的id。</span><br><span class="line">            course_id &#x3D; fav_course.fav_id</span><br><span class="line">            # 获取这个机构对象</span><br><span class="line">            course &#x3D; Course.objects.get(id&#x3D;course_id)</span><br><span class="line">            course_list.append(course)</span><br><span class="line">        return render(request, &quot;usercenter-fav-course.html&quot;, &#123;</span><br><span class="line">            &quot;course_list&quot;: course_list,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 我收藏的课程</span><br><span class="line">path(&#39;myfav&#x2F;course&#x2F;&#39;, MyFavCourseView.as_view(), name&#x3D;&quot;myfav_course&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="取消收藏"><a href="#取消收藏" class="headerlink" title="取消收藏"></a>取消收藏</h2><p>templates/usercenter-fav-course.html</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-46e2bc9cc88378d9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/634" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-c02313ef5c1c1ad0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/432" alt="img"></p>
<p>取消收藏的代码在base页面中。三个js。</p>
<h2 id="我的消息页面"><a href="#我的消息页面" class="headerlink" title="我的消息页面"></a>我的消息页面</h2><p><img src="https://upload-images.jianshu.io/upload_images/1779926-781dd84189d4a0b2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/700" alt="img"></p>
<h3 id="配置url和view-2"><a href="#配置url和view-2" class="headerlink" title="配置url和view"></a>配置url和view</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 我收藏的课程</span><br><span class="line">path(&#39;my_message&#x2F;&#39;, MyMessageView.as_view(), name&#x3D;&quot;my_message&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 我的消息</span><br><span class="line">class MyMessageView(LoginRequiredMixin, View):</span><br><span class="line">    login_url &#x3D; &#39;&#x2F;login&#x2F;&#39;</span><br><span class="line">    redirect_field_name &#x3D; &#39;next&#39;</span><br><span class="line"></span><br><span class="line">    def get(self, request):</span><br><span class="line">        all_message &#x3D; UserMessage.objects.filter(user&#x3D; request.user.id)</span><br><span class="line">        # 对课程机构进行分页</span><br><span class="line">        # 尝试获取前台get请求传递过来的page参数</span><br><span class="line">        # 如果是不合法的配置参数默认返回第一页</span><br><span class="line">        try:</span><br><span class="line">            page &#x3D; request.GET.get(&#39;page&#39;, 1)</span><br><span class="line">        except PageNotAnInteger:</span><br><span class="line">            page &#x3D; 1</span><br><span class="line">        # 这里指从allorg中取五个出来，每页显示5个</span><br><span class="line">        p &#x3D; Paginator(all_message, 4)</span><br><span class="line">        messages &#x3D; p.page(page)</span><br><span class="line">        return  render(request, &quot;usercenter-message.html&quot;, &#123;</span><br><span class="line">        &quot;messages&quot;:messages,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="注册时发生欢迎消息"><a href="#注册时发生欢迎消息" class="headerlink" title="注册时发生欢迎消息"></a>注册时发生欢迎消息</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 写入欢迎注册消息</span><br><span class="line">           user_message &#x3D; UserMessage()</span><br><span class="line">           user_message.user &#x3D; user_profile.id</span><br><span class="line">           user_message.message &#x3D; &quot;欢迎注册mtianyan慕课小站!!&quot;</span><br><span class="line">           user_message.save()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="页面顶部小喇叭"><a href="#页面顶部小喇叭" class="headerlink" title="页面顶部小喇叭"></a>页面顶部小喇叭</h3><p>所有页面都要读取一个共同的变量：未读消息的数量。我们需要向request中注入这个变量<br>所有页面都有request.user对象。所以我们在userprofile中自定义方法，</p>
<pre><code># 获取用户未读消息的数量
def unread_nums(self):
    from operation.models import UserMessage
    return  UserMessage.objects.filter(user=self.id).count()</code></pre>
<p>#<center> 首页,全局功能细节和404以及500页面配置</center></p>
<h2 id="登出和点击数以及收藏数完善"><a href="#登出和点击数以及收藏数完善" class="headerlink" title="登出和点击数以及收藏数完善"></a>登出和点击数以及收藏数完善</h2><h3 id="退出登录"><a href="#退出登录" class="headerlink" title="退出登录"></a>退出登录</h3><p>Python3+django2.0.1下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class LogoutView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        # django自带的logout</span><br><span class="line">        logout(request)</span><br><span class="line">        # 重定向到首页,</span><br><span class="line">        return HttpResponseRedirect(reverse(&quot;index&quot;))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 退出功能url</span><br><span class="line">path(&#39;logout&#x2F;&#39;, LogoutView.as_view(), name&#x3D;&quot;logout&quot;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="点击数加1"><a href="#点击数加1" class="headerlink" title="点击数加1"></a>点击数加1</h3><p>CourseInfoView学习人数加1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">course.students +&#x3D; 1</span><br><span class="line">course.save()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-069b6b1aeedc7c3d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/435" alt="img"></p>
<p>TeacherDetailView：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">teacher.click_nums +&#x3D;1</span><br><span class="line">teacher.save()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>OrgHomeView</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">course_org.click_nums +&#x3D;1</span><br><span class="line">        course_org.save()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>收藏数统计</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">exist_records.delete()</span><br><span class="line">if int(type) &#x3D;&#x3D; 1:</span><br><span class="line">    course &#x3D; Course.objects.get(id&#x3D;int(id))</span><br><span class="line">    course.fav_nums -&#x3D;1</span><br><span class="line">    if course.fav_nums &lt; 0:</span><br><span class="line">        course.fav_nums &#x3D; 0</span><br><span class="line">    course.save()</span><br><span class="line">elif int(type) &#x3D;&#x3D; 2:</span><br><span class="line">    org &#x3D; CourseOrg.objects.get(id&#x3D;int(id))</span><br><span class="line">    org.fav_nums -&#x3D; 1</span><br><span class="line">    if org.fav_nums &lt; 0:</span><br><span class="line">        org.fav_nums &#x3D; 0</span><br><span class="line">    org.save()</span><br><span class="line">elif int(type) &#x3D;&#x3D; 3:</span><br><span class="line">    teacher &#x3D; Teacher.objects.get(id&#x3D;int(id))</span><br><span class="line">    teacher.fav_nums -&#x3D;1</span><br><span class="line">    if teacher.fav_nums &lt; 0:</span><br><span class="line">        teacher.fav_nums &#x3D; 0</span><br><span class="line">    teacher.save()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">user_fav.save()</span><br><span class="line"></span><br><span class="line">               if int(type) &#x3D;&#x3D; 1:</span><br><span class="line">                   course &#x3D; Course.objects.get(id&#x3D;int(id))</span><br><span class="line">                   course.fav_nums +&#x3D; 1</span><br><span class="line">                   course.save()</span><br><span class="line">               elif int(type) &#x3D;&#x3D; 2:</span><br><span class="line">                   org &#x3D; CourseOrg.objects.get(id&#x3D;int(id))</span><br><span class="line">                   org.fav_nums +&#x3D; 1</span><br><span class="line">                   org.save()</span><br><span class="line">               elif int(type) &#x3D;&#x3D; 3:</span><br><span class="line">                   teacher &#x3D; Teacher.objects.get(id&#x3D;int(id))</span><br><span class="line">                   teacher.fav_nums +&#x3D; 1</span><br><span class="line">                   teacher.save()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意负数的处理：</p>
<p>修改消息已读</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 用户进入个人中心消息页面，清空未读消息记录</span><br><span class="line">all_unread_messages &#x3D; UserMessage.objects.filter(user&#x3D;request.user.id, has_read&#x3D;False)</span><br><span class="line">for unread_message in all_unread_messages:</span><br><span class="line">    unread_message.has_read &#x3D; True</span><br><span class="line">    unread_message.save()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>改进取出未读数字</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">return  UserMessage.objects.filter(has_read&#x3D;False, user&#x3D;self.id).count()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="首页功能开发"><a href="#首页功能开发" class="headerlink" title="首页功能开发"></a>首页功能开发</h2><p>轮播图</p>
<p>公开课</p>
<p>授课机构</p>
<p>新建view</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">## 首页view</span><br><span class="line">class IndexView(View):</span><br><span class="line">    def get(self,request):</span><br><span class="line">        # 取出轮播图</span><br><span class="line">        all_banner &#x3D; Banner.objects.all().order_by(&#39;index&#39;)[:5]</span><br><span class="line">        # 正常位课程</span><br><span class="line">        courses &#x3D; Course.objects.filter(is_banner&#x3D;False)[:6]</span><br><span class="line">        # 轮播图课程取三个</span><br><span class="line">        banner_courses &#x3D; Course.objects.filter(is_banner&#x3D;True)[:3]</span><br><span class="line">        # 课程机构</span><br><span class="line">        course_orgs &#x3D; CourseOrg.objects.all()[:15]</span><br><span class="line">        return render(request, &#39;index.html&#39;, &#123;</span><br><span class="line">            &quot;all_banner&quot;:all_banner,</span><br><span class="line">            &quot;courses&quot;:courses,</span><br><span class="line">            &quot;banner_courses&quot;:banner_courses,</span><br><span class="line">            &quot;course_orgs&quot;:course_orgs,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>为课程添加字段: <code>isbanner</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">is_banner &#x3D; models.BooleanField(default&#x3D;False, verbose_name&#x3D;u&quot;是否轮播&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>url配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path(&#39;&#39;, IndexView.as_view(), name&#x3D;  &quot;index&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-2bae04c6dee76654.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/494" alt="img"></p>
<p>使用django自带模板标签<code>add</code>添加2</p>
<p>为<code>courseOrg</code>添加字段<code>tag</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tag &#x3D; models.CharField(max_length&#x3D;10, default&#x3D; u&quot;国内名校&quot;,verbose_name&#x3D;u&quot;机构标签&quot;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://upload-images.jianshu.io/upload_images/1779926-e5a6eb5e18505a71.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/483" alt="img"></p>
<p>template内建标签被五整除</p>
<h2 id="配置全局404和500"><a href="#配置全局404和500" class="headerlink" title="配置全局404和500"></a>配置全局404和500</h2><p>Mxonline3/urls.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 全局404页面配置</span><br><span class="line">handler404 &#x3D; &#39;users.views.page_not_found&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>users/views.py</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 404对应处理view</span><br><span class="line"></span><br><span class="line">def page_not_found(request):</span><br><span class="line">    from django.shortcuts import  render_to_response</span><br><span class="line">    response &#x3D; render_to_response(&quot;404.html&quot;, &#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">    # 设置response的状态码</span><br><span class="line">    response.status_code &#x3D; 404</span><br><span class="line">    return response</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Debug = True 404是不起作用的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALLOWED_HOSTS &#x3D; [&#39;*&#39;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在debug为false情况下。</p>
<p>我们在访问media的时候配置过用serve来取<br>告诉它访问media的时候去哪个路径下找</p>
<p>debug为True</p>
<p>会自动前往STATICFILES——DIRS取文件的</p>
<p>一旦debug改为false，django就不会代管你的静态文件，</p>
<p>一般静态文件通过第三方http服务器代理转发。</p>
<p>nignx 和 Apache都会自动代理这些静态文件</p>
<p>方法1：我们自己url响应我们的static</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ROOT &#x3D; os.path.join(BASE_DIR, &#39;static&#39;)</span><br></pre></td></tr></table></figure>

<h1 id="常见web攻击及防范"><a href="#常见web攻击及防范" class="headerlink" title="常见web攻击及防范"></a><center>常见web攻击及防范</center></h1><p>sql注入的危害</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-5d766e11de0738fb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/291" alt="img"></p>
<p>对于用户的输入进行合法性判断。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">class LoginUnsafeView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        return render(request, &quot;login.html&quot;, &#123;&#125;)</span><br><span class="line">    def post(self, request):</span><br><span class="line">        user_name &#x3D; request.POST.get(&quot;username&quot;, &quot;&quot;)</span><br><span class="line">        pass_word &#x3D; request.POST.get(&quot;password&quot;, &quot;&quot;)</span><br><span class="line"></span><br><span class="line">        import MySQLdb</span><br><span class="line">        conn &#x3D; MySQLdb.connect(host&#x3D;&#39;127.0.0.1&#39;, user&#x3D;&#39;root&#39;, passwd&#x3D;&#39;root&#39;, db&#x3D;&#39;mxonline&#39;, charset&#x3D;&#39;utf8&#39;)</span><br><span class="line">        cursor &#x3D; conn.cursor()</span><br><span class="line">        sql_select &#x3D; &quot;select * from users_userprofile where email&#x3D;&#39;&#123;0&#125;&#39; and password&#x3D;&#39;&#123;1&#125;&#39;&quot;.format(user_name, pass_word)</span><br><span class="line"></span><br><span class="line">        result &#x3D; cursor.execute(sql_select)</span><br><span class="line">        for row in cursor.fetchall():</span><br><span class="line">            # 查询到用户</span><br><span class="line">            pass</span><br><span class="line">        print &#39;hello&#39;</span><br><span class="line"></span><br><span class="line">urls.py</span><br><span class="line">from users.views import LoginUnsafeView</span><br><span class="line"></span><br><span class="line">urlpatterns &#x3D; [</span><br><span class="line">    url(&#39;^login&#x2F;&#39;, LoginUnsafeView.as_view(), name&#x3D;&#39;login&#39;),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>参数中加入sql语句拼接字符串使之为真。</p>
<p>使用django的orm，它已经对这些做了处理</p>
<h2 id="xss攻击"><a href="#xss攻击" class="headerlink" title="xss攻击"></a>xss攻击</h2><p>xss跨站脚本攻击(Cross Site Scripting)的危害</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-2d013c71d3d2240a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/396" alt="img"></p>
<p>正常流程</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-3654a343edd8dd7e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/413" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-36ab833452623bb5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/299" alt="img"></p>
<p>当传入iPhone6时，这个字符会被显示到页面中。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-015f06294fcbaa4f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/485" alt="img"></p>
<p>将这段代码改成js代码</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-199eed9caa61b751.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/511" alt="img"></p>
<p>黑客拿到你的cookie信息。然后伪装成用户。</p>
<p>Xss攻击防范</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-2cbfc4555ccbfadf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/472" alt="img"></p>
<h2 id="crsf攻击与防护"><a href="#crsf攻击与防护" class="headerlink" title="crsf攻击与防护"></a>crsf攻击与防护</h2><p>crsf跨站请求伪造(Cross-site request forgery)的危害</p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-11a1555439dae316.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/153" alt="img"></p>
<p><img src="https://upload-images.jianshu.io/upload_images/1779926-71fc9e5878285fc3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/489" alt="img"></p>
<p>用户并没有向a请求，而是访问了b。b要求用户访问a的。<br>原因：用户向a的每次请求都会带上session id</p>
<p>图片中插入。</p>
<p>提交form表单必须添加crsf token</p>
<p>攻击网站无法生成crsf token</p>
<h1 id="xadmin的进阶开发"><a href="#xadmin的进阶开发" class="headerlink" title="xadmin的进阶开发"></a><center>xadmin的进阶开发</center></h1><h2 id="static目录问题。"><a href="#static目录问题。" class="headerlink" title="static目录问题。"></a>static目录问题。</h2><p>xadmin的static文件在自己的目录下所以我们找不到</p>
<p>1- url下的static路由配置注释掉<br>2- setting中的StaticRoot注释掉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from xadmin.plugins.auth import UserAdmin</span><br><span class="line"></span><br><span class="line">class UserProfileAdmin(UserAdmin):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">xadmin.site.register(UserProfile,UserProfileAdmin)</span><br><span class="line"></span><br><span class="line">from django.contrib.auth.models import User</span><br><span class="line">xadmin.site.unregister(User)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>点进UserProfileAdmin中可以看官方是怎么实现布局的，我们可以重载</p>
<p>get_form_layout</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">自定义的显示方式</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>get_user_model 获取用户: User =</p>
<p>django权限赋值方式：赋给用户。没一个表的增删改查。</p>
<p>auth_permission 组权限</p>
<h2 id="自定义icon"><a href="#自定义icon" class="headerlink" title="自定义icon"></a>自定义icon</h2><p>model_icon = ‘fa fa-group’</p>
<p>xadmin/static/xadmin/vendor/font-awesome</p>
<p>官网下载然后替换css和font</p>
<h2 id="默认排序"><a href="#默认排序" class="headerlink" title="默认排序"></a>默认排序</h2><p>adminx中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ordering &#x3D; [&#39;-click_nums&#39;]</span><br><span class="line">readonly_fields &#x3D;[&#39;click_nums&#39;,&#39;fav_nums&#39;]</span><br><span class="line">    exclude &#x3D; [&#39;fav_nums&#39;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>两个字段是冲突的。</p>
<h2 id="下拉框搜索："><a href="#下拉框搜索：" class="headerlink" title="下拉框搜索："></a>下拉框搜索：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">relfield_style &#x3D; &#39;fk-ajax&#39;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当有外键指向他，会以ajax方式加载</p>
<p>数据量过大时很有用</p>
<h2 id="inlines添加数据。"><a href="#inlines添加数据。" class="headerlink" title="inlines添加数据。"></a>inlines添加数据。</h2><p>在一个页面直接完成章节。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 课程直接添加章节</span><br><span class="line">class LessonInline(object):</span><br><span class="line">    model &#x3D; Lesson</span><br><span class="line">    extra &#x3D; 0</span><br><span class="line"></span><br><span class="line">        # 课程直接添加章节</span><br><span class="line">    inlines &#x3D; [LessonInline]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>没法完成在章节中再嵌套视频<br>但是可以有多个inline。在添加课程时添加课程资源</p>
<h2 id="一张表分两个model来管理"><a href="#一张表分两个model来管理" class="headerlink" title="一张表分两个model来管理"></a>一张表分两个model来管理</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">class BannerCourse(Course):</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name &#x3D; &quot;轮播课程&quot;</span><br><span class="line">        verbose_name_plural &#x3D; verbose_name</span><br><span class="line">        proxy &#x3D; True</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>设置proxy = true会具有model的功能，但不会生成表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># Course的admin管理器</span><br><span class="line">class BannerCourseAdmin(object):</span><br><span class="line">    list_display &#x3D; [</span><br><span class="line">        &#39;name&#39;,</span><br><span class="line">        &#39;desc&#39;,</span><br><span class="line">        &#39;detail&#39;,</span><br><span class="line">        &#39;degree&#39;,</span><br><span class="line">        &#39;learn_times&#39;,</span><br><span class="line">        &#39;students&#39;]</span><br><span class="line">    search_fields &#x3D; [&#39;name&#39;, &#39;desc&#39;, &#39;detail&#39;, &#39;degree&#39;, &#39;students&#39;]</span><br><span class="line">    list_filter &#x3D; [</span><br><span class="line">        &#39;name&#39;,</span><br><span class="line">        &#39;desc&#39;,</span><br><span class="line">        &#39;detail&#39;,</span><br><span class="line">        &#39;degree&#39;,</span><br><span class="line">        &#39;learn_times&#39;,</span><br><span class="line">        &#39;students&#39;]</span><br><span class="line">    ordering &#x3D; [&#39;-click_nums&#39;]</span><br><span class="line">    readonly_fields &#x3D;[&#39;click_nums&#39;]</span><br><span class="line">    exclude &#x3D; [&#39;fav_nums&#39;]</span><br><span class="line">    # 课程直接添加章节</span><br><span class="line">    inlines &#x3D; [LessonInline,CourseResourceInline]</span><br><span class="line"># 将管理器与model进行注册关联</span><br><span class="line">xadmin.site.register(BannerCourse, BannerCourseAdmin)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>admin中重载queryset方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 过滤列表中的数据</span><br><span class="line">def queryset(self):</span><br><span class="line">    qs &#x3D; super(BannerCourseAdmin, self).queryset()</span><br><span class="line">    qs &#x3D; qs.filter(is_banner&#x3D;True)</span><br><span class="line">    return qs</span><br><span class="line"># 过滤列表中的数据</span><br><span class="line">def queryset(self):</span><br><span class="line">    qs &#x3D; super(CourseAdmin, self).queryset()</span><br><span class="line">    qs &#x3D; qs.filter(is_banner&#x3D;False)</span><br><span class="line">    return qs</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="xamdin其他常见功能："><a href="#xamdin其他常见功能：" class="headerlink" title="xamdin其他常见功能："></a>xamdin其他常见功能：</h2><h3 id="可以在列表上快速修改内容、"><a href="#可以在列表上快速修改内容、" class="headerlink" title="可以在列表上快速修改内容、"></a>可以在列表上快速修改内容、</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">list_editable &#x3D; [ &#39;degree&#39;,&#39;desc&#39;,]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="自定义函数作为列"><a href="#自定义函数作为列" class="headerlink" title="自定义函数作为列"></a>自定义函数作为列</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def get_zj_nums(self):</span><br><span class="line">    return self.lesson_set.all().count()</span><br><span class="line">get_zj_nums.short_description &#x3D; &quot;章节数&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="显示自定义的html代码"><a href="#显示自定义的html代码" class="headerlink" title="显示自定义的html代码"></a>显示自定义的html代码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  def go_to(self):</span><br><span class="line">    from django.utils.safestring import mark_safe</span><br><span class="line">    # 如果不mark safe。会对其进行转义</span><br><span class="line">    return  mark_safe(&quot;&lt;a href&#x3D;&#39;http:&#x2F;&#x2F;blog.mtianyan.cn&#39;&gt;跳转&lt;&#x2F;&gt;&quot;)</span><br><span class="line">go_to.short_description &#x3D; &quot;跳转&quot;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="xadmin的工具-refresh"><a href="#xadmin的工具-refresh" class="headerlink" title="xadmin的工具: refresh"></a>xadmin的工具: refresh</h3><p>xadmin/plugins/refresh.py</p>
<p>列表页定时刷新的工具</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">refresh_times &#x3D; [3,5]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="字段联动"><a href="#字段联动" class="headerlink" title="字段联动"></a>字段联动</h3><p>应用场景: 新增一门课程之后，courseorg的课程数+1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">def save_models(self):</span><br><span class="line">      # 在保存课程的时候统计课程机构的课程数</span><br><span class="line">      # 字段联动</span><br><span class="line">      obj &#x3D; self.new_obj</span><br><span class="line">      # 新增课程还没有保存，统计的课程数少一个</span><br><span class="line">      obj.save()</span><br><span class="line">      # 必须确定存在。</span><br><span class="line">      if obj.course_org is not None:</span><br><span class="line">          # obj实际是一个course对象</span><br><span class="line">          course_org &#x3D; obj.course_org</span><br><span class="line">          course_org.course_nums &#x3D; Course.objects.filter(course_org &#x3D; course_org).count()</span><br><span class="line">          course_org.save()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>不用在课程里面添加章节数。</p>
<h2 id="xadmin自行探究"><a href="#xadmin自行探究" class="headerlink" title="xadmin自行探究"></a>xadmin自行探究</h2><ul>
<li>local 语言包</li>
<li>migration 数据表的记录</li>
<li>plugins 每一个后台页面都是一个plugin 插件机制</li>
<li>static文件。js css</li>
<li>template xadmin自己用到的html文件</li>
<li>对django admin的封装</li>
</ul>
<h3 id="下载源码包"><a href="#下载源码包" class="headerlink" title="下载源码包"></a>下载源码包</h3><p>添加插件使得可以识别ueditor field</p>
<p>记得在init中注册。</p>
<p>关闭自动转义。</p>
<h2 id="导入excel"><a href="#导入excel" class="headerlink" title="导入excel"></a>导入excel</h2><ol>
<li>如何注入导入excel代码到菜单</li>
<li>如何只在课程列表显示</li>
<li>如何接收文件对文件进行处理</li>
</ol>
<p>mark</p>
<p>adminx 文件中的变量覆盖插件内部变量。</p>
<p>只需要重载<code>block_top_toolbar</code>，就会把这个放到页面里面<br>默认使用bootstrap</p>
<p><code>init</code>确定是否启用插件，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def post(self, request, *args , **kwargs):</span><br><span class="line">    if &#39;excel&#39; in request.FILES:</span><br><span class="line">        pass</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>adminx中重写post方法。上传文件会被放在<code>request.FILES</code>中。</p>
<p>中间pass步骤不管做什么事情，都要最后return父类的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return super(CourseAdmin, self).post(request, args, kwargs)</span><br></pre></td></tr></table></figure>

<h1 id="把项目部署上线"><a href="#把项目部署上线" class="headerlink" title="把项目部署上线"></a><center>把项目部署上线</center></h1><p>这个参考这篇文章：<a target="_blank" rel="noopener" href="http://wuliekun.me/2018/05/18/Django%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E5%9C%A8ubuntu%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A/n">http://wuliekun.me/2018/05/18/Django%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E5%9C%A8ubuntu%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A/n</a></p>
</style></li>
	  <div class="article-footer-copyright">

    本博客采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议(CC BY-NC-SA 4.0) 发布.</a>
</div>

	</div>

	
	<span id="/2018/05/09/Django-Xadmin%E5%BC%80%E5%8F%91%E5%9C%A8%E7%BA%BF%E5%AD%A6%E4%B9%A0%E5%B9%B3%E5%8F%B0/" class="leancloud-visitors view" data-flag-title="Django+Xadmin开发在线学习平台">
		<em class="post-meta-item-text"> Page View </em> <i class="leancloud-visitors-count"></i>
	</span>
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2018/05/09/本地项目上传到Github/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2018/05/09/Python开发错误集/" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">留言</h2>

    
</section>

-->
	
		<section id="comments" class="comments">
			<style>
			.comments{margin:30px;padding:10px;background:rgb(0, 0, 0)}
			@media screen and (max-width:800px){.comments{margin:auto;padding:10px;background:#000}}
			</style>
			<div id="vcomment" class="comment"></div>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script src="https://cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
var valineConfig = {"enable":true,"appId":"xx","appKey":"xx","placeholder":"提交评论时留下邮箱收到回复后将自动通知","visitor":true,"avatar":"monsterid","requiredFields":["nick","mail"]}
valineConfig.el='#vcomment';
new Valine(valineConfig);
    // new Valine({
    //     el: '#vcomment',
    //     appId: "",
    //     appKey: "",
    //     placeholder: "提交评论时留下邮箱收到回复后将自动通知",
    //     avatar:"monsterid",
    //     visitor: "true",
    //     requiredFields: "nick,mail".split(','),
    // });
</script>

		</section>
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2018-05-09 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Python/">Python<span>5</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/Django/">Django<span>3</span></a></li> <li><a href="/tags/Xadmin/">Xadmin<span>1</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2020 西伯利亚狼's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
